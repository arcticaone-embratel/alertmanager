AbertoTT,Cidade,Cliente,ClienteId,Estado,Localidade,Servico,Solucao,TipoNegocio,TipoServico,"_key",alert,"alert_close_time","alert_time",app,category,"display_fields","external_reference_id",extras,"falha_datacheck","group_id",host,impact,"incident_id",index,"job_id",metric,"numero_tt_siebel",owner,"preserve_urgency",priority,"result_id",search,siebel,status,subcategory,tags,thresholdSeverityCode,title,ttl,urgency
"Não","","","","","N/A","","","","",616f061480a98715a02db004,"OPEN - GENERAL - V3",0,1634665803,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}","",,20197443,high,,408,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634665980_2692_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,23,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"20197443 - Edge 408 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",616f072ef96ef44b7a11e3be,"OPEN - GENERAL - V3",0,1634666103,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}","",,20197443,medium,,GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666280_2660_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f072ff96ef44b7a11e3c0,"OPEN - GENERAL - V3",0,1634666103,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1184"", ""interface"": ""GE4""}","",,20197443,medium,"81f1691d-1a65-4ec5-be32-c6cf08a59670",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666280_2660_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f098680a98715a02db030,"OPEN - GENERAL - V3",0,1634666403,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}","",,20197443,medium,"a2ea496a-09bd-4370-9245-acdc9509e6fb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666880_2728_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",616f098780a98715a02db032,"OPEN - GENERAL - V3",0,1634666403,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1184"", ""interface"": ""GE4""}","",,20197443,medium,"ceda5f8a-207c-4637-8b1b-58db58b9372b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666880_2728_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",616f63c780a98715a02db273,"OPEN - GENERAL - V3",0,1634689803,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}","",,202187680,high,"132ac232-f1c8-411c-acb5-80eccdef58b7",2081,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634689980_3585_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"202187680 - Edge 2081 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",616f64ee80a98715a02db281,"OPEN - GENERAL - V3",0,1634690103,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}","",,202187680,medium,"1e89c5d9-9073-4de4-b371-23cfa259551d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634690280_3599_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202187680 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f6745f96ef44b7a11e6bf,"OPEN - GENERAL - V3",0,1634690404,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}","",,202187680,medium,"c9e59c47-79a8-4ba5-999b-123676b4b577",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634690880_3575_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202187680 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617081ae80a98715a02db69e,"OPEN - GENERAL - V3",0,1634762704,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,performance,"199fba0d-914b-4402-8592-7b0c116148f3",4487,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634763180_6134_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"",unassigned,,critical,0,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""199fba0d-914b-4402-8592-7b0c116148f3"", ""Descricao"": ""__201749053 --- 2021out21/TESTE 6, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",new,"","",4,"null - A Latência da interface GE3 excedeu o valor de 100",86400,low
,,,,,,,,,,617937f6f96ef44b7a11ffda,title,,1635344934,"alert_manager",unknown,"","",,"","",,low,"91d5954d-d9e5-4132-8d98-3f5db596980c",,bb57e30e74f00d0d9c6976b430cb24f0,,"",unassigned,,"",0,"|noop",,new,unknown,"[Untagged]",,title,3600,low
"Não","","","","","N/A","","","","",617bdd1e1742d7102602ec38,"OPEN - GENERAL - V3",1635738305,1635507005,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","",,202041335,performance,"16d51dfb-6acf-4b7c-800a-14a11c3b4c72",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635507480_30061_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617cf2d81742d7102602efb3,"OPEN - GENERAL - V3",1635942002,1635578406,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}","",,20197432,high,"4e589fa0-45fa-4621-a3f9-eec9d33adca6",410,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635578580_32446_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197432 - Edge 410 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617cf40380a98715a02dd546,"OPEN - GENERAL - V3",1635942002,1635578702,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}","",,20197432,medium,"6c9243e7-cdf2-4469-a344-faba99d01df0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635578880_32631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617cf40480a98715a02dd548,"OPEN - GENERAL - V3",1635942002,1635578702,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}","",,20197432,medium,"ff06c91f-eaeb-4a82-8272-239fba0bf35f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635578880_32631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617cf65b80a98715a02dd554,"OPEN - GENERAL - V3",1635942304,1635579004,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}","",,20197432,medium,"8c4103a9-9c2e-452c-91f2-7ed8ce425c1b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635579480_32658_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617cf65c80a98715a02dd556,"OPEN - GENERAL - V3",1635942304,1635579004,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}","",,20197432,medium,"13da98bf-1e7d-4906-80b4-2cfac2e9ac17",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635579480_32658_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d93631742d7102602f425,"OPEN - GENERAL - V3",1635766803,1635619504,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2196"", ""interface"": ""GE4""}","",,202040660,medium,"8ba31aa9-158a-4bf8-9341-668a92c8cf95",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635619680_33786_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040660 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ea21980a98715a02dd965,"OPEN - GENERAL - V3",1635741004,1635688504,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","",,201912648,performance,"af17a748-b232-490d-89cf-9e8ef36998cf",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635688980_36170_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617f3b9ef96ef44b7a120e6d,"OPEN - GENERAL - V3",1635738004,1635727804,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}","",,202046760,performance,"581d117f-d551-4213-ae42-e7e0b958cb83",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635728280_36793_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617f5ec21742d7102602f77f,"OPEN - GENERAL - V3",1635737703,1635737103,"alert_manager","","",,"{""edgeId"": ""938"", ""linkId"": ""3386"", ""interface"": ""GE3""}","",,202041334,medium,"51ad9318-c2df-440d-aaa2-c0039911d718",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635737280_37684_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041334 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617f80bf1742d7102602f7a5,"OPEN - GENERAL - V3",1635746103,1635745805,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"311f190e-fd42-4252-972d-22b5999e181c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635745980_37974_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617fa3e780a98715a02ddad1,"OPEN - GENERAL - V3",1635755704,1635754803,"alert_manager","","",,"{""edgeId"": ""938"", ""linkId"": ""3386"", ""interface"": ""GE3""}","",,202041334,medium,"3d1bbcd5-84c5-42dd-9b8c-e3c99416b5c0",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635754980_38279_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041334 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617fa9c380a98715a02ddad6,"OPEN - GENERAL - V3",1635768302,1635756002,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}","",,202046760,performance,"8344dcbd-e427-4604-ab25-285b9e5b79cf",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635756480_38329_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617fc0081742d7102602f7e6,"OPEN - GENERAL - V3",1635780306,1635761702,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","",,201912648,performance,"5ead293e-7419-407c-9b03-7b4fc552604f",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635762180_38513_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617fcced1742d7102602f7f8,"OPEN - GENERAL - V3",1635826204,1635765003,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","",,202041335,performance,"702f85c5-90ea-43a9-ad38-5e5e3f279933",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635765480_38622_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617fce1780a98715a02ddaee,"OPEN - GENERAL - V3",1635765904,1635765602,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"2387bfd5-703a-468c-927d-4129c0a3e185",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635765780_38620_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617fcf4380a98715a02ddaf5,"OPEN - GENERAL - V3",1635766203,1635765904,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"3957a9bd-6d55-445c-9709-b8e9eeca6ac2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635766080_38631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617fcf4480a98715a02ddaf7,"OPEN - GENERAL - V3",1635766203,1635765904,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","",,202061983,medium,"46af7fd8-c740-415b-bb59-d8ee95b86cd6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635766080_38631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061983 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617fd522f96ef44b7a120f0c,"OPEN - GENERAL - V3",1635767704,1635767402,"alert_manager","","",,"{""edgeId"": ""959"", ""linkId"": ""1876"", ""interface"": ""GE3""}","",,202040659,high,"1f61194b-f973-44ce-af47-6815157f8f4b",959,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635767580_38067_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040659 - Edge 959 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617fd64bf96ef44b7a120f10,"OPEN - GENERAL - V3",1635768002,1635767704,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"44484caf-2044-4812-8b25-1a01b5b69b6b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635767880_38073_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617fdd52f96ef44b7a120f20,"OPEN - GENERAL - V3",1635769802,1635769504,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""5186"", ""interface"": ""GE3""}","",,202062003,medium,"e4bc0106-73c6-4439-b27c-493e2f816623",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635769680_38134_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062003 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617fe5861742d7102602f801,"OPEN - GENERAL - V3",1635796804,1635771305,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,performance,"08f3f341-7ea9-48c6-b5d6-1b11461659db",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635771780_38827_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617fea36f96ef44b7a120f36,"OPEN - GENERAL - V3",1635773105,1635772804,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","",,202062007,medium,"aaa66a8a-b45c-4f14-ad08-1fad47842589",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635772980_38239_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062007 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617feb6680a98715a02ddb0e,"OPEN - GENERAL - V3",1635773404,1635773105,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","",,202062007,high,"e4f807c8-b87f-49a3-a688-85397f887261",1578,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635773280_38852_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062007 - Edge 1578 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617ff4c21742d7102602f816,"OPEN - GENERAL - V3",1635776103,1635775504,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4165"", ""interface"": ""GE3""}","",,202062007,medium,"0c8968e6-8b9f-45c9-983c-97b3cf7573db",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635775680_38955_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062007 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ff5eff96ef44b7a120f48,"OPEN - GENERAL - V3",1635777002,1635775806,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","",,202062007,medium,"7d0b7389-2ea2-4456-a3b3-986608eb81b3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635775980_38336_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062007 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ff71ff96ef44b7a120f53,"OPEN - GENERAL - V3",1635776402,1635776103,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","",,202062007,high,"addeda79-d296-411c-8341-6f7efe4c00f2",1578,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635776280_38344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062007 - Edge 1578 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617ff721f96ef44b7a120f56,"OPEN - GENERAL - V3",1635776402,1635776103,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}","",,202040643,high,"ed60128a-193d-464e-a798-ec345a829fd9",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635776280_38344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617ffa9ff96ef44b7a120f5f,"OPEN - GENERAL - V3",1635777304,1635777002,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,medium,"69cf6998-1415-4fa3-8fcc-c7c7047d42e7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635777180_38374_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617ffe25f96ef44b7a120f68,"OPEN - GENERAL - V3",1635780306,1635777905,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","",,202062009,high,"9163ee26-e189-4f05-99af-016ff84326e7",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778080_38402_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062009 - Edge 1580 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617ffe27f96ef44b7a120f6b,"OPEN - GENERAL - V3",1635778202,1635777905,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2183"", ""interface"": ""GE3""}","",,202041375,high,"e5b86505-ef87-4c5c-8379-eeb2bb5571f5",992,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778080_38402_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041375 - Edge 992 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617fff4f80a98715a02ddb23,"OPEN - GENERAL - V3",1635780604,1635778202,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","",,202062009,medium,"1fb99687-698a-4498-b75b-933d36f3de9b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778380_39023_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617fff5080a98715a02ddb25,"OPEN - GENERAL - V3",1635780306,1635778202,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}","",,202062009,medium,"3d700c5b-f636-4617-addb-f7a060fd13a4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778380_39023_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617fff5080a98715a02ddb27,"OPEN - GENERAL - V3",1635780306,1635778202,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}","",,202041375,medium,"2706b17b-b9f9-421c-8500-68cad4c6aa27",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778380_39023_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6180007df96ef44b7a120f71,"OPEN - GENERAL - V3",1635779704,1635778502,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","",,202183678,medium,"4c1845e4-9c61-4896-8a9e-043a764febe4",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778680_38422_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618001a61742d7102602f81c,"OPEN - GENERAL - V3",1635780905,1635778502,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","",,202062009,medium,"8fb68690-3bf6-4a3c-aee5-1c0fad644acf",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778980_39059_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618001a71742d7102602f81e,"OPEN - GENERAL - V3",1635780604,1635778502,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}","",,202062009,medium,"3e72097e-1aad-4761-b5aa-720c1ba128df",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778980_39059_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618001a91742d7102602f821,"OPEN - GENERAL - V3",1635779102,1635778805,"alert_manager","","",,"{""edgeId"": ""979"", ""linkId"": ""3181"", ""interface"": ""GE3""}","",,202040627,medium,"b620583c-5fb0-4120-bb34-efdf551b4cc9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778980_39059_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040627 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618001a91742d7102602f823,"OPEN - GENERAL - V3",1635780604,1635778502,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}","",,202041375,medium,"c5b3cbb5-60dc-4d06-9809-e16f0c83cfa7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635778980_39059_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618002d580a98715a02ddb31,"OPEN - GENERAL - V3",1635780004,1635778805,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","",,202183678,medium,"3e0e71e3-d878-48f2-9eed-14eae3e5d595",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635779280_39048_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618002d680a98715a02ddb33,"OPEN - GENERAL - V3",1635779403,1635779102,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"a54c84f3-d002-4fae-8d6e-e8203e4bf424",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635779280_39048_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61800c34f96ef44b7a120f89,"OPEN - GENERAL - V3",1635797704,1635781203,"alert_manager","","",,"{""edgeId"": ""994"", ""linkId"": ""2264"", ""interface"": ""GE3""}","",,202041377,performance,"258fc2cc-a727-4c5d-add3-dc9d4bee3fa1",2264,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635781680_38521_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041377 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61800e891742d7102602f836,"OPEN - GENERAL - V3",1635785705,1635781804,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}","",,202046760,performance,"91aee8b2-a2ec-4bad-8492-56a54f78b7e2",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635782280_39164_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"",unassigned,,critical,0,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",61800fbaf96ef44b7a120f94,"OPEN - GENERAL - V3",1635782705,1635782405,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"ef8ccd75-0dd0-4cf6-bd71-828a46fed7a8",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635782580_38548_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61801dc780a98715a02ddb56,"OPEN - GENERAL - V3",1635786302,1635786009,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,medium,"705ef846-e0b4-4b21-a600-90866dd713db",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635786180_39267_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61801dca80a98715a02ddb5b,"OPEN - GENERAL - V3",1635786302,1635786009,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"e6bdbe6b-be2f-4bb0-ba97-6c4913f78da0",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635786180_39267_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6180214d1742d7102602f857,"OPEN - GENERAL - V3",1635787204,1635786904,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}","",,202040643,high,"eb9a4a16-5146-4397-bfb2-17c7dde2a176",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635787080_39320_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6180227780a98715a02ddb62,"OPEN - GENERAL - V3",1635787504,1635787204,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"5480738d-7903-4285-8108-7c97386b4b1f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635787380_39309_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618030871742d7102602f867,"OPEN - GENERAL - V3",1635791104,1635790802,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","",,202041381,medium,"97c3fc77-b0fc-48a2-8e72-83b3ec3482d9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635790980_39447_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041381 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618039e780a98715a02ddb7c,"OPEN - GENERAL - V3",1635793806,1635793203,"alert_manager","","",,"{""edgeId"": ""994"", ""linkId"": ""2264"", ""interface"": ""GE3""}","",,202041377,medium,"d30d8714-c0a9-4db8-9ac9-832fdbeeddaf",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635793380_39494_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041377 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618040ef80a98715a02ddb8a,"OPEN - GENERAL - V3",1635795303,1635795002,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}","",,202041375,medium,"a6eb427b-d6ab-44ae-a9c4-34d2aa50b703",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635795180_39552_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61804474f96ef44b7a120fd1,"OPEN - GENERAL - V3",1635837905,1635795604,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","",,201912648,performance,"bf3f2abe-1768-4cdb-bbad-6988ca152760",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635796080_38992_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618046cef96ef44b7a120fda,"OPEN - GENERAL - V3",1635796804,1635796503,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}","",,202040665,high,"ca697525-e993-483b-9731-71db49e5de8b",969,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635796680_39009_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040665 - Edge 969 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61804dd380a98715a02ddb9c,"OPEN - GENERAL - V3",1635798603,1635798306,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","",,202183678,medium,"808feb6a-d38f-4eb3-b5b0-8d0ccdcb2f38",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635798480_39656_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618052831742d7102602f892,"OPEN - GENERAL - V3",1635799804,1635799503,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"76df7616-9c90-4cbd-8128-bd0a093755ca",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635799680_39731_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618062eb80a98715a02ddbb9,"OPEN - GENERAL - V3",1635804002,1635803704,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","",,202183678,medium,"b2145f68-b161-47fb-9956-445b597dad94",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635803880_39819_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618062ee80a98715a02ddbbd,"OPEN - GENERAL - V3",1635804002,1635803704,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}","",,202040643,high,"5ff9b4a5-7561-41ed-b71f-2c5e80c584b3",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635803880_39819_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6180654380a98715a02ddbc4,"OPEN - GENERAL - V3",1635805503,1635804303,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}","",,202059973,medium,"a44d530b-0879-4128-8c53-41dccc1de737",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635804480_39846_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059973 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6180654580a98715a02ddbc8,"OPEN - GENERAL - V3",1635805503,1635804303,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}","",,202059973,high,"c08b9946-ed63-4783-8fd1-9f2a6a458412",1264,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635804480_39846_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059973 - Edge 1264 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6180654680a98715a02ddbca,"OPEN - GENERAL - V3",1635804604,1635804303,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}","",,202040643,high,"365da87b-3224-4be0-9295-aa1ce52bf536",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635804480_39846_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6180679a1742d7102602f89a,"OPEN - GENERAL - V3",1635805802,1635804604,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}","",,202059973,medium,"246b8851-27ae-47bd-a107-24e941fe10c9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635805080_39913_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059973 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61806c4b80a98715a02ddbd6,"OPEN - GENERAL - V3",1635806403,1635806106,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","",,202183678,medium,"3c58ded2-987c-4d25-b471-10bfef56c625",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635806280_39899_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6180722980a98715a02ddbe3,"OPEN - GENERAL - V3",1635807902,1635807604,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}","",,201922181,high,"5ef1c60c-8b37-40ee-bbf3-b9e78350b8a2",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635807780_39945_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201922181 - Edge 1105 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61807353f96ef44b7a120ffc,"OPEN - GENERAL - V3",1635808205,1635807902,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"9f433829-779d-457d-851a-70061ef6be12",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635808080_39372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61807b8b80a98715a02ddbeb,"OPEN - GENERAL - V3",1635811803,1635810005,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,high,"2fbacfb3-d448-45e6-9e17-d83acc4845c5",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635810180_40027_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61807b8c80a98715a02ddbed,"OPEN - GENERAL - V3",1635810304,1635810005,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"ffe2034d-0e47-46b0-b4e0-ed1b568552f1",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635810180_40027_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61807cb31742d7102602f8b1,"OPEN - GENERAL - V3",1635812103,1635810304,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,medium,"93d38913-a1ec-4e93-8046-f78fbb201239",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635810480_40088_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61807cb31742d7102602f8b3,"OPEN - GENERAL - V3",1635820803,1635810005,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,performance,"10d1f6de-24e0-4ccf-945d-deda20a4f565",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635810480_40088_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61807f0b80a98715a02ddbf6,"OPEN - GENERAL - V3",1635812406,1635810604,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,medium,"ff76a6a8-c831-464f-a79c-68240c200d95",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635811080_40055_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61807f0c80a98715a02ddbf8,"OPEN - GENERAL - V3",1636220404,1635810902,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5547"", ""interface"": ""GE5""}",,,202191967,medium,"71fb3d62-f1f2-4b7a-b256-b63a3028f902",GE5,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635811080_40055_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202191967 - Link GE5 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61807f1080a98715a02ddbfe,"OPEN - GENERAL - V3",0,1635810902,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5547"", ""interface"": ""GE5""}","Pendência Cliente","",202191967,high,"d5b67fc8-134e-4a9b-8e67-7b25fa68dc31",2152,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635811080_40055_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,987654,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,,"","",1,"202191967 - Edge 2152 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61808164f96ef44b7a121008,"OPEN - GENERAL - V3",1636220703,1635811203,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5547"", ""interface"": ""GE5""}","",,202191967,medium,"f952ac31-0d2d-4294-b076-968c5823035d",GE5,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635811680_39491_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202191967 - Link GE5 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6180899880a98715a02ddc08,"OPEN - GENERAL - V3",1635817204,1635813303,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","",,202061983,performance,"b2f164e2-089f-4cf3-b021-69a52267e913",4133,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635813780_40137_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061983 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61808e461742d7102602f8d5,"OPEN - GENERAL - V3",1635815105,1635814806,"alert_manager","","",,"{""edgeId"": ""1930"", ""linkId"": ""5208"", ""interface"": ""GE4""}","",,202183874,medium,"20f36eb6-2e63-4bd4-b46f-8b3cbdf3ec34",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635814980_40233_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183874 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61808e481742d7102602f8d8,"OPEN - GENERAL - V3",1635815105,1635814806,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"3338277e-e61c-4826-8338-f923d4af0f6f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635814980_40233_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61808e4a1742d7102602f8db,"OPEN - GENERAL - V3",1635826804,1635814503,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}","",,202062009,performance,"29d7a512-6136-43b4-954e-9946e410db77",5422,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635814980_40233_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062009 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6180a80ff96ef44b7a121053,"OPEN - GENERAL - V3",1635821705,1635821403,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","",,202183678,medium,"c64dde7a-78ca-4873-919b-b716be5e26fc",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635821580_39820_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6180a813f96ef44b7a121059,"OPEN - GENERAL - V3",1635822005,1635821403,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,high,"d9f016de-dc53-4e99-b2d7-e338c30f3c52",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635821580_39820_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6180a93b80a98715a02ddc51,"OPEN - GENERAL - V3",1635822005,1635821705,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,medium,"15b8a8f1-fb9a-404d-9d4c-8086ec7ebf70",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635821880_40388_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6180c42f80a98715a02ddc73,"OPEN - GENERAL - V3",1635829503,1635828605,"alert_manager","","",,"{""edgeId"": ""994"", ""linkId"": ""2264"", ""interface"": ""GE3""}","",,202041377,medium,"d0731351-38b8-4dd2-b2f5-19693f1ffa80",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635828780_40608_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041377 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6180cb371742d7102602f937,"OPEN - GENERAL - V3",1635831003,1635830404,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,high,"a0a86d34-5311-4492-b6ec-8d3bd2397c8f",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635830580_40755_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6180d23f1742d7102602f93b,"OPEN - GENERAL - V3",1635838804,1635832203,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,high,"b63c1e30-e772-42ed-9d08-721adcc2f1ed",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635832380_40813_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6180d36b1742d7102602f93e,"OPEN - GENERAL - V3",1635838804,1635832504,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,medium,"aa70fffc-7ca4-475c-8de5-8d92429df91d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635832680_40824_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6180d5c31742d7102602f947,"OPEN - GENERAL - V3",1635839105,1635832803,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,medium,"89b83520-fab5-47c6-8438-4b142c47e3cd",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635833280_40846_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6180d6f01742d7102602f94d,"OPEN - GENERAL - V3",1635833704,1635833404,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}","",,202062023,medium,"2cdffd25-383d-47ef-a06b-8573f3e8d88e",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635833580_40856_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6180e04ff96ef44b7a12108a,"OPEN - GENERAL - V3",1635840904,1635835804,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"76807a8e-d1d8-45c2-92e9-2c25dc4c2791",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635835980_40282_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6180ed34f96ef44b7a12109c,"OPEN - GENERAL - V3",1635849603,1635838804,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,performance,"b02e9be4-2f4f-40a3-a881-2c56e2f6a572",4487,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635839280_40382_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"null - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61810e0480a98715a02ddcaa,"OPEN - GENERAL - V3",1635847804,1635847503,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}","",,202040643,high,"5212bf81-913e-4c54-995f-e0b644aa76d7",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635847680_41214_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618112b380a98715a02ddcb2,"OPEN - GENERAL - V3",1635850803,1635848704,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"cb59d808-82fe-406a-a1c3-7a4c8c1d36c9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635848880_41249_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6181176480a98715a02ddcba,"OPEN - GENERAL - V3",1635916205,1635849603,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","",,201912648,performance,"13b7bfb5-dd2d-4abe-9fb4-10f0b105d749",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635850080_41287_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618120c31742d7102602f98d,"OPEN - GENERAL - V3",1635852602,1635852305,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}","",,202046758,medium,"b4b4b8f4-0cd3-47fa-bc03-7fbc0d7d0439",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635852480_41476_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618128f6f96ef44b7a1210be,"OPEN - GENERAL - V3",1635858604,1635854404,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"b696aa43-c3ae-415f-b3bb-94c0f838f05f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635854580_40872_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618128f8f96ef44b7a1210c1,"OPEN - GENERAL - V3",1635886804,1635854404,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2841"", ""interface"": ""GE4""}","",,202046758,high,"d1fa1c07-cbde-44e2-ade5-f3c9681e305b",1118,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635854580_40872_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202046758 - Edge 1118 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61812a231742d7102602f997,"OPEN - GENERAL - V3",1635886804,1635854704,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2841"", ""interface"": ""GE4""}","",,202046758,medium,"fd38ef72-9dab-45bd-be98-e4a20f6be1e3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635854880_41555_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61812a231742d7102602f999,"OPEN - GENERAL - V3",1635887104,1635854704,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}","",,202046758,medium,"9697003c-a87b-4e29-a606-e43885d0a50a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635854880_41555_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61812b5280a98715a02ddccb,"OPEN - GENERAL - V3",1635887104,1635854704,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2841"", ""interface"": ""GE4""}","",,202046758,high,"35e59792-e3be-4121-af19-1cabcdd30f4f",1118,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635855180_41448_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202046758 - Edge 1118 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61812c7b80a98715a02ddccf,"OPEN - GENERAL - V3",1635887104,1635855004,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2841"", ""interface"": ""GE4""}","",,202046758,medium,"d65e03c6-614d-4a44-bbee-9c91290b4d6e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635855480_41457_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61812c7c80a98715a02ddcd1,"OPEN - GENERAL - V3",1635887405,1635855004,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}","",,202046758,medium,"64b94b72-41f5-4493-b559-257ad58de306",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635855480_41457_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618130021742d7102602f9a4,"OPEN - GENERAL - V3",1635856803,1635855904,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","",,202041335,performance,"8e9d96ce-e12c-4434-978d-543b4984a936",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635856380_41603_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6181313180a98715a02ddced,"OPEN - GENERAL - V3",1635861606,1635856504,"alert_manager","","",,"{""edgeId"": ""1383"", ""linkId"": ""3603"", ""interface"": ""SFP2""}","",,202059394,high,"582acc8e-f4bc-470f-a7a5-6b296e0c10d7",1383,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635856680_41493_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059394 - Edge 1383 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6181325980a98715a02ddcf4,"OPEN - GENERAL - V3",1635861606,1635856803,"alert_manager","","",,"{""edgeId"": ""1383"", ""linkId"": ""3603"", ""interface"": ""SFP2""}","",,202059394,medium,"51e36978-f111-44c8-be8e-f5d54bda2f75",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635856980_41502_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059394 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6181325a80a98715a02ddcf6,"OPEN - GENERAL - V3",1635861606,1635856803,"alert_manager","","",,"{""edgeId"": ""1383"", ""linkId"": ""3604"", ""interface"": ""SFP1""}","",,202059394,medium,"9b7f5fa8-1cb0-4953-85a8-5ab65f097456",SFP1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635856980_41502_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059394 - Link SFP1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6181325f80a98715a02ddcfd,"OPEN - GENERAL - V3",1635857105,1635856803,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"a436b974-8ec8-423e-9a94-974e33b4aa40",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635856980_41502_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6181338af96ef44b7a1210cd,"OPEN - GENERAL - V3",1635861905,1635856803,"alert_manager","","",,"{""edgeId"": ""1383"", ""linkId"": ""3603"", ""interface"": ""SFP2""}","",,202059394,high,"0b191b57-77b2-425f-bd67-bc42e0ce4988",1383,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635857280_40961_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059394 - Edge 1383 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618134b180a98715a02ddd03,"OPEN - GENERAL - V3",1635861905,1635857105,"alert_manager","","",,"{""edgeId"": ""1383"", ""linkId"": ""3603"", ""interface"": ""SFP2""}","",,202059394,medium,"f869cc2d-f6b0-4c29-ab9f-8f41bf1e43a2",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635857580_41520_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059394 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618134b280a98715a02ddd05,"OPEN - GENERAL - V3",1635861905,1635857105,"alert_manager","","",,"{""edgeId"": ""1383"", ""linkId"": ""3604"", ""interface"": ""SFP1""}","",,202059394,medium,"b8427885-a9ae-4c1f-b550-4fee8f8daccf",SFP1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635857580_41520_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059394 - Link SFP1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6181396280a98715a02ddd11,"OPEN - GENERAL - V3",1635858905,1635858604,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","",,202061983,medium,"b12420f2-de38-4f17-b311-33b12cecac06",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635858780_41557_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061983 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61813a8f1742d7102602f9b9,"OPEN - GENERAL - V3",1635860703,1635858604,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","",,202041335,performance,"220886b6-649c-42c7-9f62-79bccf54cf3a",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635859080_41696_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61814772f96ef44b7a1210f5,"OPEN - GENERAL - V3",1635862505,1635861905,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","",,202041335,performance,"e2268b4b-116d-4ffd-bed5-7e80d1aefe91",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635862380_41125_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6181489cf96ef44b7a1210fc,"OPEN - GENERAL - V3",1635862804,1635862505,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}","",,20197447,medium,"a3e80391-7395-4a9d-9eb4-ad080dbbdcf8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635862680_41134_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61814d4d1742d7102602f9e5,"OPEN - GENERAL - V3",1635914105,1635863404,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","",,202041335,performance,"cc1ae72e-deda-411b-953d-5d4523fb22d8",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635863880_41854_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6181557ff96ef44b7a121115,"OPEN - GENERAL - V3",1635866102,1635865804,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"4867c58d-0d59-4a42-b68c-dbdde57218a9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635865980_41245_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618157d7f96ef44b7a12111a,"OPEN - GENERAL - V3",1635951902,1635866404,"alert_manager","","",,"{""edgeId"": ""1383"", ""linkId"": ""3603"", ""interface"": ""SFP2""}","",,202059394,medium,"621e0385-4ca7-4edd-880f-3fd11edb3634",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635866580_41265_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059394 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61815db6f96ef44b7a121126,"OPEN - GENERAL - V3",1635868205,1635867904,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"4fcaf400-50ca-405b-97ca-dcedf9ef7784",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635868080_41312_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61816e1b1742d7102602fa10,"OPEN - GENERAL - V3",1635872704,1635872103,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,medium,"4732b916-08fa-4661-8ac4-8b2f6b04ba28",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635872280_42132_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61816f4bf96ef44b7a121145,"OPEN - GENERAL - V3",1635873003,1635872403,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"32fd7e22-1c40-47ae-8e00-74006a54d1ae",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635872580_41456_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618170731742d7102602fa16,"OPEN - GENERAL - V3",1635873003,1635872704,"alert_manager","","",,"{""edgeId"": ""942"", ""linkId"": ""1964"", ""interface"": ""GE3""}","",,202040624,medium,"ce474116-9d83-4d42-af3b-1ae819a1ee86",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635872880_42151_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040624 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6181719f1742d7102602fa1d,"OPEN - GENERAL - V3",1635883205,1635872704,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,performance,"cf3c8de5-2b33-43dd-b28e-7f5a6383d8f9",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635873180_42161_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6181777c80a98715a02ddd82,"OPEN - GENERAL - V3",1635935703,1635874505,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","",,202041369,medium,"3824c099-af4f-4722-868c-9bdfbece8f83",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635874680_42058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6181777d80a98715a02ddd84,"OPEN - GENERAL - V3",1635936303,1635874505,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}","",,202041369,medium,"762bd4d4-c7bb-4f0a-b1d9-46f23fa0746a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635874680_42058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6181778180a98715a02ddd89,"OPEN - GENERAL - V3",1635874803,1635874505,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}","",,202059977,high,"5abd0fc9-872a-4dec-bb0b-944d594d4a6e",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635874680_42058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6181778180a98715a02ddd8b,"OPEN - GENERAL - V3",1635874803,1635874505,"alert_manager","","",,"{""edgeId"": ""1268"", ""linkId"": ""3300"", ""interface"": ""GE3""}","",,202059975,high,"72f3fc75-9c80-4252-b404-7021172a27a5",1268,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635874680_42058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059975 - Edge 1268 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6181778280a98715a02ddd8d,"OPEN - GENERAL - V3",1635874803,1635874505,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}","",,202059979,high,"1ba6bad5-d218-4a6f-8638-df631b42c1bd",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635874680_42058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6181778380a98715a02ddd8f,"OPEN - GENERAL - V3",1635874803,1635874505,"alert_manager","","",,"{""edgeId"": ""924"", ""linkId"": ""4017"", ""interface"": ""SFP2""}","",,202041392,high,"940f0dbe-0116-4c2f-816b-30bf0a4db470",924,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635874680_42058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041392 - Edge 924 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6181778480a98715a02ddd91,"OPEN - GENERAL - V3",1635935703,1635874505,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","",,202041369,high,"37313d3a-4b46-4e2f-8a68-3739e102035b",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635874680_42058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041369 - Edge 986 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618178a9f96ef44b7a121150,"OPEN - GENERAL - V3",1635885905,1635874505,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4914"", ""interface"": ""GE3""}","",,202062013,performance,"c7ce9d39-aa80-4461-a157-5bb881d08f98",4914,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635874980_41538_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062013 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618179d4f96ef44b7a121159,"OPEN - GENERAL - V3",1635936003,1635874803,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","",,202041369,medium,"3c3a9179-d886-4594-a6c6-9efaba9427fc",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635875280_41550_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618179d5f96ef44b7a12115b,"OPEN - GENERAL - V3",1635936603,1635874803,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}","",,202041369,medium,"108522a3-98dd-4e7e-894b-013714ffc73a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635875280_41550_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618179d6f96ef44b7a12115d,"OPEN - GENERAL - V3",1635885304,1635874803,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","",,202062007,performance,"7f9a4395-4d5c-4472-86ef-feab386b936d",4164,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635875280_41550_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062007 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618179d6f96ef44b7a12115f,"OPEN - GENERAL - V3",1635885304,1635874803,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4165"", ""interface"": ""GE3""}","",,202062007,performance,"d9ec8fb7-4ace-4087-85bf-ee1254e6a23c",4165,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635875280_41550_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062007 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618180e11742d7102602fa41,"OPEN - GENERAL - V3",1635887405,1635876603,"alert_manager","","",,"{""edgeId"": ""984"", ""linkId"": ""2221"", ""interface"": ""GE4""}","",,202041367,performance,"a6dc1773-217f-4026-9cde-f4f02216b285",2221,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635877080_42282_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041367 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618194c7f96ef44b7a12119a,"OPEN - GENERAL - V3",1635882306,1635882004,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"5c5d9307-0d7d-4b02-ab94-49a21a0dd7fb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635882180_41762_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6181971f1742d7102602fa91,"OPEN - GENERAL - V3",1635882905,1635882603,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"52f2a1b0-1e9d-4870-a417-2b37fe9dd6fa",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635882780_42469_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61819f54f96ef44b7a1211da,"OPEN - GENERAL - V3",1635885003,1635884702,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"d92f71d4-f551-4f25-af21-9b14fc42629c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635884880_41854_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6181c60080a98715a02dde7a,"OPEN - GENERAL - V3",1635894904,1635894604,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4047"", ""interface"": ""GE4""}","",,202061987,medium,"53f26240-403d-4165-b281-6a097b4e9b0d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635894780_42704_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061987 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182122af96ef44b7a121257,"OPEN - GENERAL - V3",1635934203,1635914105,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"845d40af-5b57-4819-b5d4-76af58285299",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635914280_42821_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61821485f96ef44b7a12125f,"OPEN - GENERAL - V3",1635915003,1635914705,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","",,202040644,high,"4e1a276a-01cb-454b-b0b2-f8a1983aac6f",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635914880_42838_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618215b1f96ef44b7a121265,"OPEN - GENERAL - V3",1635915304,1635915003,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"144d2223-dc88-4567-9951-ed746c5b55e2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635915180_42849_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618216dd80a98715a02ddee6,"OPEN - GENERAL - V3",1635916805,1635915304,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}","",,202040669,medium,"11ce0686-11ea-418e-93b4-bfc5018e8fb1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635915480_43364_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618226171742d7102602fb2d,"OPEN - GENERAL - V3",1635919505,1635919204,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","",,null,high,"4990469f-21fa-4155-838a-6934995f74e5",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635919380_43637_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6182299b1742d7102602fb31,"OPEN - GENERAL - V3",1635921604,1635920105,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""2779"", ""interface"": ""GE4""}","",,202040654,medium,"7e8682bd-fd96-4a42-8343-9cffee2b9f16",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635920280_43663_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040654 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61822bf31742d7102602fb35,"OPEN - GENERAL - V3",1635921905,1635920403,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""2779"", ""interface"": ""GE4""}","",,202040654,medium,"314c4bff-5374-4246-9c17-d78d5a8561a7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635920880_43678_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040654 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61823fdf1742d7102602fb45,"OPEN - GENERAL - V3",1635926102,1635925804,"alert_manager","","",,"{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}","",,202185145,medium,"d82ce006-da86-4df0-81f3-f052f89f8a30",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635925980_43849_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202185145 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61824a6cf96ef44b7a12128c,"OPEN - GENERAL - V3",1635928802,1635928504,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""5186"", ""interface"": ""GE3""}","",,202062003,medium,"f32fb806-fae4-46bd-a08c-a4a2b10df41d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635928680_43305_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062003 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61825f84f96ef44b7a121296,"OPEN - GENERAL - V3",1635937803,1635933903,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1887"", ""interface"": ""GE3""}","",,202040667,high,"86b62c16-012a-4873-8a36-b860c9a9606b",974,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635934080_43481_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040667 - Edge 974 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618260af80a98715a02ddf1b,"OPEN - GENERAL - V3",1635937803,1635934203,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1887"", ""interface"": ""GE3""}","",,202040667,medium,"525789fe-4e95-417b-be8b-74c8d2c32062",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635934380_43975_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040667 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618260b080a98715a02ddf1d,"OPEN - GENERAL - V3",1635938104,1635934203,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1888"", ""interface"": ""GE4""}","",,202040667,medium,"2146b8f2-2950-4c23-9434-909303b080e7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635934380_43975_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040667 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61826307f96ef44b7a12129f,"OPEN - GENERAL - V3",1635938104,1635934505,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1887"", ""interface"": ""GE3""}","",,202040667,medium,"4a8a58a3-0e5c-44ec-b376-daa2d798c339",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635934980_43511_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040667 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61826308f96ef44b7a1212a1,"OPEN - GENERAL - V3",1635938402,1635934505,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1888"", ""interface"": ""GE4""}","",,202040667,medium,"79d0aa74-009e-469f-b511-74600181f789",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635934980_43511_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040667 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182736f80a98715a02ddf22,"OPEN - GENERAL - V3",1635939603,1635939002,"alert_manager","","",,"{""edgeId"": ""1011"", ""linkId"": ""1956"", ""interface"": ""GE3""}","",,202040674,medium,"7dea9496-5abe-4c8d-aff0-10fe5823a239",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635939180_44121_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040674 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182737080a98715a02ddf24,"OPEN - GENERAL - V3",0,1635938705,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,performance,"1316efa2-989d-4469-b10f-356ca9ac429f",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635939180_44121_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""1316efa2-989d-4469-b10f-356ca9ac429f"", ""Descricao"": ""__201749053 --- 2021nov04/TESTE 2, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",new,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618275c7f96ef44b7a1212c6,"OPEN - GENERAL - V3",1635997203,1635939303,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","",,202041335,performance,"f1a6eef4-3139-4859-9046-25f3a6fff45c",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635939780_43662_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6182781f80a98715a02ddf2a,"OPEN - GENERAL - V3",1635940503,1635940202,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","",,202183678,medium,"d3f4ac30-5082-4eac-a956-d34773046fa1",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635940380_44160_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182794b80a98715a02ddf2f,"OPEN - GENERAL - V3",1635940803,1635940503,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,medium,"8fcccdd3-df64-4c08-9b65-6d86d536ec17",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635940680_44170_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182794e80a98715a02ddf33,"OPEN - GENERAL - V3",1635940803,1635940503,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"492dfde2-0031-436f-8f4b-3522067e4c9a",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635940680_44170_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61827ba480a98715a02ddf38,"OPEN - GENERAL - V3",1635941402,1635941102,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"cd563fc8-4db6-4c55-ad82-04f9a6c22297",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635941280_44189_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61827ccff96ef44b7a1212cc,"OPEN - GENERAL - V3",1635942603,1635941402,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1887"", ""interface"": ""GE3""}","",,202040667,medium,"4870a050-e029-480c-b76e-dde2547a772f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635941580_43721_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040667 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61827cd0f96ef44b7a1212ce,"OPEN - GENERAL - V3",1635942904,1635941402,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1888"", ""interface"": ""GE4""}","",,202040667,medium,"92ed6a32-81e8-4589-91a6-3a22bb5432d9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635941580_43721_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040667 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61827cd2f96ef44b7a1212d2,"OPEN - GENERAL - V3",1635942603,1635941402,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1887"", ""interface"": ""GE3""}","",,202040667,high,"930b9ce9-e5ea-4669-a42c-d2f06eb0020c",974,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635941580_43721_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040667 - Edge 974 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61827f261742d7102602fb7b,"OPEN - GENERAL - V3",1635942904,1635941704,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1887"", ""interface"": ""GE3""}","",,202040667,medium,"11e513e9-ad86-4377-9eb4-95910ed64bd5",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635942180_44368_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040667 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61827f271742d7102602fb7d,"OPEN - GENERAL - V3",1635943204,1635941704,"alert_manager","","",,"{""edgeId"": ""974"", ""linkId"": ""1888"", ""interface"": ""GE4""}","",,202040667,medium,"d05302aa-9174-4e4c-a42a-3c4354b157e0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635942180_44368_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040667 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618280531742d7102602fb84,"OPEN - GENERAL - V3",1635942603,1635942304,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"72bc82b4-39fa-4683-90c9-da8f6bfd7fb1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635942480_44379_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618280551742d7102602fb88,"OPEN - GENERAL - V3",1635978602,1635942002,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","",,202162229,performance,"7943b4eb-c331-4be6-a0ef-500c067b984d",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635942480_44379_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618282abf96ef44b7a1212d6,"OPEN - GENERAL - V3",1635943204,1635942904,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"8c1221aa-6a37-403e-95a2-911dd70f95a1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635943080_43767_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618283d61742d7102602fb8f,"OPEN - GENERAL - V3",1635978903,1635942904,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","",,202162229,performance,"6580b41a-50dd-48ac-bfdc-3ff053347f6a",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635943380_44409_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",61828630f96ef44b7a1212dd,"OPEN - GENERAL - V3",1635944103,1635943802,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"12cdae81-a588-4244-be3c-1c954a75823e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635943980_43798_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61828d3af96ef44b7a1212f1,"OPEN - GENERAL - V3",1635945903,1635945604,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"44c2bff2-495c-4012-8b01-e01681abd902",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635945780_43853_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6182944080a98715a02ddf6e,"OPEN - GENERAL - V3",1636204804,1635947403,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,medium,"a79ff2a9-dae6-43f5-b977-fed714727f15",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635947580_44403_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618298f180a98715a02ddf7c,"OPEN - GENERAL - V3",1635948903,1635948604,"alert_manager","","",,"{""edgeId"": ""461"", ""linkId"": ""2407"", ""interface"": ""GE2""}","",,202058025,medium,"36058def-afd6-42ce-992b-bb4c283d4d25",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635948780_44440_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058025 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61829a1cf96ef44b7a121302,"OPEN - GENERAL - V3",1635964503,1635948903,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"1541cbbc-ad9b-406a-89f5-731037a3d54d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635949080_43951_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61829a20f96ef44b7a121307,"OPEN - GENERAL - V3",1635949204,1635948903,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"2c8749fd-c1c8-4a95-82d6-2db83562bf98",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635949080_43951_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61829b4a80a98715a02ddf85,"OPEN - GENERAL - V3",1635949503,1635949204,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}","",,20197442,medium,"97d61177-9f35-44e5-bb73-3089c8ab7911",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635949380_44460_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197442 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61829b4c80a98715a02ddf89,"OPEN - GENERAL - V3",1635958804,1635948903,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}","",,20197442,performance,"044edd9c-f03c-4907-a249-6ccfacc4bb41",1072,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635949380_44460_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"20197442 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6182a125f96ef44b7a121313,"OPEN - GENERAL - V3",1635951004,1635950703,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","",,202061983,medium,"f180e879-53e4-4110-9d27-a3fd94c65b5b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635950880_44008_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061983 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182a127f96ef44b7a121317,"OPEN - GENERAL - V3",1635952204,1635950702,"alert_manager","","",,"{""edgeId"": ""914"", ""linkId"": ""2054"", ""interface"": ""GE3""}","",,202040641,medium,"a3f1bc4b-2573-422e-8719-e358609af1f8",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635950880_44008_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040641 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182a128f96ef44b7a121319,"OPEN - GENERAL - V3",1635952204,1635950702,"alert_manager","","",,"{""edgeId"": ""914"", ""linkId"": ""2056"", ""interface"": ""GE4""}","",,202040641,medium,"b8e7cc35-441e-4a50-8051-f2a2f8322837",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635950880_44008_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040641 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182a12df96ef44b7a12131f,"OPEN - GENERAL - V3",1635952204,1635950702,"alert_manager","","",,"{""edgeId"": ""914"", ""linkId"": ""2054"", ""interface"": ""GE3""}","",,202040641,high,"2ee554a2-1004-4233-9094-03c2f43f9924",914,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635950880_44008_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040641 - Edge 914 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6182a37d1742d7102602fbb4,"OPEN - GENERAL - V3",1635952502,1635951004,"alert_manager","","",,"{""edgeId"": ""914"", ""linkId"": ""2054"", ""interface"": ""GE3""}","",,202040641,medium,"67118e4e-7eb6-4a61-92d5-00ae6443e3c8",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635951480_44671_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040641 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182a37e1742d7102602fbb6,"OPEN - GENERAL - V3",1635952502,1635951004,"alert_manager","","",,"{""edgeId"": ""914"", ""linkId"": ""2056"", ""interface"": ""GE4""}","",,202040641,medium,"95d591c9-777e-46c0-b009-fc596acda808",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635951480_44671_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040641 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182b2b81742d7102602fbd8,"OPEN - GENERAL - V3",1635955503,1635955203,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}","",,202061985,medium,"ecda0c3b-6295-4613-b36f-74d7b177fa24",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635955380_44794_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061985 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182c3231742d7102602fbf7,"OPEN - GENERAL - V3",1635959702,1635959403,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"edabdae7-fff1-4116-9d62-4c5c6fc3ceac",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635959580_44928_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6182c579f96ef44b7a12138b,"OPEN - GENERAL - V3",1635960302,1635960002,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}","",,20197447,medium,"3339b69c-6173-4198-b48a-545f1d4ce3c6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635960180_44319_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182c57df96ef44b7a121390,"OPEN - GENERAL - V3",1635969903,1635959702,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2844"", ""interface"": ""GE4""}","",,202058022,performance,"dadce92e-3aed-456d-978a-5c61ac1f42c1",2844,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635960180_44319_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202058022 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6182c7d680a98715a02ddfe3,"OPEN - GENERAL - V3",1635960902,1635960602,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","",,202062017,high,"c0908737-c771-4b42-8720-2cb88bc72b9f",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635960780_44826_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6182d70df96ef44b7a1213c6,"OPEN - GENERAL - V3",1635965704,1635964503,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}","",,20197447,medium,"b4c1b051-8c6b-4bff-817e-84953988bd90",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635964680_44467_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182d96580a98715a02de010,"OPEN - GENERAL - V3",1635966002,1635964802,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}","",,20197447,medium,"8b0eb804-b235-44cc-a98a-813ad2ad98fc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635965280_44968_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182d96a80a98715a02de016,"OPEN - GENERAL - V3",1635965402,1635965104,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}","",,20197432,high,"02c4fa82-6ccc-423f-bc92-3ad7a6a027dc",410,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635965280_44968_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197432 - Edge 410 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6182da9580a98715a02de021,"OPEN - GENERAL - V3",1635975904,1635965104,"alert_manager","","",,"{""edgeId"": ""984"", ""linkId"": ""2221"", ""interface"": ""GE4""}","",,202041367,performance,"9e747294-c79d-4737-82f3-3bd0a1312a3c",2221,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635965580_44979_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041367 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6182de1580a98715a02de026,"OPEN - GENERAL - V3",1635966904,1635966305,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}","",,20197432,medium,"100379f6-e881-4556-9cb2-fc9bd0206773",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635966480_45006_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182df401742d7102602fc1d,"OPEN - GENERAL - V3",1635966904,1635966602,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}","",,20197447,medium,"6408bafe-1c19-4e88-b91b-45d60d8bfc1e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635966780_45168_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182e2c31742d7102602fc26,"OPEN - GENERAL - V3",1635967803,1635967502,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""4076"", ""interface"": ""GE4""}","",,202062003,medium,"740d5760-e91c-43f9-8a49-29e54ad7b7b3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635967680_45196_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062003 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182e7741742d7102602fc31,"OPEN - GENERAL - V3",1635977704,1635968402,"alert_manager","","",,"{""edgeId"": ""1561"", ""linkId"": ""4120"", ""interface"": ""GE4""}","",,202062021,performance,"906ed58f-0cef-4983-8c25-e32a87014cb7",4120,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635968880_45231_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062021 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6182e9cf80a98715a02de042,"OPEN - GENERAL - V3",1635980404,1635969003,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""4076"", ""interface"": ""GE4""}","",,202062003,performance,"8e972b69-6a43-4b33-9324-5de79720aba2",4076,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635969480_45104_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062003 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6182eaf81742d7102602fc3a,"OPEN - GENERAL - V3",1635969903,1635969602,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","",,202041381,medium,"21015b3f-fa7e-464e-9692-798d83ddd2ac",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635969780_45258_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041381 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182f0d41742d7102602fc59,"OPEN - GENERAL - V3",1635971704,1635971104,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"33e5e828-8700-4ee6-ae8c-ca469d54c2d0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635971280_45305_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182f6b1f96ef44b7a12140a,"OPEN - GENERAL - V3",1635972904,1635972602,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"36848c8e-e0df-41b5-a675-e3b5763c198b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635972780_44733_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6182f907f96ef44b7a121414,"OPEN - GENERAL - V3",1635973802,1635973203,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","",,202041381,medium,"a1815ad6-d011-4b2b-92de-60561e1a2000",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635973380_44749_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041381 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6182fee480a98715a02de078,"OPEN - GENERAL - V3",1635975002,1635974702,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","",,202041381,medium,"a71db477-2ac1-4030-b58b-b1da218213e4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635974880_45293_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041381 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618307171742d7102602fc7e,"OPEN - GENERAL - V3",1635977104,1635976803,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","",,202041381,medium,"44ca4d08-4785-4181-8192-dd13f22c52e5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635976980_45473_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041381 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618311a31742d7102602fc9b,"OPEN - GENERAL - V3",1635979802,1635979504,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}","",,20197432,medium,"cd61f07d-1550-4933-9b85-f01fa8cd69f0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635979680_45553_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61831655f96ef44b7a12145d,"OPEN - GENERAL - V3",1636002904,1635980404,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","",,201912648,performance,"a33e61d2-5efc-4b97-802e-b1cd047e6694",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635980880_44994_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618318ac1742d7102602fca6,"OPEN - GENERAL - V3",1635981602,1635981303,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}","",,202040643,medium,"e7619dc5-addf-466e-8955-e1c398ccdb4a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635981480_45609_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61832b6bf96ef44b7a12147f,"OPEN - GENERAL - V3",1635987304,1635986102,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,medium,"eb0eed88-712e-4801-a71f-fe0f31345d8e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635986280_45170_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61832b6ff96ef44b7a121485,"OPEN - GENERAL - V3",1635987003,1635986102,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,high,"e6502a45-d769-4033-aac7-a9ff79103229",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635986280_45170_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61832dc380a98715a02de0cc,"OPEN - GENERAL - V3",1635987604,1635986402,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,medium,"c1880327-e586-4999-bdbc-17137cf50c43",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635986880_45684_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61833bd480a98715a02de0e4,"OPEN - GENERAL - V3",1636001704,1635990003,"alert_manager","","",,"{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}","",,202185145,performance,"4ea4629f-de89-428f-88b2-9551ca7c18f8",5068,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635990480_45793_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202185145 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6183547080a98715a02de109,"OPEN - GENERAL - V3",1636007104,1635996604,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}","",,202058022,medium,"70711437-0923-4def-8021-8969f11f0ea4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635996780_45997_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058022 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6183547180a98715a02de10b,"OPEN - GENERAL - V3",1636007104,1635996604,"alert_manager","","",,"{""edgeId"": ""512"", ""linkId"": ""2755"", ""interface"": ""SFP2""}","",,202058023,medium,"1a7f1a85-959a-44ae-8722-f792cdff8c92",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635996780_45997_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058023 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618356c7f96ef44b7a1214bb,"OPEN - GENERAL - V3",1636007403,1635996902,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}","",,202058022,medium,"dd427adf-ac4e-4245-b989-932064765b55",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635997380_45542_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058022 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61835ca380a98715a02de11a,"OPEN - GENERAL - V3",1636026002,1635998704,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","",,202040637,medium,"b479993e-76ad-4715-8994-13b723249e1b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635998880_46068_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61835dd480a98715a02de129,"OPEN - GENERAL - V3",1636009504,1635998704,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2844"", ""interface"": ""GE4""}","",,202058022,performance,"44675093-3e4b-4ec6-bbeb-e889bd6a34f5",2844,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635999180_46077_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058022 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61835f001742d7102602fd29,"OPEN - GENERAL - V3",1636000803,1635999304,"alert_manager","","",,"{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}","",,202058771,high,"c6176084-fad8-4bec-bbb9-acd1b5fbdf88",1499,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635999480_46183_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202058771 - Edge 1499 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618360271742d7102602fd2d,"OPEN - GENERAL - V3",1636000803,1635999603,"alert_manager","","",,"{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}","",,202058771,medium,"5ef66ace-e069-4d06-b0b5-27926311b76d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635999780_46192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058771 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6183615bf96ef44b7a1214e1,"OPEN - GENERAL - V3",1636001104,1635999603,"alert_manager","","",,"{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}","",,202058771,high,"a99840d7-7b6c-4fb9-a13d-b5a16b951aab",1499,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636000080_45621_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202058771 - Edge 1499 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6183628080a98715a02de12e,"OPEN - GENERAL - V3",1636001104,1635999905,"alert_manager","","",,"{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}","",,202058771,medium,"ccfc4389-2680-4da4-a8ed-a82e19a63ddc",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636000380_46120_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058771 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183708f1742d7102602fd6a,"OPEN - GENERAL - V3",1636004703,1636003802,"alert_manager","","",,"{""edgeId"": ""1066"", ""linkId"": ""2457"", ""interface"": ""GE3""}","",,20197418,medium,"4d8bb1a1-2c23-4ea4-921f-3b735d0455ab",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636003980_46325_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197418 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183847d1742d7102602fd97,"OPEN - GENERAL - V3",1636009803,1636008903,"alert_manager","","",,"{""edgeId"": ""1573"", ""linkId"": ""4735"", ""interface"": ""GE4""}","",,202177775,high,"f52bf47c-5b74-4b6c-83b7-5e8719c6d6a1",1573,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636009080_46491_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202177775 - Edge 1573 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618385a8f96ef44b7a12150c,"OPEN - GENERAL - V3",1636009504,1636009203,"alert_manager","","",,"{""edgeId"": ""1573"", ""linkId"": ""4735"", ""interface"": ""GE4""}","",,202177775,medium,"aac7671a-d434-4a82-8b93-6b7254be8cbb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636009380_45941_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202177775 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61838b8480a98715a02de186,"OPEN - GENERAL - V3",1636011904,1636010704,"alert_manager","","",,"{""edgeId"": ""1292"", ""linkId"": ""4040"", ""interface"": ""GE1""}","",,202057368,medium,"7bed1c37-9c76-487a-a30f-b9b65ff4c662",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636010880_46453_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202057368 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61838b8680a98715a02de189,"OPEN - GENERAL - V3",1636011904,1636010704,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","",,null,medium,"7bf86841-5938-4ea6-ab10-635f9f14eae7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636010880_46453_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61838b8780a98715a02de18c,"OPEN - GENERAL - V3",1636011904,1636010704,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","",,null,high,"81e5c303-747a-45f9-9391-4639e66223e7",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636010880_46453_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61838dde80a98715a02de199,"OPEN - GENERAL - V3",1636012203,1636011002,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","",,null,medium,"c95b409c-7b58-4501-a2a3-addfe24fa8d4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636011480_46472_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183915f80a98715a02de19e,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""1132"", ""linkId"": ""2787"", ""interface"": ""GE3""}","",,202040653,medium,"995c27f0-db5c-44ab-b3fc-6c85358822ce",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040653 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916180a98715a02de1a2,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""622"", ""linkId"": ""1647"", ""interface"": ""GE4""}","",,201922763,medium,"935e56ba-a43b-4a64-95cf-aa69f0b85c07",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922763 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916280a98715a02de1a4,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""957"", ""linkId"": ""2066"", ""interface"": ""GE4""}","",,202040657,medium,"93054d96-03cf-4c73-8fb4-56ac3cd67d1d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040657 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916380a98715a02de1a6,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}","",,202040658,medium,"17113474-6836-4035-917e-194377c9ca07",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916480a98715a02de1a8,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}","",,202040658,medium,"3de71414-2c48-4b6d-abc0-7cfb402fcecb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916580a98715a02de1aa,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2062"", ""interface"": ""GE3""}","",,202040635,medium,"52ebbcdc-258a-4371-80ee-fa66f71b06e7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040635 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916680a98715a02de1ac,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2275"", ""interface"": ""GE4""}","",,202040635,medium,"3a043f26-9ea8-408b-ae05-1637dda03b23",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040635 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916780a98715a02de1ae,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""975"", ""linkId"": ""2063"", ""interface"": ""GE4""}","",,202041389,medium,"21709681-6a67-44a9-8cbe-283ce17d5878",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041389 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916880a98715a02de1b0,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""997"", ""linkId"": ""2100"", ""interface"": ""GE4""}","",,202041390,medium,"9b105264-3841-40f1-8ae1-7dd6abf8ac56",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041390 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183916a80a98715a02de1b3,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}","",,202040658,high,"bbe8c1ed-23f0-4f29-affb-e8a19af677f3",958,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040658 - Edge 958 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6183916c80a98715a02de1b6,"OPEN - GENERAL - V3",1636012504,1636012203,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2062"", ""interface"": ""GE3""}","",,202040635,high,"8947b960-6db8-4e02-b1ce-1cee877f9d69",971,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636012380_46499_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040635 - Edge 971 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6183ab2af96ef44b7a12153b,"OPEN - GENERAL - V3",1636019103,1636018803,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","",,202062007,high,"76b93a33-4488-4119-b8bf-f8f302a0a5c4",1578,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636018980_46242_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062007 - Edge 1578 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6183ac55f96ef44b7a121542,"OPEN - GENERAL - V3",1636045503,1636018803,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"777cd831-7a5f-4466-a367-311dcc281f53",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636019280_46253_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6183bde91742d7102602fdd5,"OPEN - GENERAL - V3",1636023902,1636023603,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","",,202041369,high,"8616269c-10a1-4f22-bc0e-3511d41345a8",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636023780_46961_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041369 - Edge 986 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6183c042f96ef44b7a121558,"OPEN - GENERAL - V3",1636024803,1636024203,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","",,201912648,high,"fabec851-32e8-44c8-a84f-c0d6a363852c",502,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636024380_46419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201912648 - Edge 502 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6183c61ef96ef44b7a121564,"OPEN - GENERAL - V3",0,1636025402,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","","",202041335,performance,"8be92b39-9fff-4907-a5a4-3c3be1a8e181",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636025880_46471_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","",unassigned,1,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,high
"Não","","","","","N/A","","","","",6183cf7af96ef44b7a121576,"OPEN - GENERAL - V3",0,1636028103,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","","",202040637,medium,"f7c9387e-3f75-4ed0-b16a-88c87e798c6f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636028280_46548_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,1,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,,"","",2,"202040637 - Link GE4 entrou em status UNSTABLE",86400,high
,,,,,,,,,,6183d05ef96ef44b7a12157b,testee,,1636039310,"alert_manager",carte,"","",,"","",,low,"bdb12e88-5f9c-49d0-9264-53858d781cea",,9a60c91029a5badee1ebb602a2c1bd20,,"",unassigned,,"",0,"|noop",,new,subcate,tagss,,testee,3600,low
,,,,,,,,,,6183d0cdf96ef44b7a12157c,teste,,1636039421,"alert_manager",unknown,"","",,"","",,low,"19141baf-7c58-4768-95ad-69e30fb56dcb",,887b1058d8b796c27ba66294de74d14a,,"",unassigned,,"",0,"|noop",,new,unknown,"[Untagged]",,teste,3600,low
"Não","","","","","N/A","","","","",6183d1d31742d7102602fdf9,"OPEN - GENERAL - V3",1636029004,1636028702,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"3a8b7675-7c1c-4aad-9ddd-94ba309d8748",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636028880_47122_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183d42c80a98715a02de210,"OPEN - GENERAL - V3",1636029602,1636029304,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"acf304bb-9a62-4807-b34a-ed7d4bf956e2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636029480_47056_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183d5581742d7102602fe04,"OPEN - GENERAL - V3",0,1636029304,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}","","",20197442,performance,"9f9b3cbe-9fc1-4d70-bc01-5dded45b8d2f",1072,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636029780_47150_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","",unassigned,1,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,,"","",4,"20197442 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6183e6ef80a98715a02de231,"OPEN - GENERAL - V3",0,1636034104,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","Falta de energia","",201912648,high,"6108da6b-6dbb-4fd2-9c0f-e8527918191b",502,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636034280_47211_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,132465,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,,"","",1,"201912648 - Edge 502 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6183ecca1742d7102602fe20,"OPEN - GENERAL - V3",1636035902,1636035602,"alert_manager","","",,"{""edgeId"": ""979"", ""linkId"": ""3181"", ""interface"": ""GE3""}","",,202040627,high,"55a9934d-5919-43a9-98a0-592d050757c1",979,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636035780_47335_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040627 - Edge 979 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6183f04bf96ef44b7a121597,"OPEN - GENERAL - V3",1636036803,1636036502,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","",,20197450,medium,"945fbe44-d62a-4c35-be53-44b108a147ef",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636036680_46832_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183f04cf96ef44b7a121599,"OPEN - GENERAL - V3",1636036803,1636036502,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","",,202040644,medium,"4226c962-89eb-477f-8348-1573b7adc92b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636036680_46832_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6183f050f96ef44b7a12159d,"OPEN - GENERAL - V3",0,1636036203,"alert_manager","","",,"{""edgeId"": ""622"", ""linkId"": ""1418"", ""interface"": ""GE3""}","Link 4G Failed","",201922763,performance,"92316707-a6ca-4327-9fc3-11d59567a248",1418,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636036680_46832_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",123465789,unassigned,1,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",,"","",4,"201922763 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,high
"Não","","","","","N/A","","","","",6183fd2f506b931a29305dac,"OPEN - GENERAL - V3",1636044602,1636039804,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,,202041373,medium,"e852044c-3100-4f42-93a1-c9394577dc52",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636039980_93_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6183fe5c86272b76bd56520a,"OPEN - GENERAL - V3",1636040402,1636040102,"alert_manager","","",,"{""edgeId"": ""461"", ""linkId"": ""2407"", ""interface"": ""GE2""}","N/A",,202058025,medium,"a8fcc9fb-3339-4e3e-88be-4c8c83e386bc",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636040280_95_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058025 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184030c86272b76bd565211,"OPEN - GENERAL - V3",1636043403,1636041303,"alert_manager","","",,"{""edgeId"": ""1930"", ""linkId"": ""5208"", ""interface"": ""GE4""}","N/A",,202183874,medium,"ede389a2-c7b2-4bfa-82ea-e9af95e2b0f5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636041480_131_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183874 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184030e86272b76bd565214,"OPEN - GENERAL - V3",1636118704,1636041303,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}","N/A",,202040669,medium,"53f91b42-015c-4760-a4ca-17242ca351f2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636041480_131_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040669 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184043c506b931a29305dbc,"OPEN - GENERAL - V3",1636041902,1636041604,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,,202041373,high,"1161a387-7ec0-4970-bafb-0ceb9ae199f5",990,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636041780_154_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041373 - Edge 990 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6184056586272b76bd56521b,"OPEN - GENERAL - V3",1636050902,1636041902,"alert_manager","","",,"{""edgeId"": ""989"", ""linkId"": ""2244"", ""interface"": ""GE4""}",,,202041372,medium,"170d6f97-2624-4998-bca7-998733e1fa49",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636042080_150_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041372 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184069086272b76bd565224,"OPEN - GENERAL - V3",1636042803,1636042202,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","N/A",,20197450,medium,"9c52bc00-6544-4782-99f7-48f290452bf1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636042380_158_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61840a137c6d6919ea6b2075,"OPEN - GENERAL - V3",1636043403,1636043104,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}",,,202061987,medium,"794e314c-5e19-45fd-93f6-7f0df7b40a0e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636043280_192_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061987 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61840eca7c6d6919ea6b2093,"OPEN - GENERAL - V3",1636044602,1636044304,"alert_manager","","",,"{""edgeId"": ""1930"", ""linkId"": ""5144"", ""interface"": ""GE3""}",,,202183874,high,"594ec5fd-5042-4c0c-9e37-36a2c006bad7",1930,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636044480_234_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202183874 - Edge 1930 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6184111b86272b76bd565235,"OPEN - GENERAL - V3",1636045203,1636044902,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,,202062011,medium,"26ae5ad3-77aa-4273-b3ee-e944eea7a1a3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636045080_246_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6184111b86272b76bd565237,"OPEN - GENERAL - V3",1636045203,1636044902,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""5309"", ""interface"": ""GE3""}",,,202062011,medium,"f0c0470a-c5ac-40d5-84ff-53f7f754bf34",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636045080_246_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6184112286272b76bd56523e,"OPEN - GENERAL - V3",1636045203,1636044902,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,,202062011,high,"80ffeaf6-598f-45cc-9e84-503464e3235d",1581,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636045080_246_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062011 - Edge 1581 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6184124b86272b76bd565246,"OPEN - GENERAL - V3",1636055703,1636044902,"alert_manager","","",,"{""edgeId"": ""425"", ""linkId"": ""913"", ""interface"": ""GE3""}","N/A",,20197436,performance,"7905f82f-7f1b-41dc-adbd-b18c7a80b1ff",913,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636045380_256_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"20197436 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61841372506b931a29305dd5,"OPEN - GENERAL - V3",1636045803,1636045503,"alert_manager","","",,"{""edgeId"": ""1001"", ""linkId"": ""2125"", ""interface"": ""GE4""}",,,202041382,medium,"341842ce-b4ea-46d7-83a9-a9883cb66535",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636045680_277_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041382 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61841dff506b931a29305df0,"OPEN - GENERAL - V3",1636048504,1636048203,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"488250db-998b-4907-bf30-73c08deabb0d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636048380_365_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618429b886272b76bd565269,"OPEN - GENERAL - V3",1636051502,1636051204,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",,,20197432,medium,"4ee234c8-79e7-4831-9346-2cb2ba69d7de",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636051380_443_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184495c86272b76bd56528b,"OPEN - GENERAL - V3",0,1636059303,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",,,202183678,medium,"25a908a6-ded9-4585-a5fa-27b9e1623fa1",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636059480_686_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""25a908a6-ded9-4585-a5fa-27b9e1623fa1"", ""Descricao"": ""__201749053 --- 2021nov08/TESTE 1, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": """", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",new,"","",2,"202183678 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618453ea86272b76bd5652a8,"OPEN - GENERAL - V3",0,1636062002,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","N/A",,202183678,high,"c0de3bd1-c168-4f95-a7ea-5004ac70ac8f",1935,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636062180_781_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202183678 - Edge 1935 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618455157c6d6919ea6b20d6,"OPEN - GENERAL - V3",0,1636062302,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5051"", ""interface"": ""GE2""}",,,202183678,medium,"21535f93-1c6a-4e11-86c0-7f83a3c55ffb",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636062480_850_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202183678 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6184576d86272b76bd5652ae,"OPEN - GENERAL - V3",0,1636062602,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5051"", ""interface"": ""GE2""}","N/A",,202183678,medium,"9e3beeb5-db18-45d9-8209-ad24687fba6d",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636063080_808_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202183678 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184576d86272b76bd5652b0,"OPEN - GENERAL - V3",1636063202,1636062902,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","N/A",,20197450,medium,"4fc17a33-5eb9-4db1-87b1-ad998ac7a878",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636063080_808_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61845c1d7c6d6919ea6b20f0,"OPEN - GENERAL - V3",1636069803,1636064102,"alert_manager","","",,"{""edgeId"": ""980"", ""linkId"": ""3119"", ""interface"": ""GE4""}",,,202040628,medium,"8fde0b59-4124-46d8-8d32-d0b0144e800b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636064280_913_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040628 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61846451506b931a29305e7c,"OPEN - GENERAL - V3",1636069502,1636066203,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",,,202040640,medium,"7404b298-ebf9-4b2c-88ab-aafd12935f40",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636066380_924_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040640 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618465827c6d6919ea6b2110,"OPEN - GENERAL - V3",1636084204,1636066203,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"5a5126a4-5b8b-49db-93cb-b9e38105869b",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636066680_986_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6184690886272b76bd5652e5,"OPEN - GENERAL - V3",1636067704,1636067403,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,,202040644,high,"c65533a0-727e-4999-a78d-0f0062fb7730",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636067580_958_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6184796d86272b76bd56531b,"OPEN - GENERAL - V3",1636072202,1636071603,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",,,202040640,high,"1a5c38f0-2239-4a4a-871e-899d2d52f0f3",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636071780_1097_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61847ced86272b76bd565321,"OPEN - GENERAL - V3",1636072803,1636072504,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}","N/A",,202040640,medium,"6766bf4f-2a20-4413-9cb3-c32daf4d97ef",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636072680_1131_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040640 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61847cee86272b76bd565323,"OPEN - GENERAL - V3",1636072803,1636072504,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2780"", ""interface"": ""GE4""}","N/A",,202040640,medium,"195fabed-07e0-4153-92b5-5677f0294245",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636072680_1131_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040640 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61847cf386272b76bd565329,"OPEN - GENERAL - V3",1636072803,1636072504,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}","N/A",,202040640,high,"0b5ddb6c-6507-48d3-9293-a5c0d02f591f",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636072680_1131_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040640 - Edge 972 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61848e7f506b931a29305eba,"OPEN - GENERAL - V3",1636077303,1636077002,"alert_manager","","",,"{""edgeId"": ""967"", ""linkId"": ""2113"", ""interface"": ""GE4""}",,,202040663,medium,"692405e2-a525-4858-a669-456315ec2b89",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636077180_1261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040663 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618490d87c6d6919ea6b217c,"OPEN - GENERAL - V3",1636078202,1636077604,"alert_manager","","",,"{""edgeId"": ""967"", ""linkId"": ""2113"", ""interface"": ""GE4""}",,,202040663,medium,"07ef70db-3b01-4663-b7a9-69cb73e64780",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636077780_1351_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040663 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184bc337c6d6919ea6b21c7,"OPEN - GENERAL - V3",1636095004,1636088403,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,,202040637,medium,"b9d378d9-6bab-4579-8568-99257f035572",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636088880_1711_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184bc347c6d6919ea6b21ca,"OPEN - GENERAL - V3",1636089003,1636088704,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",,,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"8ab6c8b4-6918-49c5-a70b-f85d86029836",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636088880_1711_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184c469506b931a29305efc,"OPEN - GENERAL - V3",1636091103,1636090804,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",,,202040640,high,"6cf72447-c5e0-4746-b620-eca019d47440",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636090980_1703_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6184cb717c6d6919ea6b21f4,"OPEN - GENERAL - V3",1636093503,1636092604,"alert_manager","","",,"{""edgeId"": ""415"", ""linkId"": ""1112"", ""interface"": ""GE3""}",,,20197421,medium,"d941bdcd-016d-47c5-afc1-63c0deb9bf09",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636092780_1839_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197421 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184e2e27c6d6919ea6b2217,"OPEN - GENERAL - V3",1636098904,1636098603,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,,202040643,high,"e1e7a7c2-8176-421d-a219-662f4a36e1d4",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636098780_2033_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6184f6cb506b931a29305f21,"OPEN - GENERAL - V3",1636104003,1636103703,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",,,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"0914ac3b-5fda-4e67-843c-81edd80cf040",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636103880_2107_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6184f7fa86272b76bd5653d4,"OPEN - GENERAL - V3",1636106403,1636104003,"alert_manager","","",,"{""edgeId"": ""433"", ""linkId"": ""1019"", ""interface"": ""GE3""}","N/A",,20197420,high,"fbadaa6c-397f-4291-8f6e-d227082f7b62",433,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636104180_2164_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197420 - Edge 433 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6184f9237c6d6919ea6b2238,"OPEN - GENERAL - V3",1636106403,1636104303,"alert_manager","","",,"{""edgeId"": ""433"", ""linkId"": ""1019"", ""interface"": ""GE3""}",,,20197420,medium,"0c6dfc45-ad2f-476a-a134-ae4560e34e98",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636104480_2215_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197420 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6184f9247c6d6919ea6b223a,"OPEN - GENERAL - V3",1636106703,1636104303,"alert_manager","","",,"{""edgeId"": ""433"", ""linkId"": ""1051"", ""interface"": ""GE4""}",,,20197420,medium,"8480ece9-c45b-47e5-ad21-022aee9c2d8f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636104480_2215_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197420 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6184fb7c86272b76bd5653d9,"OPEN - GENERAL - V3",1636106703,1636104603,"alert_manager","","",,"{""edgeId"": ""433"", ""linkId"": ""1019"", ""interface"": ""GE3""}","N/A",,20197420,medium,"0f90f075-488b-4ceb-87d2-aa41ebaa2998",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636105080_2190_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197420 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6184fb7d86272b76bd5653db,"OPEN - GENERAL - V3",1636107003,1636104603,"alert_manager","","",,"{""edgeId"": ""433"", ""linkId"": ""1051"", ""interface"": ""GE4""}",,,20197420,medium,"7fdde9ef-d8ae-4aef-8609-29fd779263c7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636105080_2190_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197420 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6185098c7c6d6919ea6b2253,"OPEN - GENERAL - V3",1636108803,1636108503,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1582"", ""interface"": ""GE3""}",,,202058019,medium,"276cd314-c573-4ad0-ac4b-41cb640ef00d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636108680_2356_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058019 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6185098d7c6d6919ea6b2255,"OPEN - GENERAL - V3",1636108803,1636108503,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1583"", ""interface"": ""GE4""}",,,202058019,medium,"26944106-98d4-4677-bd02-7a30e0c80bfb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636108680_2356_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058019 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6185098f7c6d6919ea6b2259,"OPEN - GENERAL - V3",1636108803,1636108503,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1582"", ""interface"": ""GE3""}",,,202058019,high,"b72fb85e-85c4-4c0c-ada6-b0dfb73d0760",465,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636108680_2356_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202058019 - Edge 465 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61850ab87c6d6919ea6b225e,"OPEN - GENERAL - V3",1636109102,1636108803,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"326407b8-fdc0-4a3e-8946-323b2b582d51",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636108980_2365_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6185167186272b76bd565411,"OPEN - GENERAL - V3",1636117205,1636111502,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"8953629e-8f95-4edf-83b5-560e6b3172a8",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636111980_2408_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618520fb86272b76bd565423,"OPEN - GENERAL - V3",1636124704,1636114203,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""4076"", ""interface"": ""GE4""}","N/A",,202062003,performance,"59eea4e2-6351-4e80-a104-e86fdf0c7011",4076,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636114680_2488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202062003 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",618520fd86272b76bd565426,"OPEN - GENERAL - V3",1636114802,1636114504,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}","N/A",,20197447,medium,"4beb17fb-ecf5-44c7-916b-4c88a06c4645",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636114680_2488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61852228506b931a29305f56,"OPEN - GENERAL - V3",1636116002,1636114802,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,,202046760,medium,"8d5bd739-583c-4fc0-8b6f-dea2ca6a8a6e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636114980_2466_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046760 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61852228506b931a29305f58,"OPEN - GENERAL - V3",1636115702,1636114802,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""4011"", ""interface"": ""GE3""}",,,202046760,medium,"7d63c24b-6daf-4338-a356-777cc4cca781",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636114980_2466_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046760 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6185222d506b931a29305f5e,"OPEN - GENERAL - V3",1636116002,1636114802,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,,202046760,high,"a1dfd9d1-4a13-4e1a-91e7-ce40c6bf57bb",1119,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636114980_2466_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202046760 - Edge 1119 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618524807c6d6919ea6b2284,"OPEN - GENERAL - V3",1636116303,1636115102,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,,202046760,medium,"5e285273-15a6-4ddb-968d-5d0f4ab8bf2b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636115580_2582_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046760 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618524817c6d6919ea6b2286,"OPEN - GENERAL - V3",1636116002,1636115102,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""4011"", ""interface"": ""GE3""}",,,202046760,medium,"8c2f0866-0249-43dc-a947-9910190e6e76",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636115580_2582_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046760 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61852a617c6d6919ea6b229a,"OPEN - GENERAL - V3",1636117205,1636116902,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,high,"a971e6c1-a4a2-4b53-8b9b-ffb30049bc20",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636117080_2630_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61852ddf506b931a29305f77,"OPEN - GENERAL - V3",1636118704,1636117803,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}",,,202061985,medium,"61358980-4cbf-4d07-993c-49903ae56b8e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636117980_2555_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061985 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61852de0506b931a29305f79,"OPEN - GENERAL - V3",1636118102,1636117803,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4123"", ""interface"": ""GE3""}",,,202061985,medium,"16798800-849d-4f86-a020-89fb902493c6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636117980_2555_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061985 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61852de4506b931a29305f7e,"OPEN - GENERAL - V3",1636118102,1636117803,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}",,,202061985,high,"51cc7833-8b01-472f-9b6b-b7c9a7abce82",1563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636117980_2555_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202061985 - Edge 1563 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618530375c80646aec1ee032,"OPEN - GENERAL - V3",1636134602,1636118102,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,,202162229,performance,"5815ebc5-7982-460b-897f-7d47b7eae59e",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636118580_8_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",618530395c80646aec1ee035,"OPEN - GENERAL - V3",1636119002,1636118102,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}","N/A",,202061985,medium,"0565f8a9-a71e-4bc3-9c32-f2b53c6db696",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636118580_8_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061985 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6185303b5c80646aec1ee039,"OPEN - GENERAL - V3",1636132202,1636118102,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,performance,"dbdf5f4c-3a89-4e43-8c65-85fe91ea690b",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636118580_8_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618534ec5c80646aec1ee04e,"OPEN - GENERAL - V3",1636119903,1636119603,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,,null,high,"7682b5a5-e5c6-4e15-a474-7c56bcd2d851",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636119780_48_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61854c5a506b931a29305fd3,"OPEN - GENERAL - V3",1636125904,1636125603,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",,,202040640,high,"9de704ed-a041-4873-a168-3718799cf653",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636125780_2807_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618555b8506b931a29305fd8,"OPEN - GENERAL - V3",1636128302,1636128005,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"fa755a8c-9bc7-4f53-bcb9-60a97965073e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636128180_2889_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618562a07c6d6919ea6b22ea,"OPEN - GENERAL - V3",1636131604,1636131303,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,,202162229,high,"7311a328-73ad-4d65-ab57-553fa33ee9a4",1566,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636131480_3102_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202162229 - Edge 1566 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618563c7506b931a29305fe9,"OPEN - GENERAL - V3",1636131902,1636131604,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"fe280616-51b2-4802-82a5-933058dd50e3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636131780_2995_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São Leopoldo","GERDAU AÇOS LONGOS S A","155345.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041382,BAIXO,SDWAN,61856d287c6d6919ea6b22f7,"OPEN - GENERAL - V3",1636134304,1636134002,"alert_manager","","",,"{""edgeId"": ""1001"", ""linkId"": ""2125"", ""interface"": ""GE4""}",,,202041382,medium,"1e785e42-796e-4912-8a35-64df0a843454",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636134180_3191_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041382 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Rio Verde","GERDAU AÇOS LONGOS S A","155343.0000000",GO,"N/A","SDWAN - VELOCLOUD",202041380,BAIXO,SDWAN,61856e567c6d6919ea6b22ff,"OPEN - GENERAL - V3",1636134602,1636134304,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,,202041380,high,"4d3056c5-65b6-4843-b9c4-a20272a71e2a",998,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636134480_3200_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041380 - Edge 998 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618574317c6d6919ea6b230b,"OPEN - GENERAL - V3",1636136103,1636135803,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,,202162229,high,"9f78bc55-5089-4203-b7b2-77387bcaf3c1",1566,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636135980_3254_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202162229 - Edge 1566 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618574327c6d6919ea6b230d,"OPEN - GENERAL - V3",1636136103,1636135803,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,high,"83ee9202-c35a-47e8-b37b-1078f6fe4b83",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636135980_3254_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61857686506b931a29305ff9,"OPEN - GENERAL - V3",1636148103,1636136103,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,,202162229,performance,"28c71fdf-ca99-4a02-ba0c-e4209d6da755",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636136580_3137_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","Rio Verde","GERDAU AÇOS LONGOS S A","155343.0000000",GO,"N/A","SDWAN - VELOCLOUD",202041380,BAIXO,SDWAN,61857b3a3ff371263162ee07,"OPEN - GENERAL - V3",1636137903,1636137603,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}","N/A",,202041380,high,"c2dd8edf-785c-4384-b67e-b3b0309aaa0d",998,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636137780_193_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041380 - Edge 998 entrou em status DEGRADED",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61857ebd506b931a2930600d,"OPEN - GENERAL - V3",1636138803,1636138503,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,,202040644,high,"d21fafd3-d55d-40b2-9d46-eb07db43b3b8",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636138680_3202_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não",Umuarama,"GERDAU AÇOS LONGOS S A","154768.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040629,BAIXO,SDWAN,61857fe87c6d6919ea6b2315,"OPEN - GENERAL - V3",1636139104,1636138803,"alert_manager","","",,"{""edgeId"": ""1008"", ""linkId"": ""2042"", ""interface"": ""GE3""}",,,202040629,medium,"a8245023-232f-4040-ae4a-28668276201d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636138980_3351_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040629 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Umuarama,"GERDAU AÇOS LONGOS S A","154768.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040629,BAIXO,SDWAN,61857fe97c6d6919ea6b2317,"OPEN - GENERAL - V3",1636139104,1636138803,"alert_manager","","",,"{""edgeId"": ""1008"", ""linkId"": ""2044"", ""interface"": ""GE4""}",,,202040629,medium,"ab9228d9-5fba-4b13-8e23-190a9ec125d6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636138980_3351_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040629 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Umuarama,"GERDAU AÇOS LONGOS S A","154768.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040629,BAIXO,SDWAN,61857fed7c6d6919ea6b231b,"OPEN - GENERAL - V3",1636139104,1636138803,"alert_manager","","",,"{""edgeId"": ""1008"", ""linkId"": ""2042"", ""interface"": ""GE3""}",,,202040629,high,"0b93c26a-0d23-4fc0-979e-ef3ba05903bb",1008,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636138980_3351_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040629 - Edge 1008 entrou em status OFFLINE",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,6185836c3ff371263162ee11,"OPEN - GENERAL - V3",1636140003,1636139704,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}",,,202040644,medium,"537ff33f-31dd-4a2c-a66b-ec908adac432",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636139880_265_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Ladário","PB LOPES & CIA LTDA","170046.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059978,SDWAN,SDWAN,61858ccc3ff371263162ee26,"OPEN - GENERAL - V3",1636142405,1636142150,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}",,,202059978,medium,"8c4d4ba1-01e9-4837-89a6-2902b9f15f08",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636142280_351_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059978 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Maringá","PB LOPES & CIA LTDA","170041.0000000",PR,"N/A","SDWAN - VELOCLOUD",202059973,SDWAN,SDWAN,618592ab7c6d6919ea6b232a,"OPEN - GENERAL - V3",1636157402,1636143603,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}",,,202059973,high,"f2b577c1-8355-4643-8509-67f4638e38e7",1264,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636143780_3501_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059973 - Edge 1264 entrou em status DEGRADED",86400,high
"Não","Maringá","PB LOPES & CIA LTDA","170041.0000000",PR,"N/A","SDWAN - VELOCLOUD",202059973,SDWAN,SDWAN,618593d3506b931a29306022,"OPEN - GENERAL - V3",1636157402,1636143903,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}",,,202059973,medium,"f39cc1cc-5217-426d-9ac7-80fda2f65c83",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636144080_3364_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059973 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Maringá","PB LOPES & CIA LTDA","170041.0000000",PR,"N/A","SDWAN - VELOCLOUD",202059973,SDWAN,SDWAN,618595043ff371263162ee3b,"OPEN - GENERAL - V3",1636157703,1636143903,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}",,,202059973,high,"13f54f77-003c-42ad-911c-48ccff436749",1264,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636144380_418_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059973 - Edge 1264 entrou em status OFFLINE",86400,high
"Não","Maringá","PB LOPES & CIA LTDA","170041.0000000",PR,"N/A","SDWAN - VELOCLOUD",202059973,SDWAN,SDWAN,6185962b7c6d6919ea6b232e,"OPEN - GENERAL - V3",1636157703,1636144204,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}",,,202059973,medium,"ab6bcf07-d0d6-4cb9-8c31-a0bb5c0bb9c3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636144680_3532_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059973 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,61859d353ff371263162ee47,"OPEN - GENERAL - V3",1636146603,1636146303,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"7bfccb82-9e99-4a3d-a8af-7f3e9d3ed3d1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636146480_490_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6185a8ef506b931a29306043,"OPEN - GENERAL - V3",1636479305,1636149303,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",,,202061989,high,"dec6620e-fbae-456e-9ba1-cdf942586a85",1567,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636149480_3538_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202061989 - Edge 1567 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6185aa18506b931a29306047,"OPEN - GENERAL - V3",1636479305,1636149603,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",,,202061989,medium,"309f1f6e-7890-4832-a769-aecb151fbcdf",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636149780_3547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061989 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Recife,"ICATU SEGUROS S.A","159551.0000000",PE,"N/A","SDWAN - VELOCLOUD",202046760,"ABORDAGEM SIMPLES",SDWAN,6185ab463ff371263162ee5f,"OPEN - GENERAL - V3",1636150503,1636149603,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,,202046760,performance,"a4d6742e-449c-433a-868f-f07b56c0ec6f",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636150080_608_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6185ac703ff371263162ee66,"OPEN - GENERAL - V3",1636479603,1636149903,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}","N/A",,202061989,medium,"6fb4b7a1-abba-4aaf-bf29-22d59d082fd2",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636150380_617_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061989 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6185c05e7c6d6919ea6b238c,"OPEN - GENERAL - V3",1636180502,1636155004,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"b6dd63e2-267f-434d-9768-406daeed33c1",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636155480_3888_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6185c2b6506b931a29306075,"OPEN - GENERAL - V3",1636156203,1636155902,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,,202162229,high,"21412749-ada9-4d91-b732-462e1dc00162",1566,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636156080_3738_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202162229 - Edge 1566 entrou em status OFFLINE",86400,high
"Não",Dourados,"GERDAU AÇOS LONGOS S A","154962.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040660,BAIXO,SDWAN,6185c638506b931a2930607b,"OPEN - GENERAL - V3",1636165803,1636156803,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2196"", ""interface"": ""GE4""}",,,202040660,medium,"cf0bc298-3277-430a-b73d-a19ca7ffd199",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636156980_3770_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040660 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Recife,"ICATU SEGUROS S.A","159551.0000000",PE,"N/A","SDWAN - VELOCLOUD",202046760,"ABORDAGEM SIMPLES",SDWAN,6185c639506b931a2930607d,"OPEN - GENERAL - V3",1636166703,1636156504,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,,202046760,performance,"a37c2a3e-5254-440f-9a8c-2eedbe8fdd03",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636156980_3770_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Caruaru,"GERDAU AÇOS LONGOS S A","154938.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040637,BAIXO,SDWAN,6185d8f7506b931a293060b9,"OPEN - GENERAL - V3",1636161904,1636161602,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,,202040637,medium,"28f236cd-4f71-4a51-900a-25158d96e918",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636161780_3924_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6185db523ff371263162eeb7,"OPEN - GENERAL - V3",1636182902,1636161904,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}",,,202062009,performance,"03d9bff7-e6a9-43a7-bed8-20e2fb17a7dd",5422,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636162380_991_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062009 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Caruaru,"GERDAU AÇOS LONGOS S A","154938.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040637,BAIXO,SDWAN,6185f067506b931a293060d9,"OPEN - GENERAL - V3",1636197004,1636167604,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,,202040637,medium,"59694150-9626-4722-a1ce-58b78f3b5102",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636167780_4107_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,6185fe7b506b931a293060f8,"OPEN - GENERAL - V3",1636177504,1636171204,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}",,,202040638,high,"f4895de0-472d-439e-bf26-9d9c6b72eeee",962,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636171380_4213_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040638 - Edge 962 entrou em status DEGRADED",86400,high
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,6185ffa53ff371263162eef1,"OPEN - GENERAL - V3",1636192502,1636171503,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}",,,202040638,medium,"7fe2fd94-df8b-4ddd-b273-c0868ba899b7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636171680_1297_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040638 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,6185ffa53ff371263162eef3,"OPEN - GENERAL - V3",1636177504,1636171503,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2609"", ""interface"": ""GE3""}",,,202040638,medium,"6d7b0c3d-6c90-4c4b-8a94-a22b483ab2d3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636171680_1297_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040638 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,618600d63ff371263162ef02,"OPEN - GENERAL - V3",1636178104,1636171503,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}","N/A",,202040638,high,"2784d9c4-ae6a-491f-a1c3-a9b81ba73b6d",962,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636171980_1310_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040638 - Edge 962 entrou em status OFFLINE",86400,high
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,618601fd7c6d6919ea6b2418,"OPEN - GENERAL - V3",1636192803,1636171804,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}",,,202040638,medium,"edd7b326-cb11-4081-a144-78f93db13141",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636172280_4461_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040638 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,618601fe7c6d6919ea6b241a,"OPEN - GENERAL - V3",1636177802,1636171804,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2609"", ""interface"": ""GE3""}",,,202040638,medium,"b2e083a7-d2e8-4d0e-96b9-17bdad33bde6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636172280_4461_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040638 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,61860ee03ff371263162ef26,"OPEN - GENERAL - V3",1636175704,1636175403,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","N/A",,20197450,medium,"4502bae5-effb-4576-ba46-a2f252b57ebe",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636175580_1427_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,618612667c6d6919ea6b2444,"OPEN - GENERAL - V3",1636176602,1636176304,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,,202040669,medium,"be7b40bc-3ddf-48a3-93be-6280faaec396",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636176480_4597_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,61861e1d3ff371263162ef52,"OPEN - GENERAL - V3",1636192204,1636179303,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2609"", ""interface"": ""GE3""}",,,202040638,medium,"b463d672-3a82-4458-b1dd-605b72fd975d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636179480_1555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040638 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,61861e213ff371263162ef57,"OPEN - GENERAL - V3",1636192502,1636179303,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}",,,202040638,high,"6ef0938f-6e38-49a4-ac8e-25a8f5fc452f",962,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636179480_1555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040638 - Edge 962 entrou em status OFFLINE",86400,high
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,61862074506b931a29306145,"OPEN - GENERAL - V3",1636192502,1636179604,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2609"", ""interface"": ""GE3""}",,,202040638,medium,"efcc5e28-7b8a-49a0-9055-01e976e93661",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636180080_4489_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040638 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Ribeirão Preto","ICATU SEGUROS S.A","171686.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062011,"ABORDAGEM SIMPLES",SDWAN,61862d573ff371263162ef88,"OPEN - GENERAL - V3",1636183504,1636183202,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,,202062011,medium,"d3f3a275-8d63-459a-9c6f-d99ad7c711fa",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636183380_1682_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6186358d7c6d6919ea6b248f,"OPEN - GENERAL - V3",1636479305,1636185302,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,medium,"cb812008-5e5b-4b2a-8ff1-3762753bf6eb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636185480_4882_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""cb812008-5e5b-4b2a-8ff1-3762753bf6eb"", ""Descricao"": ""__201749053 --- 2021nov08/TESTE 1, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",closed,"","",2,"202041369 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6186358e7c6d6919ea6b2491,"OPEN - GENERAL - V3",1636479305,1636185302,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",,,202041369,medium,"c55efb27-4bb2-4ed6-b16e-3c0216a92839",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636185480_4882_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""c55efb27-4bb2-4ed6-b16e-3c0216a92839"", ""Descricao"": ""__201749053 --- 2021nov08/TESTE 2, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",closed,"","",2,"202041369 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618635917c6d6919ea6b2495,"OPEN - GENERAL - V3",1636479305,1636185302,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,high,"e978ad23-ee4b-404c-9f48-139cbd97a269",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636185480_4882_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""e978ad23-ee4b-404c-9f48-139cbd97a269"", ""Descricao"": ""__201749053 --- 2021nov08/TESTE 3, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",closed,"","",1,"202041369 - Edge 986 entrou em status OFFLINE",86400,high
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618637e57c6d6919ea6b249c,"OPEN - GENERAL - V3",1636479603,1636185604,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,medium,"883532aa-de5e-4f14-865e-49ac3d790723",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636186080_4901_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618637e67c6d6919ea6b249e,"OPEN - GENERAL - V3",1636479603,1636185604,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",,,202041369,medium,"a054caec-24ea-4ab8-adb0-f2a0955c5353",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636186080_4901_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Barão de Cocais","GERDAU AÇOS LONGOS S A","154950.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040643,BAIXO,SDWAN,618652db506b931a293061cf,"OPEN - GENERAL - V3",1636193404,1636192803,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,,202040643,high,"ea807d6c-bfba-4430-930c-2cc39f2ba282",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636192980_4907_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61865fbf3ff371263162efe0,"OPEN - GENERAL - V3",1636479305,1636195804,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"42f9c238-814f-42f9-8971-9b947caa912a",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636196280_2081_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6186633f3ff371263162eff7,"OPEN - GENERAL - V3",1636197302,1636197004,"alert_manager","","",,"{""edgeId"": ""1583"", ""linkId"": ""4387"", ""interface"": ""GE4""}",,,202062015,medium,"0a9c4b95-cfcd-44eb-9662-d7ed21194441",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636197180_2109_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062015 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Recife,"ICATU SEGUROS S.A","159551.0000000",PE,"N/A","SDWAN - VELOCLOUD",202046760,"ABORDAGEM SIMPLES",SDWAN,618663413ff371263162effa,"OPEN - GENERAL - V3",1636204804,1636196703,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}","N/A",,202046760,performance,"ba548613-c9e4-4cf1-9014-611f0f4a90dc",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636197180_2109_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Marília","GERDAU AÇOS LONGOS S A","154767.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040628,BAIXO,SDWAN,61866a47506b931a293061f5,"OPEN - GENERAL - V3",1636212004,1636198804,"alert_manager","","",,"{""edgeId"": ""980"", ""linkId"": ""3119"", ""interface"": ""GE4""}",,,202040628,medium,"3454d383-b130-4346-90b4-54eacec034e4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636198980_5096_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040628 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61866a4a506b931a293061fa,"OPEN - GENERAL - V3",1636230304,1636198804,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}",,,null,high,"bdb69583-6be1-4e47-a634-be6024647da3",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636198980_5096_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 2104 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61866b74506b931a293061fe,"OPEN - GENERAL - V3",1636230304,1636199103,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}",,,null,medium,"bfa3a7b4-e67a-43c0-9b63-5766ab761b22",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636199280_5105_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Marília","GERDAU AÇOS LONGOS S A","154767.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040628,BAIXO,SDWAN,61866b74506b931a29306200,"OPEN - GENERAL - V3",1636220703,1636199103,"alert_manager","","",,"{""edgeId"": ""980"", ""linkId"": ""2477"", ""interface"": ""GE3""}",,,202040628,medium,"701958a6-117e-4e9b-8d59-f66bba9d14bf",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636199280_5105_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040628 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Marília","GERDAU AÇOS LONGOS S A","154767.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040628,BAIXO,SDWAN,61866b7a506b931a29306207,"OPEN - GENERAL - V3",1636220703,1636199103,"alert_manager","","",,"{""edgeId"": ""980"", ""linkId"": ""2477"", ""interface"": ""GE3""}",,,202040628,high,"d308e1c9-5bbc-40e6-a247-0221085aa721",980,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636199280_5105_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040628 - Edge 980 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61866ca67c6d6919ea6b2537,"OPEN - GENERAL - V3",1636479305,1636199103,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}",,,null,high,"e01d0bd2-1cd5-4f74-af69-cbff36f89aa0",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636199580_5364_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61866dcb506b931a2930620c,"OPEN - GENERAL - V3",1636230602,1636199404,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}",,,null,medium,"5e1c288a-506b-421d-807f-2cbf3c9ba8b0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636199880_5127_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Marília","GERDAU AÇOS LONGOS S A","154767.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040628,BAIXO,SDWAN,61866dcc506b931a2930620e,"OPEN - GENERAL - V3",1636221004,1636199404,"alert_manager","","",,"{""edgeId"": ""980"", ""linkId"": ""2477"", ""interface"": ""GE3""}",,,202040628,medium,"85a42959-18ee-4501-b27f-b6f1db59bfea",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636199880_5127_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040628 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Ribeirão Preto","ICATU SEGUROS S.A","171686.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062011,"ABORDAGEM SIMPLES",SDWAN,618670233ff371263162f00e,"OPEN - GENERAL - V3",1636200602,1636200302,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,,202062011,medium,"14ff6f3d-fb37-42f4-88c8-5df6f18ac6a9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636200480_2210_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,6186727e3ff371263162f01f,"OPEN - GENERAL - V3",1636201203,1636200903,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"444ddf2a-b949-4963-9b50-3fe6d0a4892f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636201080_2229_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618674d43ff371263162f035,"OPEN - GENERAL - V3",1636201803,1636201503,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3692"", ""interface"": ""GE1""}",,,202058024,medium,"2e955b03-7dc4-42c5-ac73-be62772f67c8",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636201680_2248_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6186785f7c6d6919ea6b254f,"OPEN - GENERAL - V3",1636202703,1636202402,"alert_manager","","",,"{""edgeId"": ""463"", ""linkId"": ""1575"", ""interface"": ""GE3""}",,,202058026,high,"f389b8f2-f33a-4ea6-8b15-b7a6384f62c6",463,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636202580_5466_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202058026 - Edge 463 entrou em status DEGRADED",86400,high
"Não","Belo Horizonte","BANCO LOSANGO S.A. - BANCO MULTIPLO","133300.0000000",MG,"N/A",BRAD,20197426,LOSANGO,SDWAN,61867bdd3ff371263162f058,"OPEN - GENERAL - V3",1636203603,1636203304,"alert_manager","","",,"{""edgeId"": ""418"", ""linkId"": ""1013"", ""interface"": ""GE3""}",,,20197426,medium,"ba2eddb9-4542-4ff6-a554-44b6ba18a28b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636203480_2302_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197426 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618681bc7c6d6919ea6b257b,"OPEN - GENERAL - V3",1636205102,1636204804,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,high,"316ce67c-bde1-46e4-8551-c40d6d351ae6",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636204980_5545_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618682e3506b931a2930622e,"OPEN - GENERAL - V3",1636557904,1636205102,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,medium,"a4cebe61-1bc9-4626-a934-d19bf107bc7a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636205280_5299_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618684117c6d6919ea6b2583,"OPEN - GENERAL - V3",1636205702,1636205404,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"4bdb2a69-9b5b-4c8a-b641-824bae0e90e2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636205580_5565_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618686683ff371263162f07b,"OPEN - GENERAL - V3",1636206303,1636206002,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","N/A",,20197450,medium,"c63b149c-7ef5-45f4-9008-b98e3019bafa",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636206180_2388_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61868b1d7c6d6919ea6b2593,"OPEN - GENERAL - V3",1636207802,1636207203,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,high,"46cd6a96-3969-4473-aef4-15acff0a30e6",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636207380_5624_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","Rio de Janeiro","PARKJACAREPAGUA EMPREENDIMENTO IMOBILIARIO LTDA","182725.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202188378,LOJA,SDWAN,61868c457c6d6919ea6b259b,"OPEN - GENERAL - V3",1636209603,1636207503,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",,,202188378,medium,"4bf3609f-1787-42cc-a6fb-b13db7665d1c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636207680_5632_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Rio de Janeiro","PARKJACAREPAGUA EMPREENDIMENTO IMOBILIARIO LTDA","182725.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202188378,LOJA,SDWAN,61868c467c6d6919ea6b259d,"OPEN - GENERAL - V3",1636209603,1636207503,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",,,202188378,medium,"92e1c5cf-b73e-42a8-9810-10bd308b4160",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636207680_5632_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Rio de Janeiro","PARKJACAREPAGUA EMPREENDIMENTO IMOBILIARIO LTDA","182725.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202188378,LOJA,SDWAN,61868d787c6d6919ea6b25b1,"OPEN - GENERAL - V3",1636209603,1636207802,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",,,202188378,high,"ec0f4187-a8a1-4c43-ac86-30c743d47092",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636207980_5641_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202188378 - Edge 2107 entrou em status OFFLINE",86400,high
"Não","Rio de Janeiro","PARKJACAREPAGUA EMPREENDIMENTO IMOBILIARIO LTDA","182725.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202188378,LOJA,SDWAN,61868fc93ff371263162f0a9,"OPEN - GENERAL - V3",1636209904,1636208104,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",,,202188378,medium,"b9dbd18b-84c5-4c70-93bd-5963b22afd09",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636208580_2469_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Rio de Janeiro","PARKJACAREPAGUA EMPREENDIMENTO IMOBILIARIO LTDA","182725.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202188378,LOJA,SDWAN,61868fca3ff371263162f0ab,"OPEN - GENERAL - V3",1636209904,1636208104,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",,,202188378,medium,"b0296af6-9320-4860-a34f-83bcf03b3031",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636208580_2469_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Rio de Janeiro","BANCO LOSANGO S.A. - BANCO MULTIPLO","133347.0000000",RJ,"N/A",BRAD,20197447,LOSANGO,SDWAN,618690f5506b931a29306251,"OPEN - GENERAL - V3",1636209003,1636208703,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,,20197447,medium,"af4a968e-6e7f-4c49-922e-62eedb9921d2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636208880_5412_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6186a738506b931a29306286,"OPEN - GENERAL - V3",1636214703,1636214403,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}",,,202062023,medium,"2d624cdf-df44-4d90-8475-7cbecb0ddcd8",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636214580_5596_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","Marília","GERDAU AÇOS LONGOS S A","154767.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040628,BAIXO,SDWAN,6186b54b7c6d6919ea6b25f0,"OPEN - GENERAL - V3",1636218303,1636218003,"alert_manager","","",,"{""edgeId"": ""980"", ""linkId"": ""3119"", ""interface"": ""GE4""}",,,202040628,high,"3a2ed453-bf66-4b47-91c8-8c437a093b70",980,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636218180_5992_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040628 - Edge 980 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6186b8ce7c6d6919ea6b25f6,"OPEN - GENERAL - V3",1636219203,1636218903,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,high,"9e8cb26f-67b4-444f-aa4e-07e6ccf30eb5",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636219080_6021_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","Porto Alegre","ICATU SEGUROS S.A.","184103.0000000",RS,"N/A","SDWAN - VELOCLOUD",202191967,"ABORDAGEM SIMPLES",SDWAN,6186bd7f3ff371263162f102,"OPEN - GENERAL - V3",1636220404,1636220103,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5547"", ""interface"": ""GE5""}",,,202191967,high,"2d107593-1a4c-43d9-8ddb-0e09a36616b0",2152,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636220280_2827_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202191967 - Edge 2152 entrou em status DEGRADED",86400,high
"Não","Cuiabá","BANCO LOSANGO S.A. - BANCO MULTIPLO","133302.0000000",MT,"N/A",BRAD,20197427,LOSANGO,SDWAN,6186c1007c6d6919ea6b25fe,"OPEN - GENERAL - V3",1636221303,1636221004,"alert_manager","","",,"{""edgeId"": ""413"", ""linkId"": ""1075"", ""interface"": ""GE4""}",,,20197427,medium,"846df7a7-56db-4c97-ac8c-add2d4b276d2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636221180_6092_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197427 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Recife,"ICATU SEGUROS S.A","159551.0000000",PE,"N/A","SDWAN - VELOCLOUD",202046760,"ABORDAGEM SIMPLES",SDWAN,6186c1017c6d6919ea6b2600,"OPEN - GENERAL - V3",1636228804,1636220703,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,,202046760,performance,"97cc62df-c06c-4df6-9dcf-0683c7efcb41",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636221180_6092_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Campo Grande","PB LOPES & CIA LTDA","170045.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059977,SDWAN,SDWAN,6186c3577c6d6919ea6b2605,"OPEN - GENERAL - V3",1636222204,1636221604,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",,,202059977,medium,"d421ce3a-1f49-4c7b-b692-81d3bcbb0bf2",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636221780_6112_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Campo Grande","PB LOPES & CIA LTDA","170045.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059977,SDWAN,SDWAN,6186c35c7c6d6919ea6b260b,"OPEN - GENERAL - V3",1636221902,1636221604,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",,,202059977,high,"f010743e-ae89-4ece-b419-48c5ceffb3c3",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636221780_6112_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,6186d4ec3ff371263162f123,"OPEN - GENERAL - V3",1636226402,1636226102,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"562bae72-fd46-40cc-8608-2837d25f538a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636226280_3018_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Porto Alegre","ICATU SEGUROS S.A.","184103.0000000",RS,"N/A","SDWAN - VELOCLOUD",202191967,"ABORDAGEM SIMPLES",SDWAN,6186d8707c6d6919ea6b2624,"OPEN - GENERAL - V3",0,1636227002,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5547"", ""interface"": ""GE5""}",,,202191967,medium,"9bc88789-cd40-4541-b76e-6d6c4fac66b7",GE5,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636227180_6287_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202191967 - Link GE5 entrou em status DISCONNECTED",86400,medium
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,6186de4d3ff371263162f136,"OPEN - GENERAL - V3",1636228804,1636228502,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}","N/A",,202040638,medium,"4a06c52e-7099-4c83-ab96-4e6a14fbfec6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636228680_3092_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040638 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Guarapuava,"GERDAU AÇOS LONGOS S A","154966.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040664,BAIXO,SDWAN,6186e4283ff371263162f148,"OPEN - GENERAL - V3",1636479305,1636230002,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}","N/A",,202040664,medium,"f4232912-fb25-4770-87c3-a8007c453f08",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636230180_3142_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040664 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6186e7ac7c6d6919ea6b2648,"OPEN - GENERAL - V3",1636479305,1636230903,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}",,,null,medium,"5a222cd9-3273-4519-9f73-d0643f967925",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636231080_6416_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6186ea033ff371263162f157,"OPEN - GENERAL - V3",1636479603,1636231204,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,null,medium,"83454fa7-d592-4ffe-9ef8-8060dec0c8c8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636231680_3190_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Campo Grande","GERDAU AÇOS LONGOS S A","154946.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040654,BAIXO,SDWAN,618ab0cf3ff371263162f17a,"OPEN - GENERAL - V3",1636492205,1636479013,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""2779"", ""interface"": ""GE4""}","N/A",,202040654,medium,"0a0f6892-b30d-400e-ae98-dc37e69871a6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636479180_11119_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040654 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ab3273ff371263162f181,"OPEN - GENERAL - V3",1636485605,1636479305,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,,202162229,performance,"912cac2b-d9f0-413a-8c2b-a384b1faf169",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636479780_11141_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não",Caruaru,"GERDAU AÇOS LONGOS S A","154938.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040637,BAIXO,SDWAN,618ab4547c6d6919ea6b2661,"OPEN - GENERAL - V3",1636482005,1636479904,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,,202040637,medium,"c22394cb-4211-4179-aff9-8fbba3e5dd52",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636480080_14471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618ac00d3ff371263162f19a,"OPEN - GENERAL - V3",1636483204,1636482903,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"a26fa735-b7ab-408f-a0bb-6e2a7bbe3eba",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636483080_11253_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618ac4bd3ff371263162f1a1,"OPEN - GENERAL - V3",1636484407,1636484106,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5336"", ""interface"": ""GE2""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"eb2c22c7-fc9c-4078-b575-17d0befbbc8f",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636484280_11293_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","Rio Verde","GERDAU AÇOS LONGOS S A","155343.0000000",GO,"N/A","SDWAN - VELOCLOUD",202041380,BAIXO,SDWAN,618ac4be3ff371263162f1a4,"OPEN - GENERAL - V3",1636484407,1636484106,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}","N/A",,202041380,medium,"27b76d09-a16e-4abb-8e31-99502e2b4932",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636484280_11293_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041380 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Rio Verde","GERDAU AÇOS LONGOS S A","155343.0000000",GO,"N/A","SDWAN - VELOCLOUD",202041380,BAIXO,SDWAN,618ac4bf3ff371263162f1a6,"OPEN - GENERAL - V3",1636484407,1636484106,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2603"", ""interface"": ""GE4""}","N/A",,202041380,medium,"c17f69d0-de5e-4c20-b58d-8574ceeb9bd7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636484280_11293_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041380 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Rio Verde","GERDAU AÇOS LONGOS S A","155343.0000000",GO,"N/A","SDWAN - VELOCLOUD",202041380,BAIXO,SDWAN,618ac4c23ff371263162f1a9,"OPEN - GENERAL - V3",1636484407,1636484106,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}","N/A",,202041380,high,"4dbba2c3-1168-436d-9b3f-07692181e2b0",998,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636484280_11293_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041380 - Edge 998 entrou em status OFFLINE",86400,high
"Não","Rio Verde","GERDAU AÇOS LONGOS S A","155343.0000000",GO,"N/A","SDWAN - VELOCLOUD",202041380,BAIXO,SDWAN,618ac716506b931a293062f4,"OPEN - GENERAL - V3",1636485304,1636484704,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,,202041380,high,"dc767fe5-2530-4d96-9f95-1b226c91f20c",998,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636484880_14344_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041380 - Edge 998 entrou em status DEGRADED",86400,high
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618ac840506b931a293062fa,"OPEN - GENERAL - V3",1636485304,1636485006,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"308ca88a-2571-4d3d-bae5-7e3131cc8d22",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636485180_14356_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ac96d3ff371263162f1b0,"OPEN - GENERAL - V3",1636493704,1636485006,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}",,,202061983,performance,"6077d72e-cb07-42b2-a152-e62aed1aadea",4133,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636485480_11331_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061983 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Rio de Janeiro","BANCO LOSANGO S.A. - BANCO MULTIPLO","133309.0000000",RJ,"N/A",BRAD,20197431,LOSANGO,SDWAN,618acbc73ff371263162f1b8,"OPEN - GENERAL - V3",1636486202,1636485902,"alert_manager","","",,"{""edgeId"": ""423"", ""linkId"": ""1021"", ""interface"": ""GE3""}",,,20197431,high,"a988d0ff-cd51-41e8-a540-186af7be30b2",423,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636486080_11351_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197431 - Edge 423 entrou em status OFFLINE",86400,high
"Não","Barão de Cocais","GERDAU AÇOS LONGOS S A","154950.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040643,BAIXO,SDWAN,618accf2506b931a29306305,"OPEN - GENERAL - V3",1636486503,1636486202,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,,202040643,high,"8ac440d6-bb59-4d98-83c0-a731b3242917",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636486380_14391_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618ad523506b931a29306319,"OPEN - GENERAL - V3",1636488604,1636488305,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"2a304f14-8729-40b8-884a-ce76fc31c161",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636488480_14461_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618ad77c3ff371263162f1cd,"OPEN - GENERAL - V3",1636489203,1636488905,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"b1db90e8-32f4-4e91-a2ed-47b9ff4b4117",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636489080_11449_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ae3377c6d6919ea6b2695,"OPEN - GENERAL - V3",1636495203,1636491604,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"d338af9e-5445-4c71-a39d-f7b175af9162",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636492080_14863_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618ae45f3ff371263162f1e2,"OPEN - GENERAL - V3",1636492503,1636492205,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","N/A",,20197450,medium,"7814bca8-546e-4be0-be96-3d32e16f3df7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636492380_11558_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618af9797c6d6919ea6b26ad,"OPEN - GENERAL - V3",1636526405,1636497304,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"3e415eab-8773-4a6f-b57f-774740732b5d",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636497780_15044_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618b065c3ff371263162f20c,"OPEN - GENERAL - V3",1636501203,1636500905,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"0be94080-96ef-4390-aeae-e9f95d7bea29",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636501080_11833_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618b0fbb7c6d6919ea6b26bd,"OPEN - GENERAL - V3",1636503603,1636503303,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"d8e8ace7-9cd8-4774-a2b4-e90a329dd3c3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636503480_15220_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Caruaru,"GERDAU AÇOS LONGOS S A","154938.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040637,BAIXO,SDWAN,618b23a73ff371263162f23d,"OPEN - GENERAL - V3",1636548603,1636508402,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,,202040637,medium,"733c0218-a3f2-4f10-8d9d-9514324b5090",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636508580_12097_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Volta Redonda","GERDAU AÇOS LONGOS S A","154976.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202040674,BAIXO,SDWAN,618b3b177c6d6919ea6b26f9,"OPEN - GENERAL - V3",1636514704,1636514405,"alert_manager","","",,"{""edgeId"": ""1011"", ""linkId"": ""2084"", ""interface"": ""GE4""}",,,202040674,medium,"e73133e1-6d3e-4b3f-bb82-bcdb7822470d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636514580_15572_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040674 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618b47fc506b931a293063a5,"OPEN - GENERAL - V3",1636518005,1636517704,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"465f097c-1f2f-4497-8cda-6bd194519c32",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636517880_15401_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Campinas,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133349.0000000",SP,"N/A",BRAD,20197448,LOSANGO,SDWAN,618b4928506b931a293063ac,"OPEN - GENERAL - V3",1636518304,1636518005,"alert_manager","","",,"{""edgeId"": ""379"", ""linkId"": ""827"", ""interface"": ""GE3""}",,,20197448,medium,"c78f7287-a043-4294-accb-5fa661cd0d6e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636518180_15411_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197448 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Ribeirão Preto","ICATU SEGUROS S.A","171686.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062011,"ABORDAGEM SIMPLES",SDWAN,618b515b506b931a293063bc,"OPEN - GENERAL - V3",1636520404,1636520103,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,,202062011,medium,"a8431d23-1304-44da-9587-e3f7b33d7405",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636520280_15478_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618b528b7c6d6919ea6b272d,"OPEN - GENERAL - V3",1636521605,1636520404,"alert_manager","","",,"{""edgeId"": ""1573"", ""linkId"": ""4735"", ""interface"": ""GE4""}",,,202177775,high,"9b580913-9b05-4dd8-a3e4-741346583d0e",1573,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636520580_15757_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202177775 - Edge 1573 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618b53b47c6d6919ea6b2731,"OPEN - GENERAL - V3",1636521304,1636520703,"alert_manager","","",,"{""edgeId"": ""1573"", ""linkId"": ""4735"", ""interface"": ""GE4""}",,,202177775,medium,"896000f6-5dce-4d74-a523-8e2985cb496a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636520880_15767_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202177775 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618b54e43ff371263162f27b,"OPEN - GENERAL - V3",1636521903,1636520703,"alert_manager","","",,"{""edgeId"": ""1573"", ""linkId"": ""4735"", ""interface"": ""GE4""}","N/A",,202177775,high,"9a66b928-3afa-4e61-a353-b8ac058d5313",1573,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636521180_12512_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202177775 - Edge 1573 entrou em status OFFLINE",86400,high
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618b58643ff371263162f28b,"OPEN - GENERAL - V3",1636522205,1636521903,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"fd031353-20c9-4f55-b2e6-dd447b59936e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636522080_12541_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Blumenau,"GERDAU AÇOS LONGOS S A","154945.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040653,BAIXO,SDWAN,618b5e417c6d6919ea6b2744,"OPEN - GENERAL - V3",1636526703,1636523104,"alert_manager","","",,"{""edgeId"": ""1132"", ""linkId"": ""2802"", ""interface"": ""GE4""}",,,202040653,performance,"abe843cc-dc4b-41df-9805-c5a348a1df66",2802,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636523580_15845_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040653 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618b6b23506b931a293063e4,"OPEN - GENERAL - V3",1636527005,1636526703,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,,201922181,medium,"f5606548-0e39-44ef-b896-8028d10461fb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636526880_15699_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922181 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618b7a603ff371263162f2b4,"OPEN - GENERAL - V3",1636531204,1636530603,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",,,202062009,medium,"026e8838-d979-410e-941a-ffca847d7257",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636530780_12826_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618b7cb83ff371263162f2ba,"OPEN - GENERAL - V3",1636531504,1636531204,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4562"", ""interface"": ""GE3""}","N/A",,202061999,medium,"89b35195-e2d2-4870-bc6a-13c273c278c5",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636531380_12845_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061999 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618b803d7c6d6919ea6b276b,"OPEN - GENERAL - V3",1636532406,1636532104,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"b4363776-16ce-4198-b411-0962b84540c3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636532280_16126_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,618b86197c6d6919ea6b2779,"OPEN - GENERAL - V3",1636533905,1636533603,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}",,,202040644,medium,"1be81f20-1cc4-44b2-9ba2-8fbd978a9ded",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636533780_16176_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618b92fe7c6d6919ea6b279c,"OPEN - GENERAL - V3",1636550404,1636536604,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"d5c0e9c4-3fbb-4591-af58-2a65820c26d8",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636537080_16283_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Vitória da Conquista","GERDAU AÇOS LONGOS S A","154975.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040673,BAIXO,SDWAN,618ba6e73ff371263162f2e4,"OPEN - GENERAL - V3",1636542303,1636542005,"alert_manager","","",,"{""edgeId"": ""1010"", ""linkId"": ""2034"", ""interface"": ""GE4""}","N/A",,202040673,medium,"36e3737c-4a17-403e-8041-d3d1a5a8e654",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636542180_13186_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040673 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Barão de Cocais","GERDAU AÇOS LONGOS S A","154950.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040643,BAIXO,SDWAN,618bb2a33ff371263162f2fe,"OPEN - GENERAL - V3",1636545302,1636545002,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}","N/A",,202040643,high,"755410ac-f5ec-4c7d-965e-d4793faa8a54",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636545180_13284_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618bb87d7c6d6919ea6b27d8,"OPEN - GENERAL - V3",1636584003,1636546204,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""5301"", ""interface"": ""GE3""}",,,202062005,performance,"faf3c16a-15d5-4ec4-9168-ae64fa2ffc7d",5301,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636546680_16592_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062005 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618bbad37c6d6919ea6b27dd,"OPEN - GENERAL - V3",1636590004,1636546803,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,,202162229,performance,"b30b013d-9f77-4924-bef9-9875225aeb0e",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636547280_16611_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","Porto Alegre","SUB CONDOMINIO SHOPPINHG CENTER BARRASHOPPING SUL","155271.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041334,LOJA,SDWAN,618bc1dc3ff371263162f311,"OPEN - GENERAL - V3",1636550404,1636548904,"alert_manager","","",,"{""edgeId"": ""938"", ""linkId"": ""3387"", ""interface"": ""GE4""}",,,202041334,medium,"d08175d2-03a3-4d23-8c16-3adabc3e2b46",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636549080_13420_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041334 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Londrina,"GERDAU AÇOS LONGOS S A","155326.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041363,BAIXO,SDWAN,618bc68e3ff371263162f321,"OPEN - GENERAL - V3",1636550404,1636550103,"alert_manager","","",,"{""edgeId"": ""977"", ""linkId"": ""2156"", ""interface"": ""GE4""}",,,202041363,medium,"397686a5-68c6-40ba-b9d3-ac3ed3222930",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636550280_13460_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041363 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Londrina,"PB LOPES & CIA LTDA","170040.0000000",PR,"N/A","SDWAN - VELOCLOUD",202059972,SDWAN,SDWAN,618bc6923ff371263162f326,"OPEN - GENERAL - V3",1636550404,1636550103,"alert_manager","","",,"{""edgeId"": ""1295"", ""linkId"": ""3248"", ""interface"": ""GE1""}",,,202059972,high,"0d8410b7-2eb6-4f15-b6fe-9b0b3431948e",1295,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636550280_13460_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059972 - Edge 1295 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618bcc687c6d6919ea6b2801,"OPEN - GENERAL - V3",1636563302,1636551303,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,,202162229,performance,"e92cf7dd-2e01-47de-b6b5-bd1711ce2550",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636551780_16747_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Aracaju,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133319.0000000",SE,"N/A",BRAD,20197449,LOSANGO,SDWAN,618bcc6b7c6d6919ea6b2805,"OPEN - GENERAL - V3",1636554004,1636551603,"alert_manager","","",,"{""edgeId"": ""427"", ""linkId"": ""1030"", ""interface"": ""GE4""}",,,20197449,high,"cee3bee7-3e18-4b75-b583-d9939e954179",427,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636551780_16747_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197449 - Edge 427 entrou em status OFFLINE",86400,high
"Não",Aracaju,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133319.0000000",SE,"N/A",BRAD,20197449,LOSANGO,SDWAN,618bcd94506b931a29306456,"OPEN - GENERAL - V3",1636554004,1636551904,"alert_manager","","",,"{""edgeId"": ""427"", ""linkId"": ""1030"", ""interface"": ""GE4""}",,,20197449,medium,"8cfac308-bea3-4add-9557-1b05a744a083",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636552080_16512_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197449 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Aracaju,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133319.0000000",SE,"N/A",BRAD,20197449,LOSANGO,SDWAN,618bcd95506b931a29306458,"OPEN - GENERAL - V3",1636554004,1636551904,"alert_manager","","",,"{""edgeId"": ""427"", ""linkId"": ""911"", ""interface"": ""GE3""}",,,20197449,medium,"3bfd6195-8f43-4d28-b9ab-736c7a1aedc4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636552080_16512_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197449 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Aracaju,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133319.0000000",SE,"N/A",BRAD,20197449,LOSANGO,SDWAN,618bcfec506b931a29306462,"OPEN - GENERAL - V3",1636554302,1636552202,"alert_manager","","",,"{""edgeId"": ""427"", ""linkId"": ""1030"", ""interface"": ""GE4""}",,,20197449,medium,"33fbe3d5-c1f9-4c57-9303-8c9534653ab8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636552680_16538_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197449 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Aracaju,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133319.0000000",SE,"N/A",BRAD,20197449,LOSANGO,SDWAN,618bcfec506b931a29306464,"OPEN - GENERAL - V3",1636554302,1636552202,"alert_manager","","",,"{""edgeId"": ""427"", ""linkId"": ""911"", ""interface"": ""GE3""}",,,20197449,medium,"d2394052-3bc9-4536-a810-6e1cf3ec5587",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636552680_16538_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197449 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618bd11b3ff371263162f32f,"OPEN - GENERAL - V3",1636562703,1636552503,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}",,,202061983,performance,"293f077b-41d7-4d88-9cf7-4bd65332a512",4133,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636552980_13547_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061983 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Volta Redonda","GERDAU AÇOS LONGOS S A","154976.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202040674,BAIXO,SDWAN,618bd2443ff371263162f338,"OPEN - GENERAL - V3",1636553703,1636553103,"alert_manager","","",,"{""edgeId"": ""1011"", ""linkId"": ""1956"", ""interface"": ""GE3""}","N/A",,202040674,medium,"cb9b2700-27a4-4cc2-9adc-fea0ca53d808",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636553280_13555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040674 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Volta Redonda","GERDAU AÇOS LONGOS S A","154976.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202040674,BAIXO,SDWAN,618bddfb506b931a29306487,"OPEN - GENERAL - V3",1636556403,1636556102,"alert_manager","","",,"{""edgeId"": ""1011"", ""linkId"": ""1956"", ""interface"": ""GE3""}",,,202040674,medium,"c25c8a2c-f02f-4f7b-865a-1308f3f1b120",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636556280_16645_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040674 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618bddfd506b931a2930648a,"OPEN - GENERAL - V3",1636556703,1636556102,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"bb63eb09-2a6a-4a33-aa83-4a7ec78e1ea0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636556280_16645_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618be506506b931a2930649d,"OPEN - GENERAL - V3",1636558203,1636557904,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,high,"0a755834-effa-40bd-a4d2-5fed0f224382",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636558080_16706_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618be62f3ff371263162f377,"OPEN - GENERAL - V3",1636665303,1636558203,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,medium,"e45e9c86-4a80-43fe-9da6-f3a82cad81a0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636558380_13732_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618beae17c6d6919ea6b2835,"OPEN - GENERAL - V3",1636559704,1636559403,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}",,,202183678,medium,"367d5c19-3f99-4500-9e90-40df0860e043",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636559580_16988_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,618bed397c6d6919ea6b283e,"OPEN - GENERAL - V3",1636560304,1636560006,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}",,,202040644,medium,"d27fef95-a5a8-4461-8364-f1af6e9a966c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636560180_17008_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618bf0bc3ff371263162f387,"OPEN - GENERAL - V3",1636561203,1636560905,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"98aa7603-3eff-4cba-b29a-b7096cde645e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636561080_13819_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618bfc753ff371263162f3ab,"OPEN - GENERAL - V3",1636564202,1636563902,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","N/A",,20197450,medium,"0fee4663-f1db-431b-9f60-3858b1b02fe3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636564080_13917_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Uberlândia","GERDAU AÇOS LONGOS S A","154973.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040671,BAIXO,SDWAN,618bfff83ff371263162f3b1,"OPEN - GENERAL - V3",1636565102,1636564802,"alert_manager","","",,"{""edgeId"": ""1007"", ""linkId"": ""2277"", ""interface"": ""GE4""}","N/A",,202040671,medium,"b18e97fa-e281-4cf2-acca-40907e647b87",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636564980_13948_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040671 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618bfff93ff371263162f3b3,"OPEN - GENERAL - V3",1636821002,1636564802,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","N/A",,202061983,medium,"dfb68281-43d9-4aab-b2b8-4899f277930a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636564980_13948_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Regente Feijó","PB LOPES & CIA LTDA","170047.0000000",SP,"N/A","SDWAN - VELOCLOUD",202059979,SDWAN,SDWAN,618c01253ff371263162f3bc,"OPEN - GENERAL - V3",1636582206,1636564802,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,,202059979,performance,"60d224e1-d310-4f11-a116-853dd0c042fa",3316,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636565280_13955_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202059979 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618c082d3ff371263162f3cb,"OPEN - GENERAL - V3",1636567202,1636566902,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,,202040665,medium,"5d09f6f0-834d-44af-91b9-87ba933bde10",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636567080_14011_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Rio das Ostras","VALLOUREC TUBULAR SOLUTIONS LTDA","168652.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202058025,SDWAN,SDWAN,618c0a857c6d6919ea6b2882,"OPEN - GENERAL - V3",1636584905,1636567502,"alert_manager","","",,"{""edgeId"": ""461"", ""linkId"": ""2407"", ""interface"": ""GE2""}",,,202058025,medium,"65f3637e-d0b6-4649-9b2e-39e59a6eff69",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636567680_17249_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058025 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não",Natal,"GERDAU AÇOS LONGOS S A","155330.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041367,BAIXO,SDWAN,618c0a8a7c6d6919ea6b2887,"OPEN - GENERAL - V3",1636585206,1636567202,"alert_manager","","",,"{""edgeId"": ""984"", ""linkId"": ""2221"", ""interface"": ""GE4""}",,,202041367,performance,"855f461c-c865-4832-a88a-f654c05c222e",2221,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636567680_17249_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041367 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Ladário","PB LOPES & CIA LTDA","170046.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059978,SDWAN,SDWAN,618c0a8b7c6d6919ea6b2889,"OPEN - GENERAL - V3",1636567803,1636567502,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}",,,202059978,high,"00c0476e-4a7f-482f-b5ea-07f8710c3586",1267,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636567680_17249_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059978 - Edge 1267 entrou em status OFFLINE",86400,high
"Não",Recife,"ICATU SEGUROS S.A","159551.0000000",PE,"N/A","SDWAN - VELOCLOUD",202046760,"ABORDAGEM SIMPLES",SDWAN,618c0e0a506b931a293064da,"OPEN - GENERAL - V3",1636582803,1636568102,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""4011"", ""interface"": ""GE3""}",,,202046760,performance,"ee7988e7-1f2f-407f-b55c-2dbd11fadac2",4011,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636568580_17049_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618c0e0c506b931a293064dd,"OPEN - GENERAL - V3",1636582505,1636568102,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4047"", ""interface"": ""GE4""}",,,202061987,performance,"42360c7d-baf3-4e43-80dc-74d9e312fbed",4047,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636568580_17049_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061987 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618c0e0c506b931a293064df,"OPEN - GENERAL - V3",1636583107,1636568102,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",,,202061989,performance,"4deeeb4b-711f-483f-adac-c41ebd73befb",5191,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636568580_17049_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061989 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618c0e0d506b931a293064e1,"OPEN - GENERAL - V3",1636582803,1636568102,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""5186"", ""interface"": ""GE3""}",,,202062003,performance,"3deadfab-a5dc-485f-b3f5-6e603f46763e",5186,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636568580_17049_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062003 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Dourados,"PB LOPES & CIA LTDA","170043.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059975,SDWAN,SDWAN,618c12b7506b931a2930650f,"OPEN - GENERAL - V3",1636569905,1636569603,"alert_manager","","",,"{""edgeId"": ""1268"", ""linkId"": ""3300"", ""interface"": ""GE3""}",,,202059975,medium,"98225889-3c5e-4fb5-9f1b-ae022845063b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636569780_17088_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059975 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Dourados,"PB LOPES & CIA LTDA","170043.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059975,SDWAN,SDWAN,618c12c0506b931a2930651c,"OPEN - GENERAL - V3",1636569905,1636569603,"alert_manager","","",,"{""edgeId"": ""1268"", ""linkId"": ""3300"", ""interface"": ""GE3""}",,,202059975,high,"77460fa3-6e4d-453f-8d1f-6c6aa53f1d01",1268,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636569780_17088_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059975 - Edge 1268 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618c189f7c6d6919ea6b28a5,"OPEN - GENERAL - V3",1636595107,1636571102,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,,null,high,"2a344670-ea67-4225-a3e5-f3b5e2dc0c66",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636571280_17366_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618c19c03ff371263162f3e8,"OPEN - GENERAL - V3",1636595107,1636571403,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,,null,medium,"1fb9577f-ae37-4e8f-9370-c3210ed28807",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636571580_14151_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618c19c33ff371263162f3ec,"OPEN - GENERAL - V3",1636571704,1636571403,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"1be86dcc-bd29-45ce-82fc-29bdb05f33a1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636571580_14151_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618c19cb3ff371263162f3f6,"OPEN - GENERAL - V3",1636581907,1636571102,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}","N/A",,202183678,performance,"abbc65a6-8063-4028-8d2b-8f84fee12014",5557,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636571580_14151_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202183678 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Bauru,"GERDAU AÇOS LONGOS S A","154949.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040642,BAIXO,SDWAN,618c1af93ff371263162f40a,"OPEN - GENERAL - V3",1636572004,1636571704,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""2255"", ""interface"": ""GE3""}",,,202040642,high,"3f9436ac-ca1e-4299-a646-1e3919889852",915,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636571880_14163_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040642 - Edge 915 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618c1c187c6d6919ea6b28a9,"OPEN - GENERAL - V3",1636595405,1636571704,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,,null,medium,"cca14a2f-f402-42c6-a269-3b4da5f37ff7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636572180_17399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Araraquara,"GERDAU AÇOS LONGOS S A","154957.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040650,BAIXO,SDWAN,618c23243ff371263162f433,"OPEN - GENERAL - V3",1636574105,1636573895,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""3254"", ""interface"": ""GE4""}",,,202040650,medium,"12189997-e475-484f-a40f-ea6482efc35f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636573980_14224_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040650 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618c23273ff371263162f438,"OPEN - GENERAL - V3",1636583107,1636573503,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,performance,"e698398c-739a-4c8a-9e0f-24fdab004b2d",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636573980_14224_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Novo Hamburgo","GERDAU AÇOS LONGOS S A","155331.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041368,BAIXO,SDWAN,618c24557c6d6919ea6b28de,"OPEN - GENERAL - V3",1636574404,1636574105,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2219"", ""interface"": ""GE4""}",,,202041368,medium,"7c9a7d7e-53da-4b26-a5c1-2152154d2a81",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636574280_17464_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041368 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618c26af506b931a2930656a,"OPEN - GENERAL - V3",1636575004,1636574706,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,,202040665,high,"1e2de8ed-3b4b-4775-b2ec-94c823c24007",969,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636574880_17259_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040665 - Edge 969 entrou em status DEGRADED",86400,high
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618c26b1506b931a2930656d,"OPEN - GENERAL - V3",1636577403,1636574706,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,high,"e4dd4d96-5059-4e86-96a2-f1dd268512c0",983,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636574880_17259_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,20,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041366 - Edge 983 entrou em status OFFLINE",86400,high
"Não","Maceió","GERDAU AÇOS LONGOS S A","155327.0000000",AL,"N/A","SDWAN - VELOCLOUD",202041364,BAIXO,SDWAN,618c27dc3ff371263162f450,"OPEN - GENERAL - V3",1636585506,1636574706,"alert_manager","","",,"{""edgeId"": ""978"", ""linkId"": ""3207"", ""interface"": ""GE4""}",,,202041364,performance,"3f799d1c-769d-46ff-a0bd-69a2e56271b9",3207,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636575180_14261_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041364 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618c29003ff371263162f45c,"OPEN - GENERAL - V3",1636577105,1636575303,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}","N/A",,202041366,medium,"276ea7ac-5357-41fe-93bc-2bd4f50ff203",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636575480_14273_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041366 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618c29013ff371263162f45e,"OPEN - GENERAL - V3",1636577105,1636575303,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2305"", ""interface"": ""GE4""}","N/A",,202041366,medium,"606ef95c-e472-4ce8-adb4-6987b9feeb2a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636575480_14273_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041366 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618c29023ff371263162f460,"OPEN - GENERAL - V3",1636575603,1636575303,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"9a551c86-69ea-47f4-8f97-c5e9c356931a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636575480_14273_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618c2b583ff371263162f476,"OPEN - GENERAL - V3",1636577403,1636575603,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,medium,"039c96ac-5995-405e-accf-4109de4d3033",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636576080_14291_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618c2b593ff371263162f478,"OPEN - GENERAL - V3",1636577403,1636575603,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2305"", ""interface"": ""GE4""}",,,202041366,medium,"afcc8b0f-653f-427d-a00c-e2d09a18a733",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636576080_14291_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618c2c913ff371263162f49c,"OPEN - GENERAL - V3",1636665303,1636576206,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,high,"bfad4acb-bbdb-41e0-b979-5b286fd15db7",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636576380_14302_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,21,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618c2daf7c6d6919ea6b28ef,"OPEN - GENERAL - V3",1636665603,1636576206,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,medium,"174efbc4-f6b9-45fa-9081-29745ddda3ef",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636576680_17543_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618c325c3ff371263162f4a2,"OPEN - GENERAL - V3",1636601705,1636577403,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,,202040665,performance,"d29fee1f-0cf9-47c3-a211-4e596cf187f3",2722,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636577880_14348_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618c34b67c6d6919ea6b291d,"OPEN - GENERAL - V3",1636609804,1636578005,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,,202040665,performance,"e08ffeca-05bc-46e3-98be-b3b1d17ffa75",2723,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636578480_17599_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618c35ee3ff371263162f4da,"OPEN - GENERAL - V3",1636593904,1636578305,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,,202040665,performance,"abdac8cc-914b-415d-a6ff-15d36536001c",2722,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636578780_14378_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","São Luís","BANCO LOSANGO S.A. - BANCO MULTIPLO","133335.0000000",MA,"N/A",BRAD,20197442,LOSANGO,SDWAN,618c43f0506b931a293065db,"OPEN - GENERAL - V3",1636597506,1636581907,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}",,,20197442,performance,"97b650e4-cade-4f71-8910-9c5862b6922f",1072,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636582380_17498_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"20197442 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",618c43fb506b931a293065ea,"OPEN - GENERAL - V3",1636615504,1636581907,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"5c325e83-1d77-4f51-add3-1cf31643a627",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636582380_17498_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618c4652506b931a293065ff,"OPEN - GENERAL - V3",1636593605,1636582505,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,,202040665,performance,"ac57c0c3-7ce6-40af-8299-8c5f5a04d81b",2723,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636582980_17519_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618c4e7f506b931a29306645,"OPEN - GENERAL - V3",1636585206,1636584905,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}",,,202183678,medium,"7afe9059-49af-4216-b77d-9d40e8b51baa",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636585080_17589_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618c613e506b931a29306674,"OPEN - GENERAL - V3",1636590004,1636589705,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"a7ce41b7-818f-4741-97ad-8efcbd54ead7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636589880_17740_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,618c64c23ff371263162f5bd,"OPEN - GENERAL - V3",1636675504,1636590306,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}",,,202062013,performance,"db69bd2f-0f48-486e-a88f-b032f023c805",4157,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636590780_14756_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062013 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,618c65ef7c6d6919ea6b29cc,"OPEN - GENERAL - V3",1636631104,1636590905,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}",,,202062013,medium,"13a89edf-c635-478d-abdb-f6f4ed55ab69",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636591080_18015_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062013 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618c74037c6d6919ea6b29f4,"OPEN - GENERAL - V3",1636594804,1636594204,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,,202040665,performance,"2054bdaf-b9ac-4377-a423-c35c4804f21a",2722,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636594680_18127_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Passo Fundo","GERDAU AÇOS LONGOS S A","155334.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041371,BAIXO,SDWAN,618c7d6b7c6d6919ea6b2a1b,"OPEN - GENERAL - V3",1636597804,1636596906,"alert_manager","","",,"{""edgeId"": ""988"", ""linkId"": ""2087"", ""interface"": ""GE4""}",,,202041371,medium,"ca6cc441-6ebc-43d6-8f6b-07bdb8cb09ed",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636597080_18216_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041371 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618c87ea506b931a293066c2,"OPEN - GENERAL - V3",1636599903,1636599606,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}",,,202183678,medium,"2f718b7c-7a62-4571-898c-ad9654fb13bc",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636599780_18047_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618c997e3ff371263162f62b,"OPEN - GENERAL - V3",1636604404,1636604103,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"fb872b59-d67c-4196-839b-ced41600baff",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636604280_15188_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618ca78e7c6d6919ea6b2a64,"OPEN - GENERAL - V3",1636642803,1636607706,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,medium,"40741262-2661-4fba-9344-454f9ac347f2",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636607880_18576_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618ca78f7c6d6919ea6b2a66,"OPEN - GENERAL - V3",1636642803,1636607706,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2305"", ""interface"": ""GE4""}",,,202041366,medium,"99f5b03a-b431-4c37-9bee-15fec39f5429",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636607880_18576_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618ca7927c6d6919ea6b2a6a,"OPEN - GENERAL - V3",1636642803,1636607706,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,high,"46f2eaa1-ca82-4d2c-86e4-2f29da9b83ab",983,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636607880_18576_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041366 - Edge 983 entrou em status OFFLINE",86400,high
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618ca9e77c6d6919ea6b2a7b,"OPEN - GENERAL - V3",1636643103,1636608005,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,medium,"99598b7f-24b7-4046-86e6-b70be414db1b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636608480_18595_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618ca9e87c6d6919ea6b2a7d,"OPEN - GENERAL - V3",1636643103,1636608005,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2305"", ""interface"": ""GE4""}",,,202041366,medium,"1fac6033-d579-4e43-9ea6-85e38b94cc68",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636608480_18595_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618cbb793ff371263162f662,"OPEN - GENERAL - V3",1636613103,1636612802,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}","N/A",,202183678,medium,"826d055f-cad9-4921-b390-a9b7b5496418",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636612980_15465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183678 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Uberlândia","GERDAU AÇOS LONGOS S A","154973.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040671,BAIXO,SDWAN,618cbefa3ff371263162f674,"OPEN - GENERAL - V3",1636614003,1636613702,"alert_manager","","",,"{""edgeId"": ""1007"", ""linkId"": ""2277"", ""interface"": ""GE4""}",,,202040671,medium,"09616c2c-49cb-492c-b1df-b41c192f35bb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636613880_15492_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040671 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Uberlândia","GERDAU AÇOS LONGOS S A","154973.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040671,BAIXO,SDWAN,618cc72f7c6d6919ea6b2ae7,"OPEN - GENERAL - V3",1636666503,1636615802,"alert_manager","","",,"{""edgeId"": ""1007"", ""linkId"": ""2277"", ""interface"": ""GE4""}",,,202040671,medium,"3c2430d4-74a7-4e72-9f14-d0068f9843ee",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636615980_18841_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040671 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ce47d3ff371263162f6c1,"OPEN - GENERAL - V3",1636623603,1636623303,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4562"", ""interface"": ""GE3""}","N/A",,202061999,medium,"1028993f-360c-4a28-b33c-ea3fa0f1b803",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636623480_15799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061999 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ce92d506b931a2930676c,"OPEN - GENERAL - V3",1636635603,1636624203,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"1d813b3c-c737-4108-a962-b9455775e220",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636624680_18857_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618cf0373ff371263162f6d7,"OPEN - GENERAL - V3",1636626604,1636626303,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}",,,201912633,high,"344006e1-95f6-45bc-8aa0-deddfc49eab7",407,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636626480_15887_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201912633 - Edge 407 entrou em status DEGRADED",86400,high
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618cfd1a506b931a2930678c,"OPEN - GENERAL - V3",1636636803,1636629603,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,,201922181,high,"b0c4e0b1-f52a-463c-8ca2-74e00e033202",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636629780_19023_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201922181 - Edge 1105 entrou em status DEGRADED",86400,high
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618cfe43506b931a29306790,"OPEN - GENERAL - V3",1636636803,1636629904,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,,201922181,medium,"7ffcbecd-1a18-49b9-9b7d-3ccd0412b696",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630080_19035_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922181 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618cff743ff371263162f6f3,"OPEN - GENERAL - V3",1636637104,1636629904,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}","N/A",,201922181,high,"1dfe6d26-76bb-45e9-8a47-c8b660e5793c",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630380_15999_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"201922181 - Edge 1105 entrou em status OFFLINE",86400,high
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618d009c7c6d6919ea6b2b66,"OPEN - GENERAL - V3",1636637104,1636630203,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,,201922181,medium,"a3b990a7-e6c6-4e1d-997f-7689320a7675",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630680_19339_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922181 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d01cb3ff371263162f6fa,"OPEN - GENERAL - V3",0,1636630803,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}","N/A",,201912633,medium,"8234583c-b27d-4571-a5fc-c2b232695519",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630980_16020_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"201912633 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d01cc3ff371263162f6fc,"OPEN - GENERAL - V3",0,1636630803,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1230"", ""interface"": ""GE4""}","N/A",,201912633,medium,"4763ca7c-94ec-4f15-a074-b67db28f27ce",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630980_16020_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"201912633 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d01cf3ff371263162f701,"OPEN - GENERAL - V3",0,1636630803,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}","N/A",,201912633,high,"fef94bf1-8ff8-4c65-b527-96d877a54548",407,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630980_16020_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"201912633 - Edge 407 entrou em status OFFLINE",86400,high
"Não","Passo Fundo","GERDAU AÇOS LONGOS S A","155334.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041371,BAIXO,SDWAN,618d02f73ff371263162f70a,"OPEN - GENERAL - V3",1636632002,1636631104,"alert_manager","","",,"{""edgeId"": ""988"", ""linkId"": ""2087"", ""interface"": ""GE4""}","N/A",,202041371,medium,"5666ad27-b6c4-4d42-ab3d-3ae23d37a690",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636631280_16030_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041371 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618d02fb3ff371263162f70f,"OPEN - GENERAL - V3",1636631402,1636631104,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,high,"f4953b93-a1cd-42a9-929b-6189d3dff6c9",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636631280_16030_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d04227c6d6919ea6b2b71,"OPEN - GENERAL - V3",0,1636631104,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}",,,201912633,medium,"efaa5dc9-d254-4984-a032-87f0c26608ec",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636631580_19369_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"201912633 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d04237c6d6919ea6b2b73,"OPEN - GENERAL - V3",0,1636631104,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1230"", ""interface"": ""GE4""}",,,201912633,medium,"3cbdb611-5587-4a15-8637-0203b952f96e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636631580_19369_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"201912633 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,618d05557c6d6919ea6b2b87,"OPEN - GENERAL - V3",1636632304,1636631703,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,,202040669,high,"e1a663f7-4913-4271-8c02-7ea04c4d52e9",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636631880_19379_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status OFFLINE",86400,high
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,618d067a506b931a2930679d,"OPEN - GENERAL - V3",1636632304,1636632002,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,,202040669,medium,"feb84fd8-d04c-4b8f-8da9-fa448f48601b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636632180_19104_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,618d067b506b931a2930679f,"OPEN - GENERAL - V3",1636632304,1636632002,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}",,,202040669,medium,"2db71051-acd0-4363-b1f8-50b410bf8cc6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636632180_19104_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618d09ff3ff371263162f719,"OPEN - GENERAL - V3",1636633203,1636632903,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"5fbd5868-57bd-4358-85b6-90262c32fc12",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636633080_16086_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618d0b2b506b931a293067b9,"OPEN - GENERAL - V3",1636633503,1636633203,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,,202040665,medium,"4d2f2307-8077-458f-a717-5326ec50178d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636633380_19145_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618d0b2c506b931a293067bb,"OPEN - GENERAL - V3",1636645502,1636632903,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""5301"", ""interface"": ""GE3""}",,,202062005,performance,"7ff1a7aa-386d-4d9e-ac51-c050582ccb73",5301,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636633380_19145_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062005 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618d0b2d506b931a293067be,"OPEN - GENERAL - V3",1636641604,1636632902,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2844"", ""interface"": ""GE4""}",,,202058022,performance,"659c23f3-6c54-4cd6-9962-548813987824",2844,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636633380_19145_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058022 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618d0d8b7c6d6919ea6b2ba2,"OPEN - GENERAL - V3",1636635003,1636633803,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,high,"78979728-2fd6-4786-9bfe-72c4e42554a9",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636633980_19451_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041369 - Edge 986 entrou em status OFFLINE",86400,high
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,618d0ead3ff371263162f724,"OPEN - GENERAL - V3",1636638303,1636634106,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}",,,202062013,medium,"ce40a958-a982-46ed-83cf-ae4bd70424c1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636634280_16120_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062013 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618d0eb03ff371263162f728,"OPEN - GENERAL - V3",1636635003,1636634106,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,medium,"9ce116d1-df97-411b-b5c3-94d0e69b62d4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636634280_16120_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618d0eb13ff371263162f72a,"OPEN - GENERAL - V3",1636635003,1636634106,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",,,202041369,medium,"e27c0c8e-dfe7-4df8-a39d-05ce2c493734",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636634280_16120_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618d1106506b931a293067d8,"OPEN - GENERAL - V3",1636635303,1636634403,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,medium,"66cfb871-59b2-4c93-8eef-eb594714673f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636634880_19193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618d1107506b931a293067da,"OPEN - GENERAL - V3",1636635303,1636634403,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",,,202041369,medium,"6478ea7b-0060-4be3-bf32-25b4a8083246",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636634880_19193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Campina Grande","GERDAU AÇOS LONGOS S A","154942.0000000",PB,"N/A","SDWAN - VELOCLOUD",202040636,BAIXO,SDWAN,618d14907c6d6919ea6b2baf,"OPEN - GENERAL - V3",1636646102,1636635303,"alert_manager","","",,"{""edgeId"": ""952"", ""linkId"": ""2203"", ""interface"": ""GE4""}",,,202040636,performance,"c3c42a41-24c5-4b8c-8d4b-0c1960efeb30",2203,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636635780_19514_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040636 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618d16e6506b931a293067ff,"OPEN - GENERAL - V3",1636636505,1636636204,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,,null,high,"348adae5-602e-4434-bf03-21d30a5701cb",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636636380_19240_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618d1cc23ff371263162f790,"OPEN - GENERAL - V3",1636648204,1636637403,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1583"", ""interface"": ""GE4""}",,,202058019,performance,"1d62ac29-b72d-4f03-8f36-5883f51e6588",1583,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636637880_16232_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058019 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Barreiras,"GERDAU AÇOS LONGOS S A","154958.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040651,BAIXO,SDWAN,618d261e3ff371263162f7be,"OPEN - GENERAL - V3",1636738803,1636640102,"alert_manager","","",,"{""edgeId"": ""948"", ""linkId"": ""2250"", ""interface"": ""GE3""}","N/A",,202040651,medium,"69c4bc0b-2a17-421d-b2a7-7f2769fea5db",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636640280_16316_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040651 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618d29a5506b931a29306827,"OPEN - GENERAL - V3",1636650902,1636640702,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3692"", ""interface"": ""GE1""}",,,202058024,performance,"531537e7-dbb4-471e-ac3d-de78e14dca80",3692,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636641180_19395_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058024 - A perda de pacotes da interface GE1 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618d2c023ff371263162f7ee,"OPEN - GENERAL - V3",1636641902,1636641604,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,high,"da059f8c-dad3-46fb-a353-6fc8a619acaf",502,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636641780_16362_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201912648 - Edge 502 entrou em status DEGRADED",86400,high
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618d31d33ff371263162f7fa,"OPEN - GENERAL - V3",1636644304,1636642803,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,performance,"6bec7ec7-de52-41df-a05e-af2a9f3010c0",2235,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636643280_16407_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041366 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","Rio das Ostras","VALLOUREC TUBULAR SOLUTIONS LTDA","168652.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202058025,SDWAN,SDWAN,618d38dd3ff371263162f810,"OPEN - GENERAL - V3",1636645202,1636644904,"alert_manager","","",,"{""edgeId"": ""461"", ""linkId"": ""2407"", ""interface"": ""GE2""}",,,202058025,medium,"00c11846-f774-4e29-a0fd-05eca7ae0e10",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636645080_16466_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058025 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","Rio Verde","GERDAU AÇOS LONGOS S A","155343.0000000",GO,"N/A","SDWAN - VELOCLOUD",202041380,BAIXO,SDWAN,618d3b3a3ff371263162f829,"OPEN - GENERAL - V3",1636645802,1636645502,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,,202041380,high,"e028ec1e-a81b-4179-99b6-a2aabc50f5d5",998,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636645680_16489_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041380 - Edge 998 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618d4df4506b931a29306871,"OPEN - GENERAL - V3",1636650604,1636650303,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}",,,202062023,medium,"abf73abd-1570-4892-998c-526c2b868e5d",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636650480_19702_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não",Dourados,"GERDAU AÇOS LONGOS S A","154962.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040660,BAIXO,SDWAN,618d57563ff371263162f875,"OPEN - GENERAL - V3",1636653003,1636652704,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2195"", ""interface"": ""GE3""}","N/A",,202040660,medium,"b97eccee-033b-4c81-8a1e-6c1203adf5fb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636652880_16709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040660 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618d57593ff371263162f878,"OPEN - GENERAL - V3",1636653003,1636652704,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,high,"e22209fa-45fb-417e-a5b1-800280fc3430",1566,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636652880_16709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202162229 - Edge 1566 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618d5ad7506b931a29306891,"OPEN - GENERAL - V3",1636653904,1636653603,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""5612"", ""interface"": ""GE3""}",,,202162229,medium,"54977896-d21c-49a4-bee3-f2aef5d4f177",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636653780_19814_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202162229 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618d5c063ff371263162f87e,"OPEN - GENERAL - V3",1636663804,1636653603,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}",,,202061983,performance,"c56e8cef-ca94-4226-8fc5-1ec529806f6e",4132,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636654080_16744_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061983 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,618d630d3ff371263162f896,"OPEN - GENERAL - V3",1636656002,1636655702,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}",,,202062013,medium,"f9620b8b-56d7-45db-82f1-2f7e765b97c6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636655880_16807_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062013 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618d668f7c6d6919ea6b2c23,"OPEN - GENERAL - V3",1636761603,1636656306,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,,202040665,performance,"12024bff-1fdc-4eae-8fee-f2c0a5493a8b",2722,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636656780_20192_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618d6a173ff371263162f8ac,"OPEN - GENERAL - V3",1636657802,1636657503,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,,202040665,medium,"c8072dd8-728e-435f-9c6e-19920b06ce47",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636657680_16863_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618d6b427c6d6919ea6b2c3c,"OPEN - GENERAL - V3",1636669204,1636657802,"alert_manager","","",,"{""edgeId"": ""512"", ""linkId"": ""2755"", ""interface"": ""SFP2""}",,,202058023,medium,"aa1c24bd-96f7-44bb-aa7f-4d4ce645a09d",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636657980_20236_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058023 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não",Natal,"GERDAU AÇOS LONGOS S A","155330.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041367,BAIXO,SDWAN,618d6b477c6d6919ea6b2c41,"OPEN - GENERAL - V3",1636668303,1636657503,"alert_manager","","",,"{""edgeId"": ""984"", ""linkId"": ""2221"", ""interface"": ""GE4""}",,,202041367,performance,"86ba8497-05d1-4d12-a484-61eff4bf33bf",2221,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636657980_20236_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041367 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618d6c707c6d6919ea6b2c49,"OPEN - GENERAL - V3",1636658403,1636658102,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,,202040665,medium,"3920009a-0d50-499a-84e3-8d16eb363c7b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636658280_20244_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618d6ff67c6d6919ea6b2c5f,"OPEN - GENERAL - V3",1636674004,1636658703,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2844"", ""interface"": ""GE4""}",,,202058022,performance,"796f712b-20c4-49eb-905c-24341bb602f7",2844,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636659180_20271_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058022 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618d7e013ff371263162f8e6,"OPEN - GENERAL - V3",1636662903,1636662604,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"98916087-5f4d-4637-a28e-e20bfdb275e0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636662780_17019_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,618d8d3d7c6d6919ea6b2ca0,"OPEN - GENERAL - V3",1637003705,1636666503,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}",,,202062013,medium,"0e6f441d-003e-429c-85ce-9b782daddb98",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636666680_20525_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062013 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Lages,"GERDAU AÇOS LONGOS S A","155352.0000000",SC,"N/A","SDWAN - VELOCLOUD",202041389,BAIXO,SDWAN,618d9b4e506b931a29306933,"OPEN - GENERAL - V3",1636680303,1636670104,"alert_manager","","",,"{""edgeId"": ""975"", ""linkId"": ""2063"", ""interface"": ""GE4""}",,,202041389,medium,"98a177ed-283a-424c-9baf-ded9b73e7e8b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636670280_20350_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041389 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618d9ffd506b931a2930694e,"OPEN - GENERAL - V3",1636671604,1636671302,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}",,,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"2104dc40-7139-4492-a3fa-2efbe9bd542c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636671480_20389_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618da4b1506b931a2930695e,"OPEN - GENERAL - V3",1636696802,1636672204,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"8aa46152-38a6-459d-8b25-4a343a6d06e3",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636672680_20430_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,618da8327c6d6919ea6b2cdb,"OPEN - GENERAL - V3",1636674004,1636673402,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}",,,202041386,medium,"0df230b2-9b2b-45f3-8580-ceafc963e972",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636673580_20748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041386 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618daa87506b931a2930696c,"OPEN - GENERAL - V3",1636680604,1636674004,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}",,,202061983,medium,"0e073111-6708-42cd-8f50-5205007d95bd",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636674180_20481_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061983 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618daa8d506b931a29306975,"OPEN - GENERAL - V3",1636680604,1636674004,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}",,,202061983,high,"a39f152d-69e0-4f65-b66f-ff2c7034058c",1562,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636674180_20481_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202061983 - Edge 1562 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618dacdf506b931a2930697a,"OPEN - GENERAL - V3",1636680902,1636674302,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}",,,202061983,medium,"9a2288d5-0a84-4a7c-90a2-eb75b6ba4f2d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636674780_20502_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061983 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618db2bf506b931a293069a2,"OPEN - GENERAL - V3",1636676402,1636676104,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"9877bbda-d042-4ddf-a277-eb1962a68908",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636676280_20549_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618db3e9506b931a293069ac,"OPEN - GENERAL - V3",1636676703,1636676402,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}",,,202061985,medium,"e9fc0dd5-9e7e-4bba-a028-2d8927309a3a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636676580_20559_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061985 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618dc0d2506b931a293069d4,"OPEN - GENERAL - V3",1636680004,1636679702,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,,201922181,high,"a47f2ada-c187-4e1b-a27d-620d71f2b66c",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636679880_20666_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201922181 - Edge 1105 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618dc57e3ff371263162f97e,"OPEN - GENERAL - V3",1636690202,1636680604,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}",,,202061983,performance,"040f73ee-eed3-400d-bfdc-026640b67dbe",4132,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636681080_17576_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061983 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Novo Hamburgo","GERDAU AÇOS LONGOS S A","155331.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041368,BAIXO,SDWAN,618dc6ad506b931a293069e7,"OPEN - GENERAL - V3",1636741504,1636681203,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2218"", ""interface"": ""GE3""}",,,202041368,high,"b1cb2fa5-2dca-479d-b5a6-34b77827609d",985,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636681380_20714_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041368 - Edge 985 entrou em status OFFLINE",86400,high
"Não","Novo Hamburgo","GERDAU AÇOS LONGOS S A","155331.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041368,BAIXO,SDWAN,618dc7d63ff371263162f987,"OPEN - GENERAL - V3",1636741504,1636681503,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2218"", ""interface"": ""GE3""}","N/A",,202041368,medium,"0ca8c9dd-6071-43d5-b509-b06703cf2db4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636681680_17595_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041368 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Novo Hamburgo","GERDAU AÇOS LONGOS S A","155331.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041368,BAIXO,SDWAN,618dc7d73ff371263162f989,"OPEN - GENERAL - V3",1636741203,1636681503,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2219"", ""interface"": ""GE4""}","N/A",,202041368,medium,"de619d7d-6635-4ecc-93ef-60d33c785c8d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636681680_17595_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041368 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Novo Hamburgo","GERDAU AÇOS LONGOS S A","155331.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041368,BAIXO,SDWAN,618dca2e7c6d6919ea6b2d58,"OPEN - GENERAL - V3",1636741804,1636681803,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2218"", ""interface"": ""GE3""}",,,202041368,medium,"17971296-f9fb-46ee-96cc-9140135fed04",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636682280_21040_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041368 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Novo Hamburgo","GERDAU AÇOS LONGOS S A","155331.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041368,BAIXO,SDWAN,618dca2f7c6d6919ea6b2d5a,"OPEN - GENERAL - V3",1636741504,1636681803,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2219"", ""interface"": ""GE4""}",,,202041368,medium,"145b4f5d-398b-434d-adca-2c007935b6fc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636682280_21040_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041368 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618dca347c6d6919ea6b2d5f,"OPEN - GENERAL - V3",1636800903,1636682102,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,,201922181,high,"74266ed6-8911-41e0-8182-945fee2c8ac7",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636682280_21040_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201922181 - Edge 1105 entrou em status OFFLINE",86400,high
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618dcb58506b931a293069ec,"OPEN - GENERAL - V3",1636800903,1636682403,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,,201922181,medium,"09e31c31-3e75-443f-9fc1-0aa30c3f5ad5",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636682580_20756_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922181 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",618dcdb07c6d6919ea6b2d65,"OPEN - GENERAL - V3",1636801203,1636682704,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,,201922181,medium,"deaffd42-2520-4ca8-b2f5-3e90c66bdb2e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636683180_21069_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922181 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618de3f63ff371263162f9f7,"OPEN - GENERAL - V3",1636689002,1636688704,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}","N/A",,202183678,medium,"23b57ff5-9205-49a7-bfa3-bad72070ec9b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636688880_17817_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183678 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618deb027c6d6919ea6b2dea,"OPEN - GENERAL - V3",1636690803,1636690503,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"0819aad6-71d9-4c52-b9d7-98935d64ad3f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636690680_21305_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ded573ff371263162fa23,"OPEN - GENERAL - V3",1636691703,1636691103,"alert_manager","","",,"{""edgeId"": ""1583"", ""linkId"": ""4385"", ""interface"": ""GE3""}",,,202062015,medium,"bac4cf5f-4037-4f9e-8f3f-7e4846f48f4e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636691280_17887_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062015 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618ded583ff371263162fa26,"OPEN - GENERAL - V3",1636691403,1636691103,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,,202040665,medium,"50f164d9-954d-4044-9c40-949c20c2f054",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636691280_17887_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618df2063ff371263162fa34,"OPEN - GENERAL - V3",1636692602,1636692304,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}",,,202183678,medium,"1afaac5a-6c08-4414-b67d-33321a9d7e49",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636692480_17920_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Sorocaba,"GERDAU AÇOS LONGOS S A","155347.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041384,BAIXO,SDWAN,618df3307c6d6919ea6b2e0e,"OPEN - GENERAL - V3",1636693802,1636692602,"alert_manager","","",,"{""edgeId"": ""1004"", ""linkId"": ""2265"", ""interface"": ""GE4""}",,,202041384,medium,"bfd74473-30eb-44b6-9228-d7263688bebc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636692780_21377_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041384 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618dfb673ff371263162fa5b,"OPEN - GENERAL - V3",1636695002,1636694702,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}","N/A",,202041378,medium,"3cf2a893-38d9-480d-8d06-e19ca55618ce",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636694880_17993_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Marília","GERDAU AÇOS LONGOS S A","154767.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040628,BAIXO,SDWAN,618dfdbf3ff371263162fa64,"OPEN - GENERAL - V3",1636698004,1636695302,"alert_manager","","",,"{""edgeId"": ""980"", ""linkId"": ""3119"", ""interface"": ""GE4""}",,,202040628,medium,"60cffc61-bc26-467b-b620-954d9ce554dc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636695480_18014_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040628 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618e04c47c6d6919ea6b2e44,"OPEN - GENERAL - V3",1636707603,1636696802,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,,202040665,performance,"d00ae99a-f0d1-4bc5-8265-3d50ea1e24fb",2723,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636697280_21529_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","Marília","GERDAU AÇOS LONGOS S A","154767.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040628,BAIXO,SDWAN,618e0bd17c6d6919ea6b2e59,"OPEN - GENERAL - V3",1636709403,1636698604,"alert_manager","","",,"{""edgeId"": ""980"", ""linkId"": ""3119"", ""interface"": ""GE4""}",,,202040628,performance,"1193e8c2-ef6b-4cb4-aee1-386246e31b66",3119,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636699080_21598_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040628 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618e0cfa506b931a29306ab4,"OPEN - GENERAL - V3",1636699502,1636698903,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,,201912648,performance,"38247922-d99f-4b98-becb-3c0445ffbdfb",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636699380_21320_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618e3d083ff371263162fac7,"OPEN - GENERAL - V3",1636722304,1636711204,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"2edfc3f9-4763-4c67-bc18-fb75a6b8db52",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636711680_18504_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Pato Branco","GERDAU AÇOS LONGOS S A","155335.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041372,BAIXO,SDWAN,618e3e31506b931a29306b29,"OPEN - GENERAL - V3",1636729203,1636711804,"alert_manager","","",,"{""edgeId"": ""989"", ""linkId"": ""2244"", ""interface"": ""GE4""}",,,202041372,medium,"0bc1ab5d-bea5-43d5-b657-ecb07e293688",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636711980_21734_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041372 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Pato Branco","GERDAU AÇOS LONGOS S A","155335.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041372,BAIXO,SDWAN,618e408a3ff371263162face,"OPEN - GENERAL - V3",1636729503,1636712103,"alert_manager","","",,"{""edgeId"": ""989"", ""linkId"": ""2244"", ""interface"": ""GE4""}",,"",202041372,medium,"d36a14d0-1564-49f7-9ec4-3e6ae79aa68b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636712580_18533_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041372 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618e48be3ff371263162faf7,"OPEN - GENERAL - V3",1636716004,1636714504,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}","N/A",,202040665,medium,"f97d82b7-1497-47dd-9254-1f1fa5c36795",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636714680_18596_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040665 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618e4c463ff371263162fb05,"OPEN - GENERAL - V3",1636715703,1636715402,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,high,"d690309e-25a6-4837-9bd1-05d2c4b3d1ae",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636715580_18621_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não",Contagem,"GERDAU AÇOS LONGOS S A","154763.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040624,BAIXO,SDWAN,618e57fe7c6d6919ea6b2f1c,"OPEN - GENERAL - V3",1636769102,1636718404,"alert_manager","","",,"{""edgeId"": ""942"", ""linkId"": ""1964"", ""interface"": ""GE3""}",,,202040624,high,"99af5eda-63a5-4c73-b673-609591c04b35",942,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636718580_22250_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040624 - Edge 942 entrou em status OFFLINE",86400,high
"Não",Contagem,"GERDAU AÇOS LONGOS S A","154763.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040624,BAIXO,SDWAN,618e59263ff371263162fb13,"OPEN - GENERAL - V3",1636769102,1636718705,"alert_manager","","",,"{""edgeId"": ""942"", ""linkId"": ""1964"", ""interface"": ""GE3""}","N/A",,202040624,medium,"0672c37b-19f2-40bb-b3e4-dbc4c27d0b2c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636718880_18721_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040624 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Contagem,"GERDAU AÇOS LONGOS S A","154763.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040624,BAIXO,SDWAN,618e59273ff371263162fb15,"OPEN - GENERAL - V3",1636769402,1636718705,"alert_manager","","",,"{""edgeId"": ""942"", ""linkId"": ""1965"", ""interface"": ""GE4""}","N/A",,202040624,medium,"d0231d29-e2ea-4267-aa29-cea872652506",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636718880_18721_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040624 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Contagem,"GERDAU AÇOS LONGOS S A","154763.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040624,BAIXO,SDWAN,618e5b7e3ff371263162fb21,"OPEN - GENERAL - V3",1636769402,1636719002,"alert_manager","","",,"{""edgeId"": ""942"", ""linkId"": ""1964"", ""interface"": ""GE3""}","N/A",,202040624,medium,"dc0ba04e-7a3c-416b-bfa2-c05c97dfa0e3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636719480_18738_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040624 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Contagem,"GERDAU AÇOS LONGOS S A","154763.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040624,BAIXO,SDWAN,618e5b7f3ff371263162fb23,"OPEN - GENERAL - V3",1636769703,1636719002,"alert_manager","","",,"{""edgeId"": ""942"", ""linkId"": ""1965"", ""interface"": ""GE4""}","Em atendimento","",202040624,medium,"1b593fc1-9b93-4938-87f6-cdd698f7276e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636719480_18738_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,alterado,unassigned,1,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040624 - Link GE4 entrou em status DISCONNECTED",86400,low
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618e5b813ff371263162fb27,"OPEN - GENERAL - V3",1636719603,1636719304,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"04b6ea33-82c0-4847-a09b-aaa2f084dab7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636719480_18738_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618e62893ff371263162fb59,"OPEN - GENERAL - V3",1636734903,1636720803,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""5301"", ""interface"": ""GE3""}","N/A",,202062005,performance,"9197d078-2d1d-4c99-8738-5f268ec1433f",5301,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636721280_18797_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202062005 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618e63b03ff371263162fb62,"OPEN - GENERAL - V3",1636721704,1636721403,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""5301"", ""interface"": ""GE3""}",,,202062005,medium,"dc409ab2-dd29-40d0-957f-2bac8fdf6b2d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636721580_18808_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062005 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618e6abc3ff371263162fb75,"OPEN - GENERAL - V3",1636723504,1636723203,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,,202040665,medium,"7153107d-8c88-4964-9e7b-4d841ba0620f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636723380_18858_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618e6bed3ff371263162fb88,"OPEN - GENERAL - V3",1636732203,1636723504,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,high,"60a9f2de-9aea-4546-9830-7ddca662de1f",983,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636723680_18868_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041366 - Edge 983 entrou em status DEGRADED",86400,high
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618e6d153ff371263162fb92,"OPEN - GENERAL - V3",1636732203,1636723802,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,medium,"e2934f76-817e-494e-9fc7-866f1715868c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636723980_18878_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618e6d153ff371263162fb94,"OPEN - GENERAL - V3",1636732203,1636723802,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2305"", ""interface"": ""GE4""}",,,202041366,medium,"bcba11e7-2103-4661-a7a3-a36274053601",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636723980_18878_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618e6e45506b931a29306bad,"OPEN - GENERAL - V3",1636732504,1636723802,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,high,"221bff9c-a75e-4ba9-abac-93ffd3366bd9",983,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636724280_22146_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,,unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041366 - Edge 983 entrou em status OFFLINE",86400,high
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618e6f6c3ff371263162fba4,"OPEN - GENERAL - V3",1636732504,1636724102,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,,202041366,medium,"b0f56dc2-0da7-462d-84e1-5dae2b8e1e68",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636724580_18900_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,618e6f6d3ff371263162fba6,"OPEN - GENERAL - V3",1636732504,1636724102,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2305"", ""interface"": ""GE4""}",,,202041366,medium,"299a3d95-97d4-4d78-b047-5b2439cb8b2d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636724580_18900_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618e6f713ff371263162fbab,"OPEN - GENERAL - V3",1636731003,1636724102,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}","N/A",,202183678,performance,"207b77e8-b6be-4e82-b242-e33c5cd2f72d",5557,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636724580_18900_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202183678 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618e72f1506b931a29306bbb,"OPEN - GENERAL - V3",1636726503,1636725003,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",,,202062009,performance,"632d861d-603c-41cc-94cb-f3e90a607664",4254,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636725480_22183_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062009 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Maceió","GERDAU AÇOS LONGOS S A","155327.0000000",AL,"N/A","SDWAN - VELOCLOUD",202041364,BAIXO,SDWAN,618e7673506b931a29306bdc,"OPEN - GENERAL - V3",1636726503,1636726203,"alert_manager","","",,"{""edgeId"": ""978"", ""linkId"": ""3207"", ""interface"": ""GE4""}",,,202041364,medium,"cf3117e5-e120-4e99-acbe-12aff267e89b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636726380_22214_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041364 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618e779d7c6d6919ea6b2f4d,"OPEN - GENERAL - V3",1636738504,1636726503,"alert_manager","","",,"{""edgeId"": ""512"", ""linkId"": ""2755"", ""interface"": ""SFP2""}",,,202058023,medium,"342ee08b-7faf-4242-84c0-dcdcc74c5686",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636726680_22511_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058023 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618e77a47c6d6919ea6b2f55,"OPEN - GENERAL - V3",1636735204,1636726203,"alert_manager","","",,"{""edgeId"": ""1561"", ""linkId"": ""4120"", ""interface"": ""GE4""}",,,202062021,performance,"c35fc657-a476-4971-ba68-c4eab4d8bb1a",4120,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636726680_22511_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062021 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,618e78c87c6d6919ea6b2f60,"OPEN - GENERAL - V3",1636757403,1636726503,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,,202040665,performance,"0673c278-a330-4725-9a97-ae7c320b87a1",2723,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636726980_22523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não",Salvador,"ICATU SEGUROS S.A","159548.0000000",BA,"N/A","SDWAN - VELOCLOUD",202046758,"ABORDAGEM SIMPLES",SDWAN,618e78c97c6d6919ea6b2f62,"OPEN - GENERAL - V3",1636752003,1636726803,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}",,,202046758,medium,"39896085-a987-427a-acbf-5f01564d83b1",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636726980_22523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618e7b2d3ff371263162fbe4,"OPEN - GENERAL - V3",1636748403,1636727103,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2844"", ""interface"": ""GE4""}",,,202058022,performance,"98a8d235-3863-4526-ae27-32009f847243",2844,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636727580_18995_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","PCBU1709-1-1334787498",unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_Primesys"": ""PCBU1709-1-1334787498"", ""Identificador_TT_Cliente"": ""98a8d235-3863-4526-ae27-32009f847243"", ""Descricao"": ""__201749053 --- 2021nov12/TESTE 5, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",closed,"","",4,"202058022 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","São Paulo","ICATU SEGUROS S.A","180688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202185145,"DUPLA ABORDAGEM",SDWAN,618e7d837c6d6919ea6b2f99,"OPEN - GENERAL - V3",1636756503,1636727703,"alert_manager","","",,"{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}",,,202185145,performance,"caafd201-7586-4a72-a01f-732c2eb47730",5068,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636728180_22567_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","PCBU1709-1-1334787499",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_Primesys"": ""PCBU1709-1-1334787499"", ""Identificador_TT_Cliente"": ""caafd201-7586-4a72-a01f-732c2eb47730"", ""Descricao"": ""__201749053 --- 2021nov12/TESTE 4, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": """", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",closed,"","",4,"202185145 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","São Luís","BANCO LOSANGO S.A. - BANCO MULTIPLO","133335.0000000",MA,"N/A",BRAD,20197442,LOSANGO,SDWAN,618e88033ff371263162fc41,"OPEN - GENERAL - V3",1636756203,1636730403,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}","N/A",,20197442,performance,"7e1d663b-2285-410e-bf33-1e63b3df4269",1072,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636730880_19106_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"20197442 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618e93c0506b931a29306c9e,"OPEN - GENERAL - V3",1636734002,1636733704,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,,202041378,medium,"c4423a71-bfa3-4487-a2d0-6a1074c65bb8",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636733880_22453_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Barreiras,"GERDAU AÇOS LONGOS S A","154958.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040651,BAIXO,SDWAN,618e93c5506b931a29306ca5,"OPEN - GENERAL - V3",1636749002,1636733403,"alert_manager","","",,"{""edgeId"": ""948"", ""linkId"": ""2250"", ""interface"": ""GE3""}",,,202040651,performance,"2f8d2824-ca9c-4f4e-8bc8-6f6f36c0536c",2250,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636733880_22453_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",,unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040651 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618e96173ff371263162fc5b,"OPEN - GENERAL - V3",1636734602,1636734304,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","N/A",,20197450,medium,"9ada2cb6-6c46-47a9-8b2d-088b1d27ef62",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636734480_19214_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618e96203ff371263162fc65,"OPEN - GENERAL - V3",1636735502,1636734304,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,high,"345e70cd-7703-4882-9ffb-4901466fb37a",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636734480_19214_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,,unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041369 - Edge 986 entrou em status DEGRADED",86400,high
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618e9745506b931a29306cb0,"OPEN - GENERAL - V3",1636735502,1636734602,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,medium,"2d36b480-831f-41ad-aef4-2cebe198e6bb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636734780_22485_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618e9746506b931a29306cb2,"OPEN - GENERAL - V3",1636735803,1636734602,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",,,202041369,medium,"c0162202-0349-4753-ab2d-5d17164c98f7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636734780_22485_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618e987a7c6d6919ea6b3012,"OPEN - GENERAL - V3",1636735803,1636734602,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,high,"8144f3b8-f7c6-40fc-9ea9-99d32f5fc5c1",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636735080_22802_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,,unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041369 - Edge 986 entrou em status OFFLINE",86400,high
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618e999e7c6d6919ea6b301e,"OPEN - GENERAL - V3",1636735803,1636734903,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,,202041369,medium,"e0455692-323a-41f0-a42d-ab297c4aede5",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636735380_22813_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,618e999f7c6d6919ea6b3020,"OPEN - GENERAL - V3",1636736104,1636734903,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",,,202041369,medium,"7c46f571-97ec-4a3c-af6f-03f5cf2c2f4e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636735380_22813_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618e9bef506b931a29306cbe,"OPEN - GENERAL - V3",1636741203,1636735502,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2844"", ""interface"": ""GE4""}",,,202058022,performance,"f6aa19ff-e665-44e5-ac64-c4db207a1410",2844,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636735980_22518_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058022 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,618ea4293ff371263162fca8,"OPEN - GENERAL - V3",1636738205,1636737903,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,,20197450,medium,"68da712a-e09d-480e-a8ec-1b45c570487e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636738080_19324_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,618ea7ad3ff371263162fcb8,"OPEN - GENERAL - V3",1636739103,1636738803,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}",,,202040644,medium,"f78d97a3-a55e-4df5-985a-05d56ebe623e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636738980_19352_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Hortolândia","GERDAU AÇOS LONGOS SA","157246.0000000",SP,"",GRC,202043846,ALTO,MPLS,618eac5746080a1c83285881,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra097138.igs.gerd",high,"2a70f162-a629-4f1c-9c79-be669aeffe8f","GigabitEthernet0/0/0.40","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,0,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra097138.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/0.40",86400,high
"Não","Hortolândia","GERDAU AÇOS LONGOS SA","157246.0000000",SP,"",GRC,202043846,ALTO,MPLS,618eac5846080a1c83285883,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra097139.igs.gerd",high,"9881dbc8-72a3-40c2-b49c-f33a3fcdd624","GigabitEthernet0/0/0","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,1,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra097139.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/0",86400,high
"Não",Itabirito,"GERDAU AÇOS LONGOS SA","157388.0000000",MG,"",GRC,202043997,DADOS,DADOS,618eac5946080a1c83285885,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096323.igs.gerd",medium,"1bb8aa4c-f5ef-42eb-8e35-b546a26bca99","GigabitEthernet0/4.4","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,2,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096323.igs.gerd - Link Titular com status down na interface GigabitEthernet0/4.4",86400,medium
"Não",Itabirito,"GERDAU AÇOS LONGOS SA","157388.0000000",MG,"",GRC,202043997,DADOS,DADOS,618eac5a46080a1c83285887,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096323.igs.gerd",medium,"d5e7cf37-0fed-4406-b3ae-a5f5f7d72892","GigabitEthernet0/5.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,3,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096323.igs.gerd - Link Backup com status down na interface GigabitEthernet0/5.2",86400,medium
"Não","Ouro Branco","GERDAU ACOMINAS S A","157430.0000000",MG,"",GRC,202044033,ALTO,MPLS,618eac5b46080a1c83285889,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096324.igs.gerd",medium,"11b830f1-2db2-4ed6-9f5f-a4b53bedc7c9","GigabitEthernet0/0/1.4","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,4,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096324.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/1.4",86400,medium
"Não","Ouro Branco","GERDAU ACOMINAS S A","157430.0000000",MG,"",GRC,202044033,ALTO,MPLS,618eac5c46080a1c8328588b,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096324.igs.gerd",medium,"450ed949-85a8-49c3-bf9b-347eba599990","GigabitEthernet0/0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,5,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096324.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/2",86400,medium
"Não","Ouro Branco","GERDAU ACOMINAS S A","157430.0000000",MG,"",GRC,202044033,ALTO,MPLS,618eac5d46080a1c8328588d,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096602.igs.gerd",high,"d7bd6352-7c17-4167-99a4-0ec4367a85a3","GigabitEthernet0/0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,6,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096602.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/2.2",86400,high
"Não",Barueri,"GERDAU AÇOS LONGOS SA","157431.0000000",SP,"",GRC,202044034,ALTO,MPLS,618eac5e46080a1c8328588f,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096325.igs.gerd",high,"fb242617-f9df-4a7e-8a73-db9c48d76a56","GigabitEthernet0/0/2.19","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,7,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096325.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/2.19",86400,high
"Não",Barueri,"GERDAU AÇOS LONGOS SA","157431.0000000",SP,"",GRC,202044034,ALTO,MPLS,618eac5f46080a1c83285891,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096603.igs.gerd",high,"ebb91c4d-f9fb-4823-9212-4226471d44d5","GigabitEthernet0/0/1.5","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,8,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096603.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/1.5",86400,high
"Não","São Paulo","GERDAU ACOMINAS S A","157432.0000000",SP,"",GRC,202044035,ALTO,MPLS,618eac6046080a1c83285893,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra097158.igs.gerd",medium,"640bc98e-4b8d-4fe2-962d-3cf93a480a9f","GigabitEthernet0/0/1.299","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,9,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra097158.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/1.299",86400,medium
"Não","São Paulo","GERDAU ACOMINAS S A","157432.0000000",SP,"",GRC,202044035,ALTO,MPLS,618eac6146080a1c83285895,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra097158.igs.gerd",medium,"2b5057ad-619f-4ac4-983f-62bcd413ee59","GigabitEthernet0/0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,10,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra097158.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/2",86400,medium
"Não","Sapucaia do Sul","GERDAU AÇOS LONGOS SA","157434.0000000",RS,"",GRC,202044037,ALTO,MPLS,618eac6246080a1c83285897,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096327.igs.gerd",medium,"5a94900a-8eb2-4734-9050-a8921ddaaf95","GigabitEthernet0/1.5","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,11,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096327.igs.gerd - Link Backup com status down na interface GigabitEthernet0/1.5",86400,medium
"Não","Sapucaia do Sul","GERDAU AÇOS LONGOS SA","157434.0000000",RS,"",GRC,202044037,ALTO,MPLS,618eac6346080a1c83285899,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096327.igs.gerd",medium,"4fd7a82b-1863-4b00-975e-38f852bb187c","GigabitEthernet0/2.23","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,12,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096327.igs.gerd - Link Titular com status down na interface GigabitEthernet0/2.23",86400,medium
"Não",Pindamonhangaba,"GERDAU S A","157435.0000000",SP,"",GRC,202044038,ALTO,MPLS,618eac6346080a1c8328589b,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096328.igs.gerd",medium,"135d0ce9-390d-4e68-a379-548af8813a56","GigabitEthernet0/0/0.20","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,13,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096328.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/0.20",86400,medium
"Não",Pindamonhangaba,"GERDAU S A","157435.0000000",SP,"",GRC,202044038,ALTO,MPLS,618eac6446080a1c8328589d,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096328.igs.gerd",medium,"51fe6fca-cc81-4e80-a738-1a43a68331e9","GigabitEthernet0/0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,14,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096328.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/2.2",86400,medium
"Não","Rio de Janeiro","GERDAU ACOMINAS S A","157436.0000000",RJ,"",GRC,202044039,ALTO,MPLS,618eac6546080a1c8328589f,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096329.igs.gerd",medium,"95398089-f05d-478f-ac29-9320ed103fa4","GigabitEthernet0/0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,15,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096329.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/1",86400,medium
"Não","Rio de Janeiro","GERDAU ACOMINAS S A","157436.0000000",RJ,"",GRC,202044039,ALTO,MPLS,618eac6646080a1c832858a1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096329.igs.gerd",medium,"317d38d5-bb22-493d-8d34-401007c65ec9","GigabitEthernet0/0/2.9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,16,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096329.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/2.9",86400,medium
"Não",Charqueadas,"GERDAU S A","157437.0000000",RS,"",GRC,202044040,ALTO,MPLS,618eac6746080a1c832858a3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096330.igs.gerd",medium,"6d3fd687-a4a3-4ec6-a5c5-f23ddec26342","GigabitEthernet0/0/0","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,17,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096330.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/0",86400,medium
"Não",Charqueadas,"GERDAU S A","157437.0000000",RS,"",GRC,202044040,ALTO,MPLS,618eac6846080a1c832858a5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096330.igs.gerd",medium,"e9d2e732-3cf1-41fb-8a7a-2dd4c3fc908d","GigabitEthernet0/0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,18,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096330.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/1",86400,medium
"Não","São Paulo","GERDAU AÇOS LONGOS SA","157438.0000000",SP,"",GRC,202044041,MEDIO,MPLS,618eac6946080a1c832858a7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096331.igs.gerd",medium,"8efd0160-0c4b-4547-84c8-0c050bb403b9","GigabitEthernet0/1.46","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,19,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096331.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.46",86400,medium
"Não","São Paulo","GERDAU AÇOS LONGOS SA","157438.0000000",SP,"",GRC,202044041,MEDIO,MPLS,618eac6a46080a1c832858a9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096331.igs.gerd",medium,"56255b0b-3b12-4afe-8f2b-374888e4e0e2","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,20,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096331.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não","Aparecida de Goiânia","GERDAU AÇOS LONGOS SA","157439.0000000",GO,"",GRC,202044042,MEDIO,MPLS,618eac6b46080a1c832858ab,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096332.igs.gerd",medium,"8548cf3e-d890-499c-9fc9-60b6790f38c4","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,21,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096332.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Aparecida de Goiânia","GERDAU AÇOS LONGOS SA","157439.0000000",GO,"",GRC,202044042,MEDIO,MPLS,618eac6c46080a1c832858ad,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096332.igs.gerd",medium,"ced6b729-a077-4d76-96ad-cf45bd8c6756","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,22,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096332.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Contagem,"GERDAU AÇOS LONGOS SA","157440.0000000",MG,"",GRC,202044043,MEDIO,MPLS,618eac6d46080a1c832858af,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096333.igs.gerd",medium,"534e0366-cad2-458d-981f-607da0dc7739","GigabitEthernet0/1.25","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,23,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096333.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.25",86400,medium
"Não",Contagem,"GERDAU AÇOS LONGOS SA","157440.0000000",MG,"",GRC,202044043,MEDIO,MPLS,618eac6e46080a1c832858b1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096333.igs.gerd",medium,"d670e8c7-f475-4dae-8217-8796c4f5398a","GigabitEthernet0/2.172","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,24,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096333.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.172",86400,medium
"Não","Rio de Janeiro","GERDAU AÇOS LONGOS SA","157441.0000000",RJ,"",GRC,202044044,MEDIO,MPLS,618eac6f46080a1c832858b3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096346.igs.gerd",medium,"92724606-d64c-4f6f-88b8-b8fb36e23e25","GigabitEthernet0/1.24","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,25,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096346.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.24",86400,medium
"Não","Rio de Janeiro","GERDAU AÇOS LONGOS SA","157441.0000000",RJ,"",GRC,202044044,MEDIO,MPLS,618eac6f46080a1c832858b5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096346.igs.gerd",medium,"5d1b9393-a532-4aeb-bf5b-0908e966f26c","GigabitEthernet0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,26,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096346.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.2",86400,medium
"Não","São Caetano do Sul","GERDAU AÇOS LONGOS SA","157596.0000000",SP,"",GRC,202044216,MEDIO,MPLS,618eac7046080a1c832858b7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096348.igs.gerd",medium,"0dfb2af0-42ab-4f45-8345-13348991b52b","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,27,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096348.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","São Caetano do Sul","GERDAU AÇOS LONGOS SA","157596.0000000",SP,"",GRC,202044216,MEDIO,MPLS,618eac7146080a1c832858b9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096348.igs.gerd",medium,"4dd3b16e-61d1-4df5-be9c-24f72375f0de","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,28,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096348.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Recife,"GERDAU ACOMINAS S A","157597.0000000",PE,"",GRC,202044217,ALTO,MPLS,618eac7246080a1c832858bb,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096349.igs.gerd",medium,"2543e7e3-249b-4d4f-982b-a1f857e077d9","GigabitEthernet0/1.22","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,29,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096349.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.22",86400,medium
"Não",Recife,"GERDAU ACOMINAS S A","157597.0000000",PE,"",GRC,202044217,ALTO,MPLS,618eac7346080a1c832858bd,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096349.igs.gerd",medium,"d8a2a302-badd-4351-b0dc-a4e9b350b9e5","GigabitEthernet0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,30,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096349.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.2",86400,medium
"Não","Divinópolis","GERDAU ACOMINAS S A","157598.0000000",MG,"",GRC,202044218,MEDIO,MPLS,618eac7446080a1c832858bf,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096350.igs.gerd",medium,"72ec66fd-2268-4686-bbb3-abad4a564cb9","GigabitEthernet0/1.66","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,31,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096350.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.66",86400,medium
"Não","Divinópolis","GERDAU ACOMINAS S A","157598.0000000",MG,"",GRC,202044218,MEDIO,MPLS,618eac7546080a1c832858c1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096350.igs.gerd",medium,"2900af79-e1ec-4cd4-a0e1-3b5d6a04d453","GigabitEthernet0/2.5","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,32,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096350.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.5",86400,medium
"Não","São José dos Campos","GERDAU AÇOS LONGOS SA","157599.0000000",SP,"",GRC,202044219,MEDIO,MPLS,618eac7646080a1c832858c3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096352.igs.gerd",medium,"4afb0714-f3d8-4910-b96b-17e0bba350a4","GigabitEthernet0/1.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,33,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096352.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.2",86400,medium
"Não","São José dos Campos","GERDAU AÇOS LONGOS SA","157599.0000000",SP,"",GRC,202044219,MEDIO,MPLS,618eac7746080a1c832858c5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096352.igs.gerd",medium,"7c3e55c5-b6ec-4bce-83c4-3c56f43e95e5","GigabitEthernet0/2.17","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,34,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096352.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.17",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS SA","157600.0000000",BA,"",GRC,202044220,MEDIO,MPLS,618eac7746080a1c832858c7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096353.igs.gerd",medium,"92f82f9c-4e7b-41f5-876b-09c6e63afbdb","FastEthernet0/3/0.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,35,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096353.igs.gerd - Link Backup com status down na interface FastEthernet0/3/0.2",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS SA","157600.0000000",BA,"",GRC,202044220,MEDIO,MPLS,618eac7846080a1c832858c9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096353.igs.gerd",medium,"5ad4b16d-d794-4e3c-b8a2-8ad2a9275046","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,36,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096353.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Maracanaú","GERDAU ACOMINAS S A","157601.0000000",CE,"",GRC,202044221,ALTO,MPLS,618eac7946080a1c832858cb,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096354.igs.gerd",medium,"07567940-04db-48dd-8ca5-e4a16ab04477","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,37,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096354.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Maracanaú","GERDAU ACOMINAS S A","157601.0000000",CE,"",GRC,202044221,ALTO,MPLS,618eac7a46080a1c832858cd,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096354.igs.gerd",medium,"0de4a533-bb44-4a36-9685-3f44470e3ff3","GigabitEthernet0/2.3001","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,38,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096354.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.3001",86400,medium
"Não","Porto Alegre","GERDAU ACOMINAS S A","157595.0000000",RS,"",GRC,202044223,DADOS,DADOS,618eac7b46080a1c832858cf,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096357.igs.gerd",medium,"261bd753-9436-4fe4-a2d6-a12dc261aaeb","GigabitEthernet0/0.12","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,39,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096357.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0.12",86400,medium
"Não","Porto Alegre","GERDAU ACOMINAS S A","157595.0000000",RS,"",GRC,202044223,DADOS,DADOS,618eac7c46080a1c832858d1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096357.igs.gerd",medium,"aba6b474-8552-4393-8a9a-59a7ea97c1e8","GigabitEthernet0/1.105","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,40,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096357.igs.gerd - Link Backup com status down na interface GigabitEthernet0/1.105",86400,medium
"Não","Araçariguama","GERDAU AÇOS LONGOS SA","157602.0000000",SP,"",GRC,202044224,ALTO,MPLS,618eac7d46080a1c832858d3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096351.igs.gerd",medium,"ed42d53c-0289-4989-8f8b-fd8c5cba3709","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,41,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096351.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Araçariguama","GERDAU AÇOS LONGOS SA","157602.0000000",SP,"",GRC,202044224,ALTO,MPLS,618eac7e46080a1c832858d5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096351.igs.gerd",medium,"85ecc775-7a0f-476e-a05d-a667b504e3a7","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,42,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096351.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não","Miguel Burnier","GERDAU AÇOS LONGOS SA","157603.0000000",MG,"",GRC,202044225,MEDIO,MPLS,618eac7f46080a1c832858d7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096355.igs.gerd",high,"eba0431d-9c6d-46f2-8530-d19d08f0f30d","GigabitEthernet0/1.3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,43,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096355.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/1.3",86400,high
"Não","Miguel Burnier","GERDAU AÇOS LONGOS SA","157603.0000000",MG,"",GRC,202044225,MEDIO,MPLS,618eac8046080a1c832858d9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096604.igs.gerd",high,"f67dab7e-1df5-430d-be65-47e729d9fa67","GigabitEthernet0/0.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,44,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096604.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0.2",86400,high
"Não","Cabo de Santo Agostinho","GERDAU AÇOS LONGOS SA","157842.0000000",PE,"",GRC,202044525,MEDIO,MPLS,618eac8146080a1c832858db,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096358.igs.gerd",medium,"aa6a4d67-ccd8-406c-b28e-e05713075762","GigabitEthernet0/1.28","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,45,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096358.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.28",86400,medium
"Não","Cabo de Santo Agostinho","GERDAU AÇOS LONGOS SA","157842.0000000",PE,"",GRC,202044525,MEDIO,MPLS,618eac8146080a1c832858dd,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096358.igs.gerd",medium,"917eb5b8-fb59-4a19-a0ac-a648b9230b4e","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,46,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096358.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Tijucas,"GERDAU AÇOS LONGOS SA","157843.0000000",SC,"",GRC,202044526,MEDIO,MPLS,618eac8246080a1c832858df,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096359.igs.gerd",medium,"39c56f2c-b9d4-4567-bacd-409160a3ba8d","GigabitEthernet0/1.3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,47,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096359.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.3",86400,medium
"Não",Tijucas,"GERDAU AÇOS LONGOS SA","157843.0000000",SC,"",GRC,202044526,MEDIO,MPLS,618eac8346080a1c832858e1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096359.igs.gerd",medium,"2d46c9fa-5304-4e59-8e47-1164cba0ff9e","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,48,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096359.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Itabirito,"GERDAU AÇOS LONGOS SA","157844.0000000",MG,"",GRC,202044527,MEDIO,MPLS,618eac8446080a1c832858e3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096360.igs.gerd",medium,"82efcdea-d699-4330-9a4e-28d91c39d56e","GigabitEthernet0/1.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,49,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096360.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.2",86400,medium
"Não",Itabirito,"GERDAU AÇOS LONGOS SA","157844.0000000",MG,"",GRC,202044527,MEDIO,MPLS,618eac8546080a1c832858e5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096360.igs.gerd",medium,"7108b515-be18-4ca5-9305-e2f98c87f5d9","GigabitEthernet0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,50,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096360.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.2",86400,medium
"Não","Vitória","GERDAU ACOMINAS S A","157845.0000000",ES,"",GRC,202044528,MEDIO,MPLS,618eac8646080a1c832858e7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096361.igs.gerd",medium,"c6fc93f5-90b8-47e6-afac-271c370f39f9","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,51,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096361.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Vitória","GERDAU ACOMINAS S A","157845.0000000",ES,"",GRC,202044528,MEDIO,MPLS,618eac8746080a1c832858e9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096361.igs.gerd",medium,"360cabd9-4e34-49e0-bae7-5372cb16e5c6","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,52,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096361.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não","Sete Lagoas","GERDAU AÇOS LONGOS SA","157846.0000000",MG,"",GRC,202044529,MEDIO,MPLS,618eac8846080a1c832858eb,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096362.igs.gerd",high,"7800979d-b28e-4bec-b0f1-6ac8cded388c","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,53,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096362.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/1",86400,high
"Não","Barão de Cocais","GERDAU AÇOS LONGOS SA","157847.0000000",MG,"",GRC,202044530,MEDIO,MPLS,618eac8946080a1c832858ed,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096363.igs.gerd",medium,"3b6abbe2-ca9a-4b24-b82e-ce4ef22356bd","GigabitEthernet0/1.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,54,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096363.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.2",86400,medium
"Não","Barão de Cocais","GERDAU AÇOS LONGOS SA","157847.0000000",MG,"",GRC,202044530,MEDIO,MPLS,618eac8a46080a1c832858ef,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096363.igs.gerd",medium,"0e9e7ec8-d9d8-47b5-be8c-37c39de4a6f3","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,55,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096363.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Cotia,"GERDAU AÇOS LONGOS SA","157852.0000000",SP,"",GRC,202044531,MEDIO,MPLS,618eac8a46080a1c832858f1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096364.igs.gerd",medium,"76f53b3e-10a9-44b6-8ac8-2c6e1807aa4e","GigabitEthernet0/1.41","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,56,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096364.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.41",86400,medium
"Não",Cotia,"GERDAU AÇOS LONGOS SA","157852.0000000",SP,"",GRC,202044531,MEDIO,MPLS,618eac8b46080a1c832858f3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096364.igs.gerd",medium,"66341d3f-1aed-4b82-bfe8-88308b40538b","GigabitEthernet0/2.301","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,57,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096364.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.301",86400,medium
"Não","Araucária","GERDAU AÇOS LONGOS SA","157848.0000000",PR,"",GRC,202044532,MEDIO,MPLS,618eac8c46080a1c832858f5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096365.igs.gerd",medium,"7ba548f3-e461-463f-81a9-965131e0c9bf","GigabitEthernet0/0","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,58,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096365.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0",86400,medium
"Não","Araucária","GERDAU AÇOS LONGOS SA","157848.0000000",PR,"",GRC,202044532,MEDIO,MPLS,618eac8d46080a1c832858f7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096365.igs.gerd",medium,"7f0d8268-bfdf-4c92-88f8-07131d385953",Multilink1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,59,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096365.igs.gerd - Link Backup com status down na interface Multilink1",86400,medium
"Não","Mogi das Cruzes","GERDAU S A","157849.0000000",SP,"",GRC,202044533,MEDIO,MPLS,618eac8e46080a1c832858f9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096366.igs.gerd",medium,"c7bd226b-052e-4642-ada1-8cee694ac4ac","GigabitEthernet0/0/0","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,60,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096366.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/0",86400,medium
"Não","Mogi das Cruzes","GERDAU S A","157849.0000000",SP,"",GRC,202044533,MEDIO,MPLS,618eac8f46080a1c832858fb,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096366.igs.gerd",medium,"970d2fde-3a34-4f53-aaaa-1c038ac1c929","GigabitEthernet0/0/1.27","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,61,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096366.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/1.27",86400,medium
"Não",Guarulhos,"GERDAU AÇOS LONGOS SA","157850.0000000",SP,"",GRC,202044534,MEDIO,MPLS,618eac9046080a1c832858fd,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096367.igs.gerd",medium,"468f285c-8358-465d-82cb-78de1715f90a","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,62,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096367.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não",Guarulhos,"GERDAU AÇOS LONGOS SA","157850.0000000",SP,"",GRC,202044534,MEDIO,MPLS,618eac9146080a1c832858ff,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096367.igs.gerd",medium,"baa1c7c4-eda4-42a6-94de-b36a7aad84ba","GigabitEthernet0/2.58","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,63,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096367.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.58",86400,medium
"Não",Guararu,"SIDERURGICA LATINO AMERICANA S A SILAT","171083.0000000",CE,"",GRC,202061359,DADOS,DADOS,618eac9246080a1c83285901,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra097512.igs.gerd",medium,"771c14dd-aafa-464e-aa3e-a1f799830ebf","GigabitEthernet0/4.17","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,64,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra097512.igs.gerd - Link Titular com status down na interface GigabitEthernet0/4.17",86400,medium
"Não",Guararu,"SIDERURGICA LATINO AMERICANA S A SILAT","171083.0000000",CE,"",GRC,202061359,DADOS,DADOS,618eac9346080a1c83285903,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra097512.igs.gerd",medium,"55586b5a-1d98-4ae2-af97-d57cf499a113","GigabitEthernet0/5.670","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,65,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra097512.igs.gerd - Link Backup com status down na interface GigabitEthernet0/5.670",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,618ebf1db4a8174f7a50dce8,"OPEN - GENERAL - V3",1636745104,1636744803,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"47a055be-69df-4073-aaeb-a9ea146d3dc4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636744980_152_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Maceió","GERDAU AÇOS LONGOS S A","155327.0000000",AL,"N/A","SDWAN - VELOCLOUD",202041364,BAIXO,SDWAN,618ebf1eb4a8174f7a50dcea,"OPEN - GENERAL - V3",1636749903,1636744803,"alert_manager","","",,"{""edgeId"": ""978"", ""linkId"": ""3207"", ""interface"": ""GE4""}","N/A",,202041364,medium,"9c0078d4-d364-425f-983d-2bde304dbc0a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636744980_152_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041364 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ec173b4a8174f7a50dcf5,"OPEN - GENERAL - V3",1636745704,1636745402,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,medium,"da75425b-1003-4e0f-8342-d396bcf03545",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636745580_172_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,618ec176b4a8174f7a50dcf9,"OPEN - GENERAL - V3",1636745704,1636745402,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}","N/A",,202041386,medium,"79e28e3b-ce76-4b54-8927-1e5c6eea3143",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636745580_172_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041386 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Feira de Santana","GERDAU AÇOS LONGOS S A","154939.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040638,BAIXO,SDWAN,618ec177b4a8174f7a50dcfb,"OPEN - GENERAL - V3",1636745704,1636745402,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}","N/A",,202040638,medium,"215b022d-c988-4550-b5a0-ce5fb5296c78",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636745580_172_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040638 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ec17db4a8174f7a50dd02,"OPEN - GENERAL - V3",1636745704,1636745402,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,high,"706bdc96-9302-4511-aac2-7f92066c86e0",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636745580_172_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ec3cbfa57811c983ee6ef,"OPEN - GENERAL - V3",1636748103,1636746002,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,medium,"f8f6e9a6-1cb1-47d0-9eb7-741897542c79",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636746180_196_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618ec3d3fa57811c983ee700,"OPEN - GENERAL - V3",1636747803,1636746002,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,high,"3991e880-be81-4ae4-9687-a6e7d47c1eae",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636746180_196_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ec623b4a8174f7a50dd09,"OPEN - GENERAL - V3",1636748403,1636746302,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,medium,"dad74e4c-8cc8-4922-b09e-39c76ad4eaf4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636746780_215_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,618ec626b4a8174f7a50dd0d,"OPEN - GENERAL - V3",1636746904,1636746602,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}","N/A",,202041386,medium,"de3ff23f-6ee7-4c27-b603-3ab970821066",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636746780_215_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041386 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ecf89fa57811c983ee8dd,"OPEN - GENERAL - V3",1636749304,1636749002,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,high,"6ff0d7c3-5411-40a2-94a0-da3b850044dc",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636749180_297_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618ed68e512a4e102e43b71a,"OPEN - GENERAL - V3",1636754703,1636750804,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,high,"c27f9a17-010e-4c78-a782-c3245a0c49d2",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636750980_381_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"null - Edge 1543 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",618ed7b7b4a8174f7a50de15,"OPEN - GENERAL - V3",1636754404,1636751103,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,medium,"b8be1358-ce77-4079-90a7-7d082173e214",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636751280_375_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618ed8e8fa57811c983ee9fc,"OPEN - GENERAL - V3",1636755003,1636751103,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,high,"d269167c-9e0d-445a-a58f-a4549e8310bf",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636751580_371_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618eda0fb4a8174f7a50de26,"OPEN - GENERAL - V3",1636754703,1636751402,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,medium,"8470aa63-a0ed-42b1-8938-ad219f4e982c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636751880_392_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"ICATU SEGUROS S.A","159548.0000000",BA,"N/A","SDWAN - VELOCLOUD",202046758,"ABORDAGEM SIMPLES",SDWAN,618edc66fa57811c983eea0c,"OPEN - GENERAL - V3",1636754404,1636752304,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}","N/A",,202046758,medium,"d767964e-13b2-4cb9-892e-5198ca8e2c29",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636752480_399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202046758 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618edc69fa57811c983eea11,"OPEN - GENERAL - V3",1636757703,1636752003,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,performance,"4a02cb36-d5f5-43f2-8928-69fad1fc7461",4487,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636752480_399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"null - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618ee375fa57811c983eea6e,"OPEN - GENERAL - V3",0,1636754103,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}","N/A",,202061989,high,"eb0896b1-fbb2-4d72-95d1-d635ebe45b6e",1567,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636754280_467_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202061989 - Edge 1567 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ee499512a4e102e43b885,"OPEN - GENERAL - V3",0,1636754404,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}","N/A",,202061989,medium,"c54241a7-44bf-4d18-a64c-ee39f068342b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636754580_504_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202061989 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Salvador,"ICATU SEGUROS S.A","159548.0000000",BA,"N/A","SDWAN - VELOCLOUD",202046758,"ABORDAGEM SIMPLES",SDWAN,618ee49b512a4e102e43b888,"OPEN - GENERAL - V3",1636763103,1636754103,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}","N/A",,202046758,performance,"f514c179-d8c7-4a06-8892-60cf7aa9d8a7",2843,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636754580_504_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202046758 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618ee5ceb4a8174f7a50df4c,"OPEN - GENERAL - V3",1636759202,1636754703,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"40d52795-15c0-4cf6-90d3-c2425e2e218f",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636754880_492_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ee6f1512a4e102e43b898,"OPEN - GENERAL - V3",0,1636754703,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}","N/A",,202061989,medium,"8d37036f-0e68-4dbb-bdcf-dd59dd216638",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636755180_522_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202061989 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ee6f3512a4e102e43b89d,"OPEN - GENERAL - V3",1636759202,1636755003,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"852ecd3d-f02a-4159-8b08-09ddbe792f04",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636755180_522_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618ee6f8512a4e102e43b8ab,"OPEN - GENERAL - V3",1636759504,1636754703,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"b315c0f3-2064-4425-a7a3-de5cb5538ae7",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636755180_522_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ee820512a4e102e43b8ee,"OPEN - GENERAL - V3",1636759504,1636755003,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"7498c6a1-01e8-4552-adfa-c744accdd018",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636755480_534_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618ee825512a4e102e43b8fb,"OPEN - GENERAL - V3",1636759802,1636755003,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"d7e7d4af-5f90-4095-b25b-10fb98e2182e",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636755480_534_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ee94b512a4e102e43b937,"OPEN - GENERAL - V3",1636759802,1636755303,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"f4aa1c3c-940a-4617-ab96-a8bb8e3c0734",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636755780_544_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ee951512a4e102e43b93e,"OPEN - GENERAL - V3",1636760103,1636755303,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"d53762cc-e7cc-46b5-8708-972bd046407d",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636755780_544_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618eea78b4a8174f7a50df95,"OPEN - GENERAL - V3",1636760103,1636755603,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"8ff7067c-5609-4e31-b6c1-41c0aea9968e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756080_533_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618eea7eb4a8174f7a50df9c,"OPEN - GENERAL - V3",1636760405,1636755603,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"b9ab4941-b165-4c52-a519-ebdefa6ab264",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756080_533_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618eeba4fa57811c983eeb2a,"OPEN - GENERAL - V3",1636760405,1636755903,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"48d101d7-b5e5-4b1d-854f-6c8236383623",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756380_539_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618eebaafa57811c983eeb31,"OPEN - GENERAL - V3",1636760703,1636755903,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"cc2959cc-a545-438a-b6f9-f498449ce971",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756380_539_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618eecd0fa57811c983eeb39,"OPEN - GENERAL - V3",1636760703,1636756203,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"0312f187-311d-4aa1-b75b-f90115f99783",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756680_549_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,618eecd1fa57811c983eeb3b,"OPEN - GENERAL - V3",1636756803,1636756503,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}","N/A",,202183678,medium,"15ed3882-fd8c-4458-86b7-6ce248708d44",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756680_549_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183678 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618eecd6fa57811c983eeb41,"OPEN - GENERAL - V3",1636761004,1636756203,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"5e9f4bef-2e07-4175-9dad-26b08263304a",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756680_549_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618eedfcfa57811c983eeb49,"OPEN - GENERAL - V3",1636761004,1636756503,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"cb5a4930-2f39-4bba-b0ab-42c1fb8addd3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756980_561_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618eee01fa57811c983eeb4f,"OPEN - GENERAL - V3",1636761302,1636756503,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"12c4ce2f-7f48-4ced-9e98-e9599a7b03d4",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636756980_561_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618eef27512a4e102e43b9c6,"OPEN - GENERAL - V3",1636761302,1636756803,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"f4ba5b1e-d500-4aff-b379-1aaedb53273c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636757280_597_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618eef2b512a4e102e43b9cc,"OPEN - GENERAL - V3",1636761604,1636756803,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"68731550-d65a-42ef-8352-932e70c2fd50",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636757280_597_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ef052fa57811c983eeb5b,"OPEN - GENERAL - V3",1636761604,1636757103,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"fc599e9b-313f-4558-923d-46d421c7a0b2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636757580_577_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ef058fa57811c983eeb67,"OPEN - GENERAL - V3",1636761903,1636757103,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"873154f8-f75e-40a8-b94b-ff5a682b2067",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636757580_577_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ef17e512a4e102e43b9d3,"OPEN - GENERAL - V3",1636761903,1636757403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"bab5892e-dc55-4b84-a0a9-dfa90ff03931",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636757880_620_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ef181512a4e102e43b9d8,"OPEN - GENERAL - V3",1636762203,1636757403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"1e7777fa-d65c-4713-9a55-ddd61b31c5d2",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636757880_620_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ef2abb4a8174f7a50e063,"OPEN - GENERAL - V3",1636762203,1636757703,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"1d7b215c-08d6-4de3-a78c-291db6f32471",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636758180_604_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ef2afb4a8174f7a50e068,"OPEN - GENERAL - V3",1636762504,1636757703,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"6c305a2b-55b4-4cd4-b398-34dbfd0c761c",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636758180_604_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ef3d6b4a8174f7a50e06f,"OPEN - GENERAL - V3",1636762504,1636758004,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"77b3cdac-4e24-47da-b503-f3f0641b1c09",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636758480_614_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Porto Velho","GERDAU AÇOS LONGOS S A","155338.0000000",RO,"N/A","SDWAN - VELOCLOUD",202041375,BAIXO,SDWAN,618ef3d7b4a8174f7a50e071,"OPEN - GENERAL - V3",1636759202,1636758302,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}","N/A",,202041375,medium,"13973e8e-becb-40aa-8980-910d9d952582",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636758480_614_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ef3dcb4a8174f7a50e076,"OPEN - GENERAL - V3",1636762803,1636758004,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"428ea1f3-b86e-4606-939e-c8cc06f174f9",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636758480_614_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ef503fa57811c983eec63,"OPEN - GENERAL - V3",1636762803,1636758302,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"c6da278d-1b7f-4aff-950b-8ef6c3e244de",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636758780_623_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ef508fa57811c983eec69,"OPEN - GENERAL - V3",1636763103,1636758302,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"25ee2fd4-2e43-4c70-ab62-db262fa51866",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636758780_623_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ef62d512a4e102e43b9e4,"OPEN - GENERAL - V3",1636763103,1636758605,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"424b901b-02c5-4901-b6fb-8bc42f85f46a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636759080_662_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ef632512a4e102e43b9f0,"OPEN - GENERAL - V3",1636763403,1636758605,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"57ac305e-f108-4936-b587-77f72d343f3a",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636759080_662_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,618f043ffa57811c983eed92,"OPEN - GENERAL - V3",1636762803,1636762504,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}","N/A",,202041378,medium,"2abf81e5-f8de-4761-9da9-3cf643492438",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636762680_763_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618f16fefa57811c983eeeeb,"OPEN - GENERAL - V3",1636782603,1636767004,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"4557f05a-48cc-4a9e-8531-6a67bb08322a",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636767480_929_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",618f551afa57811c983ef396,"OPEN - GENERAL - V3",1636790102,1636782903,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"37c94f36-b939-48e7-a2a0-ba4faa28bbf7",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636783380_1474_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","São Paulo","ICATU SEGUROS S.A","180688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202185145,"DUPLA ABORDAGEM",SDWAN,618f7cf0b4a8174f7a50e9ad,"OPEN - GENERAL - V3",1636793703,1636793403,"alert_manager","","",,"{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}","N/A",,202185145,medium,"d281cfaf-f9ae-4e8b-8381-dd0a0f94b180",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636793580_1775_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185145 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618f958eb4a8174f7a50ebd7,"OPEN - GENERAL - V3",0,1636799702,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,high,"375fa3a9-c987-4986-afef-fdf4c2bfc795",1566,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636799880_1980_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202162229 - Edge 1566 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618f96b8fa57811c983ef8b8,"OPEN - GENERAL - V3",0,1636800002,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,medium,"50cf40d1-e2fd-431f-9494-32257e524bce",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636800180_2043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202162229 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618f96b9fa57811c983ef8ba,"OPEN - GENERAL - V3",0,1636800002,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""5612"", ""interface"": ""GE3""}","N/A",,202162229,medium,"fa293d3b-efd2-453a-9eef-c32b8281140b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636800180_2043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202162229 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618f9910b4a8174f7a50ebde,"OPEN - GENERAL - V3",0,1636800304,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,medium,"ec7bcd09-2e81-4854-8a6c-7da5d9f4896f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636800780_2008_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202162229 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618f9911b4a8174f7a50ebe1,"OPEN - GENERAL - V3",0,1636800304,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""5612"", ""interface"": ""GE3""}","N/A",,202162229,medium,"770c5371-4c7b-4451-94ee-e2aa5f17542f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636800780_2008_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202162229 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618f9b6bb4a8174f7a50ec70,"OPEN - GENERAL - V3",1636814704,1636800903,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"a05ab8a7-2ed3-4ec5-afaa-e0aa6fcda331",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636801380_2026_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,618fae2ab4a8174f7a50eee8,"OPEN - GENERAL - V3",1636806304,1636806003,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"a5f7c34e-052a-4b0b-ae16-a8e7ee1452ad",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636806180_2189_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Maceió","GERDAU AÇOS LONGOS S A","155327.0000000",AL,"N/A","SDWAN - VELOCLOUD",202041364,BAIXO,SDWAN,618faf57512a4e102e43c969,"OPEN - GENERAL - V3",1636819802,1636806003,"alert_manager","","",,"{""edgeId"": ""978"", ""linkId"": ""3207"", ""interface"": ""GE4""}","N/A",,202041364,performance,"df0157bc-70f6-40a3-80fd-b67a6575f561",3207,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636806480_2298_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041364 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Blumenau,"GERDAU AÇOS LONGOS S A","154945.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040653,BAIXO,SDWAN,618fb2d7b4a8174f7a50ef2f,"OPEN - GENERAL - V3",1636808403,1636807203,"alert_manager","","",,"{""edgeId"": ""1132"", ""linkId"": ""2802"", ""interface"": ""GE4""}","N/A",,202040653,medium,"29866f61-9c4a-4d04-8d04-7f82c812238d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636807380_2227_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040653 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,618fc342fa57811c983efb4e,"OPEN - GENERAL - V3",1636811702,1636811402,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"2a093da8-12d2-4f8d-8637-7196384ddf7c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636811580_2424_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Porto Velho","GERDAU AÇOS LONGOS S A","155338.0000000",RO,"N/A","SDWAN - VELOCLOUD",202041375,BAIXO,SDWAN,618fcdcc512a4e102e43cc39,"OPEN - GENERAL - V3",1636814704,1636814104,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}","N/A",,202041375,medium,"982d395e-9c70-478e-9acb-3bd26a791aee",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636814280_2559_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618fd27bfa57811c983efd72,"OPEN - GENERAL - V3",1636821002,1636815304,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}","N/A",,202061983,medium,"093d24d5-2d59-49d2-8636-19cd4b561959",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636815480_2572_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618fd280fa57811c983efd78,"OPEN - GENERAL - V3",1636821904,1636815304,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}","N/A",,202061983,high,"56829610-2c4f-4554-8f58-86c6380e1bb9",1562,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636815480_2572_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061983 - Edge 1562 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618fd3a7b4a8174f7a50f0c1,"OPEN - GENERAL - V3",1636821602,1636815304,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","N/A",,202061983,medium,"9a27bcd5-cd6c-461d-b9c2-f908249e929f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636815780_2521_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618fd4d3512a4e102e43ccc5,"OPEN - GENERAL - V3",1636821602,1636815605,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}","N/A",,202061983,medium,"6f7dcb81-504d-4f11-a2af-71c8f0ebb501",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636816080_2618_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618fe541fa57811c983efe69,"OPEN - GENERAL - V3",1636821304,1636820104,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"5300350d-0134-4ab4-a17d-6b237ca16fe6",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636820280_2746_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618fe66ab4a8174f7a50f238,"OPEN - GENERAL - V3",1636821002,1636820403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"9e751b6e-08d7-478c-8f2f-3d9777de4e08",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636820580_2681_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618fe66eb4a8174f7a50f242,"OPEN - GENERAL - V3",1636821603,1636820104,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"c30c6830-fcb7-4513-a17a-669ed2d66113",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636820580_2681_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618fe796fa57811c983efea8,"OPEN - GENERAL - V3",1636821304,1636820403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"f029e788-c2fd-4a8b-ab5a-ec49d9184d81",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636820880_2762_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618fe79bfa57811c983efead,"OPEN - GENERAL - V3",1636821904,1636820403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"29d33fce-9ffd-40a4-993d-a2452bd43016",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636820880_2762_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618fe8c3b4a8174f7a50f280,"OPEN - GENERAL - V3",1636822203,1636820704,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"8e1a8cf8-bd0d-44d4-85bf-d74ab740e7c4",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636821180_2703_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618fe9ebfa57811c983efeb0,"OPEN - GENERAL - V3",1636821904,1636821304,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}","N/A",,202061983,medium,"5944b409-59a5-4daf-9076-5aab4d66d674",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636821480_2782_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618fec43b4a8174f7a50f284,"OPEN - GENERAL - V3",0,1636821904,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","N/A",,202061983,medium,"7234edef-8686-4cbf-b020-c44d0011947a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636822080_2729_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202061983 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618fefcab4a8174f7a50f30b,"OPEN - GENERAL - V3",1636872003,1636822504,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"4884f5d5-17b3-47e2-86ca-263c65deaea6",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636822980_2761_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Maceió","GERDAU AÇOS LONGOS S A","155327.0000000",AL,"N/A","SDWAN - VELOCLOUD",202041364,BAIXO,SDWAN,618ff5a6512a4e102e43d070,"OPEN - GENERAL - V3",1636838402,1636824003,"alert_manager","","",,"{""edgeId"": ""978"", ""linkId"": ""3207"", ""interface"": ""GE4""}","N/A",,202041364,performance,"3bb3fc5c-e20f-48d7-90a1-27f002557347",3207,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636824480_2891_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041364 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Rio do Sul","GERDAU AÇOS LONGOS S A","155353.0000000",SC,"N/A","SDWAN - VELOCLOUD",202041390,BAIXO,SDWAN,618ff5a7512a4e102e43d072,"OPEN - GENERAL - V3",1636824603,1636824304,"alert_manager","","",,"{""edgeId"": ""997"", ""linkId"": ""1942"", ""interface"": ""GE3""}","N/A",,202041390,high,"ac12d567-5b57-49ce-90db-898796fbbe83",997,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636824480_2891_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041390 - Edge 997 entrou em status DEGRADED",86400,high
"Não","Rio do Sul","GERDAU AÇOS LONGOS S A","155353.0000000",SC,"N/A","SDWAN - VELOCLOUD",202041390,BAIXO,SDWAN,618ff6d1fa57811c983eff8c,"OPEN - GENERAL - V3",1636824904,1636824603,"alert_manager","","",,"{""edgeId"": ""997"", ""linkId"": ""2100"", ""interface"": ""GE4""}","N/A",,202041390,medium,"2c083589-ce31-4c1c-ae5e-9a8f3e566061",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636824780_2903_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041390 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,618ffb80512a4e102e43d0fd,"OPEN - GENERAL - V3",1636826105,1636825803,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"de910182-6055-4c1a-b3ec-b955d7217380",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636825980_2943_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618ffb84512a4e102e43d102,"OPEN - GENERAL - V3",1636826105,1636825803,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"15489869-15f0-410e-a017-4b72d9e15305",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636825980_2943_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status DEGRADED",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61901099b4a8174f7a50f5b8,"OPEN - GENERAL - V3",1636831804,1636831202,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"8f87ed49-3aee-43a3-b702-22e3e086676b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636831380_3052_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,61901d7db4a8174f7a50f658,"OPEN - GENERAL - V3",1636834802,1636834503,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}","N/A",,202041378,medium,"5d993039-2db0-4239-a1a0-f89ca0c0fbf0",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636834680_3178_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,619034edb4a8174f7a50f80e,"OPEN - GENERAL - V3",1636840804,1636840502,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"efda6b58-0291-4a64-ae1c-068d164147d1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636840680_3380_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61904680fa57811c983f054d,"OPEN - GENERAL - V3",1636845302,1636845002,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"17fca0cf-0ff4-400e-9b4b-4e58223dc04c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636845180_3591_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61905b98fa57811c983f0636,"OPEN - GENERAL - V3",1636850703,1636850403,"alert_manager","","",,"{""edgeId"": ""1568"", ""linkId"": ""4268"", ""interface"": ""GE4""}","N/A",,202061992,medium,"2f82c95b-4229-47c6-b5df-bfd2df280e51",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636850580_3764_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061992 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",619063cdb4a8174f7a50fb68,"OPEN - GENERAL - V3",1636853102,1636852503,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"5ece8733-8adf-4b5e-91a2-d7a14587e666",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636852680_3791_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",619064f8512a4e102e43d9f4,"OPEN - GENERAL - V3",1636853404,1636852503,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"9602b8df-7599-42e7-95b8-ac8eaca6043b",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636852980_3842_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61907438fa57811c983f08d9,"OPEN - GENERAL - V3",1636857003,1636856704,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"027ea40a-bb67-4533-a173-2e9a048f5a48",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636856880_3984_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não",Tijucas,"GERDAU AÇOS LONGOS SA","157843.0000000",SC,"",GRC,202044526,MEDIO,MPLS,6190a468b4a8174f7a50ff8f,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636869000,"alert_manager","","",,"N/A","N/A",,"ra096359.igs.gerd",high,"bdf0c001-2ddc-4db0-8fba-84302dc60cc3","GigabitEthernet0/1.3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636869180_4352_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,,critical,45,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096359.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/1.3",86400,high
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",6190a8f3fa57811c983f0c99,"OPEN - GENERAL - V3",1636870504,1636870204,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}","N/A",,201922181,high,"aa58c37a-1387-4f6b-a98a-730a3554ec31",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636870380_4442_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"201922181 - Edge 1105 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6190ba86fa57811c983f0dfb,"OPEN - GENERAL - V3",1636875904,1636874404,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"9f31bb85-c38b-4c33-b126-fbd9ca782589",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636874880_4612_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","São Luís","BANCO LOSANGO S.A. - BANCO MULTIPLO","133335.0000000",MA,"N/A",BRAD,20197442,LOSANGO,SDWAN,6190bcdefa57811c983f0e07,"OPEN - GENERAL - V3",1636875602,1636875304,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}","N/A",,20197442,high,"16751339-848c-446b-ad55-ef8bc52701ff",431,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636875480_4630_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197442 - Edge 431 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6190c18db4a8174f7a510138,"OPEN - GENERAL - V3",1636883704,1636876202,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"92c4e403-f93d-4465-a6b9-fc336747c62f",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636876680_4596_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,6190c510512a4e102e43e2b7,"OPEN - GENERAL - V3",1636877703,1636877402,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}","N/A",,202041378,medium,"5afd52f4-01fb-49c2-b997-380cc416196b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636877580_4689_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041378 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Maringá","PB LOPES & CIA LTDA","170042.0000000",PR,"N/A","SDWAN - VELOCLOUD",202059974,SDWAN,SDWAN,6190da2bb4a8174f7a510312,"OPEN - GENERAL - V3",1636883403,1636882803,"alert_manager","","",,"{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}","N/A",,202059974,high,"5f47bf12-34e1-47ed-89bd-67922703c489",1265,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636882980_4821_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059974 - Edge 1265 entrou em status OFFLINE",86400,high
"Não","Maringá","PB LOPES & CIA LTDA","170042.0000000",PR,"N/A","SDWAN - VELOCLOUD",202059974,SDWAN,SDWAN,6190db53fa57811c983f111f,"OPEN - GENERAL - V3",1636883403,1636883104,"alert_manager","","",,"{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}","N/A",,202059974,medium,"3422ad02-6d5b-4f76-b67b-8973dc56931b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636883280_4877_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059974 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6190ee16b4a8174f7a5104a9,"OPEN - GENERAL - V3",1636963202,1636887604,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"09dc8634-c19b-41f7-af7b-326d7b53853a",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636888080_4986_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,6190ffaa512a4e102e43e6e6,"OPEN - GENERAL - V3",1636892702,1636892405,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"c5fbc9b0-c4e3-4aef-8e05-8786ddda49f2",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636892580_5206_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61911010b4a8174f7a5107f8,"OPEN - GENERAL - V3",1636896903,1636896604,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"da26179e-09ec-4d95-b462-8a3929d5e88f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636896780_5279_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,6191113e512a4e102e43e7c7,"OPEN - GENERAL - V3",1636897204,1636896903,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"e6fc4b4b-93ca-426e-b654-b31d071251f0",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636897080_5360_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6191171a512a4e102e43e8a1,"OPEN - GENERAL - V3",1636904704,1636898403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"5f9e41a3-8a8b-4feb-99d0-5b9e1ff76843",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636898580_5418_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61911845b4a8174f7a510802,"OPEN - GENERAL - V3",1636904403,1636898704,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"fa57eb80-d9e4-48b1-9d47-dbed4f80f010",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636898880_5342_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61911848b4a8174f7a510809,"OPEN - GENERAL - V3",1636905003,1636898403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"5b98ecc8-c1ec-4bd3-946a-1f6369fc3276",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636898880_5342_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61911970512a4e102e43e8e3,"OPEN - GENERAL - V3",1636904704,1636898704,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"5234e15a-e99c-4881-997c-e004e417db43",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636899180_5439_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61911972512a4e102e43e8ea,"OPEN - GENERAL - V3",1636905304,1636898704,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"f7f57fec-bac8-4167-a8ef-99dcaddc3049",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636899180_5439_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61911a9db4a8174f7a510848,"OPEN - GENERAL - V3",1636905003,1636899003,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"abdb259a-772e-4af4-a4a3-3db4f0751a96",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636899480_5365_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61911aa0b4a8174f7a51084c,"OPEN - GENERAL - V3",1636905602,1636899003,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"94d571f2-69be-46ad-ad13-3c7943e2be58",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636899480_5365_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61911bc8512a4e102e43e96c,"OPEN - GENERAL - V3",1636905304,1636899304,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"6b696780-539b-47ce-bcd8-42220c9e8c68",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636899780_5460_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61911bcb512a4e102e43e973,"OPEN - GENERAL - V3",1636905903,1636899304,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"65cac334-4400-4caa-8155-ab38c9df838f",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636899780_5460_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61911cf5fa57811c983f14fa,"OPEN - GENERAL - V3",1636905602,1636899602,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"f4a37b81-9d2d-48ba-a84b-8623c677ccc5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636900080_5451_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61911cf8fa57811c983f14fe,"OPEN - GENERAL - V3",1636906203,1636899602,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"08cc015d-ad9e-4788-ad39-7718b4cee6c9",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636900080_5451_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61911e20512a4e102e43e9f5,"OPEN - GENERAL - V3",1636905903,1636899904,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"8ec1a330-cf78-448f-baa3-9c436063a41f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636900380_5485_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61911e23512a4e102e43e9fc,"OPEN - GENERAL - V3",1636906504,1636899904,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"e7204289-b83b-42de-afc1-360abf4922b6",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636900380_5485_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61911f4d512a4e102e43ea3e,"OPEN - GENERAL - V3",1636906203,1636900202,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"f2eaa18e-7dc3-40a6-be02-846bb113fd34",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636900680_5497_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61911f4f512a4e102e43ea45,"OPEN - GENERAL - V3",1636906803,1636900202,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"524b4254-addf-4876-aa77-63eabb9f1435",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636900680_5497_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61912079b4a8174f7a510854,"OPEN - GENERAL - V3",1636906504,1636900503,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"310688ee-032e-4b1e-a609-b7e540ba7246",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636900980_5418_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6191207cb4a8174f7a51085c,"OPEN - GENERAL - V3",1636907104,1636900503,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"81617cac-b7c0-428d-b5df-b7da27c0927b",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636900980_5418_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",619121a6fa57811c983f1503,"OPEN - GENERAL - V3",1636906803,1636900804,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"79dec861-b299-4146-aaf2-be434e2f3c9c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636901280_5487_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",619121a9fa57811c983f1507,"OPEN - GENERAL - V3",1636907403,1636900804,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"bb521e2d-082f-4b62-834f-b354fbbb310e",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636901280_5487_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",619122d1b4a8174f7a51089d,"OPEN - GENERAL - V3",1636907104,1636901102,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"0137b365-a614-4096-8577-2f42b3136d53",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636901580_5441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",619122d5b4a8174f7a5108a5,"OPEN - GENERAL - V3",1636907704,1636901102,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"5bf7a931-1497-46e5-b5ac-ab25fb2bd453",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636901580_5441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",619123fdfa57811c983f150c,"OPEN - GENERAL - V3",1636907403,1636901403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"ae9e9c95-fd56-4165-b3b5-37147aece4e0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636901880_5509_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61912400fa57811c983f1510,"OPEN - GENERAL - V3",1636908003,1636901403,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"2e0e59b4-a725-47ef-873d-d7e77b74971c",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636901880_5509_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61912529b4a8174f7a5108e5,"OPEN - GENERAL - V3",1636907704,1636901704,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"f9139af1-9054-4842-8ba1-785dec24fe97",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636902180_5460_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6191252cb4a8174f7a5108ed,"OPEN - GENERAL - V3",1636908304,1636901704,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"8f6038de-684a-442f-b6bd-75fee97eda92",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636902180_5460_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61912654512a4e102e43eb07,"OPEN - GENERAL - V3",1636908003,1636902003,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"1c173bc0-42aa-4e98-a4f3-656df1a3c8c1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636902480_5548_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61912657512a4e102e43eb0e,"OPEN - GENERAL - V3",1636908603,1636902003,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"0eb6a636-e845-4a1c-bb16-9d1b9a43af1e",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636902480_5548_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61912781fa57811c983f1518,"OPEN - GENERAL - V3",1636908304,1636902304,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"ebea59c2-2160-44fd-9466-c79d7a4bb3b1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636902780_5539_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Maceió","GERDAU AÇOS LONGOS S A","155327.0000000",AL,"N/A","SDWAN - VELOCLOUD",202041364,BAIXO,SDWAN,61912785fa57811c983f1520,"OPEN - GENERAL - V3",1636903802,1636902304,"alert_manager","","",,"{""edgeId"": ""978"", ""linkId"": ""3207"", ""interface"": ""GE4""}","N/A",,202041364,performance,"6b8d5ec0-d44f-4f2f-b73c-42c23eebe9d0",3207,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636902780_5539_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041364 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61912786fa57811c983f1523,"OPEN - GENERAL - V3",1636908904,1636902304,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"51d735ad-70ca-4012-bdfd-5460751b4d21",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636902780_5539_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",619128ac512a4e102e43eb4d,"OPEN - GENERAL - V3",1636908603,1636902603,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"f928d64c-c6ac-448c-95ed-09b803173cf8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636903080_5568_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",619128b0512a4e102e43eb52,"OPEN - GENERAL - V3",1636909203,1636902603,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"5f707435-2ea3-4b9a-b967-b994b8ec1fba",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636903080_5568_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",619129d8512a4e102e43eb5a,"OPEN - GENERAL - V3",1636908904,1636902904,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"1fd939b2-27b3-4a9e-b700-7af1465beca1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636903380_5575_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",619129dc512a4e102e43eb63,"OPEN - GENERAL - V3",1636909505,1636902904,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"d9a470f7-42c8-4726-8409-d57f1361dde1",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636903380_5575_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61912b05512a4e102e43eba1,"OPEN - GENERAL - V3",1636909203,1636903202,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"a85120d7-45a3-4a30-bb04-ba79e5f551f3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636903680_5586_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61912b09512a4e102e43eba6,"OPEN - GENERAL - V3",1636909803,1636903202,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"20ea331f-ec7a-42ed-b245-93f905ddae91",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636903680_5586_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61912c31fa57811c983f15e0,"OPEN - GENERAL - V3",1636909505,1636903504,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"961aad15-04da-4614-8f23-cb4aa9c19f49",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636903980_5578_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61912c34fa57811c983f15e4,"OPEN - GENERAL - V3",1636910104,1636903504,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"7c4e63fd-a056-47a7-a9df-7f02ea7e5f0c",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636903980_5578_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61912d5db4a8174f7a51096f,"OPEN - GENERAL - V3",1636909803,1636903802,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",medium,"2ef1a718-445f-4d1e-a66e-19b6509ed85c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636904280_5545_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61912d61b4a8174f7a510976,"OPEN - GENERAL - V3",1636904403,1636904104,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,high,"ac74fce5-5d83-41c3-a3e4-267100d053a1",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636904280_5545_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61912d61b4a8174f7a510979,"OPEN - GENERAL - V3",1636910403,1636903802,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"f5a96784-451d-481f-8441-083ebae79d68",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636904280_5545_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61912e8bfa57811c983f15f0,"OPEN - GENERAL - V3",1636910704,1636904104,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"9ebeedf6-a77c-49ba-a81d-6e81a33b4c7e",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636904580_5595_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não",Imperatriz,"GERDAU AÇOS LONGOS S A","154967.0000000",MA,"N/A","SDWAN - VELOCLOUD",202040665,BAIXO,SDWAN,61912fb5fa57811c983f1630,"OPEN - GENERAL - V3",1636905003,1636904704,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}","N/A",,202040665,medium,"fb176e1c-32f8-4ca5-a71b-1f875d447e02",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636904880_5605_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040665 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Pelotas,"GERDAU AÇOS LONGOS S A","155336.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041373,BAIXO,SDWAN,619137e8512a4e102e43ec78,"OPEN - GENERAL - V3",1636907104,1636906803,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}","N/A",,202041373,medium,"a4291a49-b7a0-40bb-bd46-861b9fcd343a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636906980_5706_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041373 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Ananindeua,"GERDAU AÇOS LONGOS S A","154764.0000000",PA,"N/A","SDWAN - VELOCLOUD",202040625,BAIXO,SDWAN,61914275b4a8174f7a510ad5,"OPEN - GENERAL - V3",1636921802,1636909505,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2326"", ""interface"": ""GE3""}","N/A",,202040625,medium,"95620e55-199b-4167-88ee-606330a651ba",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636909680_5719_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040625 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Sinop,"GERDAU AÇOS LONGOS S A","155346.0000000",MT,"N/A","SDWAN - VELOCLOUD",202041383,BAIXO,SDWAN,6191439fb4a8174f7a510adb,"OPEN - GENERAL - V3",1636915804,1636909803,"alert_manager","","",,"{""edgeId"": ""1003"", ""linkId"": ""2838"", ""interface"": ""GE4""}","N/A",,202041383,medium,"d63fffe4-d028-4f5b-8dc1-c04dd12f431f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636909980_5731_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041383 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,6191497d512a4e102e43edd7,"OPEN - GENERAL - V3",1636912503,1636911302,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,medium,"52f76517-a5ab-4475-8205-bde9d99a63c2",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636911480_5859_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61914e2f512a4e102e43edeb,"OPEN - GENERAL - V3",1636912804,1636912503,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"4948047f-f248-417a-9c67-84dfd8b075f9",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636912680_5901_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status OFFLINE",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61914f59512a4e102e43edf2,"OPEN - GENERAL - V3",1636937404,1636912804,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,medium,"70fc963d-ad3c-4607-b1c9-fdff5baf4449",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636912980_5915_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61915089512a4e102e43edff,"OPEN - GENERAL - V3",1636913703,1636913103,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"a7a997de-a39b-469a-a164-53cb56267d49",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636913280_5928_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61915538512a4e102e43ee92,"OPEN - GENERAL - V3",1636914603,1636914303,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"ca357f59-e508-4c06-80f7-328fcb2cbac2",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636914480_5977_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status OFFLINE",86400,high
"Não",Ananindeua,"GERDAU AÇOS LONGOS S A","154764.0000000",PA,"N/A","SDWAN - VELOCLOUD",202040625,BAIXO,SDWAN,61915e96512a4e102e43eeea,"OPEN - GENERAL - V3",1636928404,1636916703,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2327"", ""interface"": ""GE4""}","N/A",,202040625,medium,"0e96e504-616b-4b52-b872-8e0af4a635db",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636916880_6048_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040625 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Ananindeua,"GERDAU AÇOS LONGOS S A","154764.0000000",PA,"N/A","SDWAN - VELOCLOUD",202040625,BAIXO,SDWAN,61915e99512a4e102e43eeee,"OPEN - GENERAL - V3",1636921802,1636916703,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2326"", ""interface"": ""GE3""}","N/A",,202040625,high,"a15f76cd-7f15-498a-95ef-709f52a8329d",941,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636916880_6048_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040625 - Edge 941 entrou em status OFFLINE",86400,high
"Não",Ananindeua,"GERDAU AÇOS LONGOS S A","154764.0000000",PA,"N/A","SDWAN - VELOCLOUD",202040625,BAIXO,SDWAN,619160eeb4a8174f7a510ee4,"OPEN - GENERAL - V3",1636928702,1636917003,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2327"", ""interface"": ""GE4""}","N/A",,202040625,medium,"de83035c-3ada-431b-9006-dfa4b2c3bcbc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636917480_5991_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040625 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,6191621fb4a8174f7a510ef2,"OPEN - GENERAL - V3",1636917903,1636917604,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"ca6d3af4-1f9f-466c-9130-615882b43173",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636917780_5999_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status OFFLINE",86400,high
"Não","Cuiabá","ICATU SEGUROS S.A","169174.0000000",MT,"N/A","SDWAN - VELOCLOUD",202058771,"ABORDAGEM SIMPLES",SDWAN,6191659f512a4e102e43ef81,"OPEN - GENERAL - V3",1636925404,1636918203,"alert_manager","","",,"{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}","N/A",,202058771,performance,"c127d6f0-95a9-416c-af5a-3fb20da39cfc",3878,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636918680_6107_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202058771 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6191659f512a4e102e43ef83,"OPEN - GENERAL - V3",1636925404,1636918203,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","N/A",,202062009,performance,"a2bbe8ba-f43c-4486-8050-210298016e9c",4254,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636918680_6107_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202062009 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,619165a2512a4e102e43ef87,"OPEN - GENERAL - V3",1636925403,1636918203,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2097"", ""interface"": ""GE4""}","N/A",,202041386,performance,"a805dc8d-285d-497e-9430-25b5bdbcf32f",2097,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636918680_6107_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041386 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61916921fa57811c983f1a68,"OPEN - GENERAL - V3",1636921802,1636919403,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"6afd7128-66dd-40e0-a430-c07a1fa6cbf7",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636919580_6106_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61916a4c512a4e102e43efdb,"OPEN - GENERAL - V3",1636922104,1636919403,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"98e2dd4a-8bc5-4ab1-989e-efd5a8ef3c20",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636919880_6151_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61916b79512a4e102e43efea,"OPEN - GENERAL - V3",1636922403,1636919702,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"62b2df4f-72fb-4f1d-8752-34d777b0a7b1",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636920180_6163_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61916b80512a4e102e43eff4,"OPEN - GENERAL - V3",1636920304,1636920002,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"6be2fba4-00e5-40e3-a750-dfe6f8ef17c1",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636920180_6163_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61916ca4512a4e102e43effc,"OPEN - GENERAL - V3",1636922704,1636920002,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"5c14cc86-9d8d-43e0-9b48-11733e148f3e",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636920480_6176_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61916dd1fa57811c983f1ab7,"OPEN - GENERAL - V3",1636923003,1636920304,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"9a62bb40-0fd1-4054-9cc7-a66d59461eae",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636920780_6139_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61916efdb4a8174f7a51100f,"OPEN - GENERAL - V3",1636923302,1636920602,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"510e59e2-b07e-490c-a2ce-7705552aac45",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636921080_6104_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61917029fa57811c983f1b09,"OPEN - GENERAL - V3",1636923603,1636920904,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"bd5cdc95-e30b-4497-8bc0-7b7f5a5e3270",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636921380_6156_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61917155512a4e102e43f00b,"OPEN - GENERAL - V3",1636923903,1636921203,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"c7748f7b-cd77-46b1-8a6e-5d68cf133cc4",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636921680_6225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,619174e1fa57811c983f1be2,"OPEN - GENERAL - V3",1636922704,1636922403,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"3eb2c189-61c6-4d0a-9664-05d115962673",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636922580_6191_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status OFFLINE",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61917738fa57811c983f1c44,"OPEN - GENERAL - V3",1636923302,1636923002,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"256bd32c-451e-4980-8f9d-fca338eb6d27",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636923180_6212_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status OFFLINE",86400,high
"Não",Natal,"GERDAU AÇOS LONGOS S A","155330.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041367,BAIXO,SDWAN,619188c7512a4e102e43f0ed,"OPEN - GENERAL - V3",1636938004,1636927203,"alert_manager","","",,"{""edgeId"": ""984"", ""linkId"": ""2221"", ""interface"": ""GE4""}","N/A",,202041367,performance,"084d0970-5e79-46a0-8efd-cb62ebd5a610",2221,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636927680_6443_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041367 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61919228512a4e102e43f1ff,"OPEN - GENERAL - V3",1636930204,1636929903,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,high,"c4da69be-00b0-4524-adb1-4cb91822e5ad",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636930080_6517_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61919b89fa57811c983f1ed3,"OPEN - GENERAL - V3",1636932603,1636932304,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,high,"31f6bb7f-8a49-4525-a5b1-afd4abbb7eb4",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636932480_6526_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status OFFLINE",86400,high
"Não","São Luís","BANCO LOSANGO S.A. - BANCO MULTIPLO","133335.0000000",MA,"N/A",BRAD,20197442,LOSANGO,SDWAN,6191a86b512a4e102e43f430,"OPEN - GENERAL - V3",1636935904,1636935603,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}","N/A",,20197442,high,"6e95506c-5fea-4865-887e-399597d6de58",431,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636935780_6709_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197442 - Edge 431 entrou em status OFFLINE",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,6191af71b4a8174f7a511489,"OPEN - GENERAL - V3",1636937702,1636937404,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"35a05604-460c-40ea-bf4b-87c72512439d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636937580_6671_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,6191d3c7b4a8174f7a511706,"OPEN - GENERAL - V3",1636947002,1636946704,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"996e1554-3fcd-4bee-a792-053bfdfee909",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636946880_6998_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","Jundiaí","GERDAU AÇOS LONGOS S A","154952.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040645,BAIXO,SDWAN,6191e0a8512a4e102e43fa50,"OPEN - GENERAL - V3",1636956904,1636950003,"alert_manager","","",,"{""edgeId"": ""919"", ""linkId"": ""2108"", ""interface"": ""GE4""}","N/A",,202040645,medium,"e324e761-a00b-49a8-80bf-154e1072399b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636950180_7177_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040645 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e302512a4e102e43fa61,"OPEN - GENERAL - V3",0,1636950604,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","N/A",,202041369,medium,"56e80a05-884b-4afd-a629-a3323e882d84",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636950780_7192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041369 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e302512a4e102e43fa64,"OPEN - GENERAL - V3",0,1636950604,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}","N/A",,202041369,medium,"c1c32317-0d7a-4a75-82aa-b053b014b87b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636950780_7192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041369 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e305512a4e102e43fa6b,"OPEN - GENERAL - V3",0,1636950604,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","N/A",,202041369,high,"9ae3f712-9dae-4155-84f9-9e39d6815e10",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636950780_7192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202041369 - Edge 986 entrou em status OFFLINE",86400,high
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e55afa57811c983f23ad,"OPEN - GENERAL - V3",0,1636950902,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","N/A",,202041369,medium,"b7032d49-e20e-48fb-bf37-b7bc9bcac22c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636951380_7172_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041369 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e55bfa57811c983f23af,"OPEN - GENERAL - V3",0,1636950902,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}","N/A",,202041369,medium,"981f983d-924d-4668-8da1-67937e68a0a5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636951380_7172_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041369 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Cuiabá","BANCO LOSANGO S.A. - BANCO MULTIPLO","133302.0000000",MT,"N/A",BRAD,20197427,LOSANGO,SDWAN,6191fa71b4a8174f7a511a48,"OPEN - GENERAL - V3",1636956904,1636956602,"alert_manager","","",,"{""edgeId"": ""413"", ""linkId"": ""1075"", ""interface"": ""GE4""}","N/A",,20197427,medium,"9a14699f-d296-4624-a006-c1754f196137",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636956780_7336_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197427 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Rio de Janeiro","BANCO LOSANGO S.A. - BANCO MULTIPLO","133309.0000000",RJ,"N/A",BRAD,20197431,LOSANGO,SDWAN,61921692b4a8174f7a511cc2,"OPEN - GENERAL - V3",1636964102,1636963803,"alert_manager","","",,"{""edgeId"": ""423"", ""linkId"": ""1021"", ""interface"": ""GE3""}","N/A",,20197431,high,"f4ec1278-9809-4092-afff-6d2ac63f3115",423,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636963980_7569_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197431 - Edge 423 entrou em status DEGRADED",86400,high
"Não","Cuiabá","BANCO LOSANGO S.A. - BANCO MULTIPLO","133302.0000000",MT,"N/A",BRAD,20197427,LOSANGO,SDWAN,61922376fa57811c983f2915,"OPEN - GENERAL - V3",1636967703,1636967103,"alert_manager","","",,"{""edgeId"": ""413"", ""linkId"": ""1057"", ""interface"": ""GE3""}","N/A",,20197427,high,"910f6d5a-a501-4469-bf6d-2078ff297dd0",413,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636967280_7733_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197427 - Edge 413 entrou em status DEGRADED",86400,high
"Não","Cuiabá","BANCO LOSANGO S.A. - BANCO MULTIPLO","133302.0000000",MT,"N/A",BRAD,20197427,LOSANGO,SDWAN,619225cdfa57811c983f291b,"OPEN - GENERAL - V3",0,1636967703,"alert_manager","","",,"{""edgeId"": ""413"", ""linkId"": ""1057"", ""interface"": ""GE3""}","N/A",,20197427,medium,"3f615b55-c32c-4246-88ff-09ec874daadb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636967880_7757_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"20197427 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Bauru,"GERDAU AÇOS LONGOS S A","154944.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040652,BAIXO,SDWAN,619225cefa57811c983f291d,"OPEN - GENERAL - V3",1636968003,1636967703,"alert_manager","","",,"{""edgeId"": ""949"", ""linkId"": ""3015"", ""interface"": ""GE4""}","N/A",,202040652,medium,"4a52c0f5-1fd8-4609-997e-fcebbd396a35",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636967880_7757_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040652 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619232b1b4a8174f7a511f72,"OPEN - GENERAL - V3",1636971302,1636971004,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"091766de-9672-4de2-a4fb-d62fb23f2873",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636971180_7821_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61923763fa57811c983f29b4,"OPEN - GENERAL - V3",0,1636971902,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"3d29f6b4-43f6-449e-be91-3ffabe443aa4",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636972380_7917_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61924a21b4a8174f7a512116,"OPEN - GENERAL - V3",1636977302,1636977004,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"e02ac0c9-b9c3-4384-8e28-8f6f87c09ba0",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636977180_8016_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não",Guarapuava,"GERDAU AÇOS LONGOS S A","154966.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040664,BAIXO,SDWAN,61925ce2fa57811c983f2bea,"OPEN - GENERAL - V3",1636999503,1636981802,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}","N/A",,202040664,medium,"0061158b-5fc9-4f11-aa2a-c33d04905b3a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636981980_8241_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040664 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,61925f3dfa57811c983f2bf5,"OPEN - GENERAL - V3",0,1636982402,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}","N/A",,202041381,high,"b14f40a2-e495-4bce-9a25-685fd0f96001",1002,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636982580_8261_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202041381 - Edge 1002 entrou em status DEGRADED",86400,high
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,61926064fa57811c983f2bfa,"OPEN - GENERAL - V3",0,1636982702,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}","N/A",,202041381,medium,"1d737c82-ff4f-41a4-9a5a-93ad149c2e38",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636982880_8269_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041381 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,61926065fa57811c983f2bfd,"OPEN - GENERAL - V3",0,1636982702,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","N/A",,202041381,medium,"cca8ab8c-70b5-4d50-9f35-f2133e912588",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636982880_8269_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041381 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,61926197b4a8174f7a512316,"OPEN - GENERAL - V3",0,1636982702,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}","N/A",,202041381,high,"3e2c0fa8-80d8-4834-86c5-9ae7a7a4ba9a",1002,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636983180_8233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202041381 - Edge 1002 entrou em status OFFLINE",86400,high
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,619262bbb4a8174f7a512350,"OPEN - GENERAL - V3",0,1636983003,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}","Equipamento PSYS","",202041381,medium,"47691844-39df-4d42-95eb-708cb2cf8c5a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636983480_8247_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"_PCBU1709-1-1334787499_",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_Primesys"": ""PCBU1709-1-1334787499"", ""Identificador_TT_Cliente"": ""47691844-39df-4d42-95eb-708cb2cf8c5a"", ""Descricao"": ""__201749053 --- 2021nov15/TESTE 1, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": """", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",new,"","",2,"202041381 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,619262bcb4a8174f7a512352,"OPEN - GENERAL - V3",0,1636983003,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","N/A",,202041381,medium,"c0f9e563-fb9d-4985-8e12-bd0c47dbcc4c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636983480_8247_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041381 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Rio de Janeiro","ASSOCIAÇÃO DOS LOJISTAS DO SHOPPING CENTER DA BARRA","169737.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202059394,LOJA,SDWAN,61927325b4a8174f7a512516,"OPEN - GENERAL - V3",1636996802,1636987503,"alert_manager","","",,"{""edgeId"": ""1383"", ""linkId"": ""3604"", ""interface"": ""SFP1""}","Falta de energia","",202059394,medium,"3dcdcfb1-64fc-4ebf-850a-ec56cdb63583",SFP1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636987680_8384_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,teste,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059394 - Link SFP1 entrou em status DISCONNECTED",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61928bc8512a4e102e440854,"OPEN - GENERAL - V3",1636994102,1636993803,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"95021829-809a-47cd-aa19-7ae759f553ac",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636993980_8639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não",Cascavel,"GERDAU AÇOS LONGOS S A","154947.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040655,BAIXO,SDWAN,619292cffa57811c983f3018,"OPEN - GENERAL - V3",1636996204,1636995604,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}","N/A",,202040655,high,"366ce4aa-c1d3-45e4-bddf-5d315b19e3d2",955,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636995780_8730_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040655 - Edge 955 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192977c512a4e102e44094c,"OPEN - GENERAL - V3",1636997102,1636996802,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"b66d4574-c80a-48b0-a8ad-2cdc227915bb",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636996980_8732_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","Uberlândia","GERDAU AÇOS LONGOS S A","154973.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040671,BAIXO,SDWAN,61929c2c512a4e102e4409e4,"OPEN - GENERAL - V3",1636998304,1636998051,"alert_manager","","",,"{""edgeId"": ""1007"", ""linkId"": ""2277"", ""interface"": ""GE4""}","N/A",,202040671,high,"18989321-aae7-4349-b74e-e211379e338a",1007,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998180_8786_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040671 - Edge 1007 entrou em status DEGRADED",86400,high
"Não","Cuiabá","BANCO LOSANGO S.A. - BANCO MULTIPLO","133302.0000000",MT,"N/A",BRAD,20197427,LOSANGO,SDWAN,61929c2e512a4e102e4409e7,"OPEN - GENERAL - V3",1636998304,1636998051,"alert_manager","","",,"{""edgeId"": ""413"", ""linkId"": ""1057"", ""interface"": ""GE3""}","N/A",,20197427,high,"ca0138ce-9883-4d5b-b8a2-227bd8105b57",413,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998180_8786_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197427 - Edge 413 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61929c2f512a4e102e4409ea,"OPEN - GENERAL - V3",1636998304,1636998051,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"b05a1c21-0d7d-45ee-9631-ff854bbb0c1d",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998180_8786_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não",Londrina,"GERDAU AÇOS LONGOS S A","155326.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041363,BAIXO,SDWAN,61929c31512a4e102e4409ed,"OPEN - GENERAL - V3",1636998304,1636998051,"alert_manager","","",,"{""edgeId"": ""977"", ""linkId"": ""2156"", ""interface"": ""GE4""}","N/A",,202041363,high,"8448e140-ada0-44cc-ada7-373530483fe9",977,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998180_8786_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041363 - Edge 977 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61929e81fa57811c983f311d,"OPEN - GENERAL - V3",1636998915,1636998603,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""4083"", ""interface"": ""GE4""}","N/A",,202062005,medium,"b6b9ef1c-0770-454b-b91d-09187f3b418a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998780_8824_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062005 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61929e82fa57811c983f311f,"OPEN - GENERAL - V3",1636998915,1636998603,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""5301"", ""interface"": ""GE3""}","N/A",,202062005,medium,"0fd4e63f-4856-4405-84b7-4d63c72182ac",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998780_8824_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062005 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Blumenau,"GERDAU AÇOS LONGOS S A","154945.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040653,BAIXO,SDWAN,61929e88fa57811c983f3126,"OPEN - GENERAL - V3",1636998915,1636998603,"alert_manager","","",,"{""edgeId"": ""1132"", ""linkId"": ""2787"", ""interface"": ""GE3""}","N/A",,202040653,high,"3c199a77-9cdb-4d3a-b4f1-2e1c6ad065c0",1132,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998780_8824_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040653 - Edge 1132 entrou em status DEGRADED",86400,high
"Não","Ribeirão Preto","ICATU SEGUROS S.A","171686.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062011,"ABORDAGEM SIMPLES",SDWAN,61929e8afa57811c983f3129,"OPEN - GENERAL - V3",1636998915,1636998603,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}","N/A",,202062011,high,"8f5fe200-52e4-44f6-be96-dbfc8f46388f",1581,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998780_8824_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062011 - Edge 1581 entrou em status OFFLINE",86400,high
"Não","Brasília","CONDOMINIO DO PARKSHOPPING","155263.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041338,LOJA,SDWAN,61929e8cfa57811c983f312c,"OPEN - GENERAL - V3",1636998915,1636998603,"alert_manager","","",,"{""edgeId"": ""927"", ""linkId"": ""3318"", ""interface"": ""GE3""}","N/A",,202041338,high,"8880563d-f2f8-476c-b3f8-1958f06ffe84",927,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636998780_8824_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041338 - Edge 927 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61929fb1fa57811c983f3136,"OPEN - GENERAL - V3",1636999205,1636998915,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"2fb33b8e-de01-41d6-9f62-13c19f72cfae",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636999080_8833_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192a0ddb4a8174f7a51288c,"OPEN - GENERAL - V3",1636999503,1636999205,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","N/A",,202062009,high,"50f7bf81-7a22-4b27-8114-4124c8823d88",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636999380_8771_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062009 - Edge 1580 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192ab64fa57811c983f31fc,"OPEN - GENERAL - V3",1637002204,1637001908,"alert_manager","","",,"{""edgeId"": ""1569"", ""linkId"": ""4222"", ""interface"": ""GE3""}","N/A",,202062019,medium,"13edde20-94d1-4f1e-ab3a-0842a98ca7d2",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002080_8922_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062019 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192ab65fa57811c983f31ff,"OPEN - GENERAL - V3",1637002204,1637001908,"alert_manager","","",,"{""edgeId"": ""1569"", ""linkId"": ""4223"", ""interface"": ""GE4""}","N/A",,202062019,medium,"9b03685e-c335-48b8-af5c-fed638177687",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002080_8922_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062019 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192ab67fa57811c983f3204,"OPEN - GENERAL - V3",1637002502,1637001908,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""4282"", ""interface"": ""GE3""}","N/A",,202062023,medium,"b04f7b25-7f48-43d1-a4a8-c47d0cb07572",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002080_8922_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062023 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192ab68fa57811c983f3207,"OPEN - GENERAL - V3",1637003104,1637001908,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""4283"", ""interface"": ""GE4""}","N/A",,202062023,medium,"4c6ac24d-eefd-4383-bae4-898b1bd66b9e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002080_8922_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062023 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192ab69fa57811c983f320a,"OPEN - GENERAL - V3",1637002204,1637001908,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}","N/A",,202062023,medium,"2d8ec0b0-e20b-4d81-ba4c-d5c9a313267d",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002080_8922_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192ab6bfa57811c983f320f,"OPEN - GENERAL - V3",1637002204,1637001908,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1582"", ""interface"": ""GE3""}","N/A",,202058019,medium,"1f4bd831-b7b9-4cc0-a79c-89d3f40206fe",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002080_8922_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058019 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192ab6cfa57811c983f3212,"OPEN - GENERAL - V3",1637002204,1637001908,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1583"", ""interface"": ""GE4""}","N/A",,202058019,medium,"7e95872e-3614-4a2a-98e9-59bd746ab029",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002080_8922_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058019 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192ab6ffa57811c983f321a,"OPEN - GENERAL - V3",1637002502,1637001908,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""4282"", ""interface"": ""GE3""}","N/A",,202062023,high,"b4c99963-6d87-4f65-8eb0-cf0cab77eb9b",1585,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002080_8922_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062023 - Edge 1585 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6192adbd512a4e102e440b78,"OPEN - GENERAL - V3",1637003452,1637002204,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""4283"", ""interface"": ""GE4""}","N/A",,202062023,medium,"2d545525-2fc1-4b34-a08d-59becc6a0561",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637002680_8947_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062023 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6192b145fa57811c983f3254,"OPEN - GENERAL - V3",1637003705,1637003452,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}","N/A",,202061999,high,"d2f64207-fbc5-458f-967c-85142c526943",1572,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637003580_8976_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061999 - Edge 1572 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192b26dfa57811c983f325a,"OPEN - GENERAL - V3",1637004003,1637003705,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,medium,"acf6c7ef-5542-4d4f-a21d-28519d034233",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637003880_8983_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192b26efa57811c983f325c,"OPEN - GENERAL - V3",1637004003,1637003705,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3602"", ""interface"": ""GE4""}","N/A",,202041328,medium,"5658b1f1-fc83-443f-9859-4c9063273daa",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637003880_8983_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192b271fa57811c983f3260,"OPEN - GENERAL - V3",1637004315,1637003705,"alert_manager","","",,"{""edgeId"": ""1047"", ""linkId"": ""1862"", ""interface"": ""GE3""}","N/A",,202058018,high,"60efe89f-1e8b-477e-bd01-ff35818212e5",1047,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637003880_8983_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058018 - Edge 1047 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192b273fa57811c983f3263,"OPEN - GENERAL - V3",1637004315,1637003705,"alert_manager","","",,"{""edgeId"": ""1583"", ""linkId"": ""4385"", ""interface"": ""GE3""}","N/A",,202062015,high,"221e99e9-6c42-47ed-a069-ede8b32da351",1583,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637003880_8983_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062015 - Edge 1583 entrou em status DEGRADED",86400,high
"Não","Jundiaí","GERDAU AÇOS LONGOS S A","154952.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040645,BAIXO,SDWAN,6192b275fa57811c983f3266,"OPEN - GENERAL - V3",1637004315,1637003705,"alert_manager","","",,"{""edgeId"": ""919"", ""linkId"": ""1958"", ""interface"": ""GE3""}","N/A",,202040645,high,"32346aa3-ed48-4a25-a92e-5a31b5a5bc36",919,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637003880_8983_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040645 - Edge 919 entrou em status DEGRADED",86400,high
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,6192b398b4a8174f7a5129bb,"OPEN - GENERAL - V3",0,1637004003,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}","N/A",,202062013,medium,"2881d67c-20fe-4086-88d4-4766f0a9fcaf",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637004180_8945_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202062013 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6192b39eb4a8174f7a5129c9,"OPEN - GENERAL - V3",1637004315,1637004003,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}","N/A",,202061999,high,"23abf221-b004-4573-af47-c6cc808c28ad",1572,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637004180_8945_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061999 - Edge 1572 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192b977512a4e102e440c8b,"OPEN - GENERAL - V3",1637006106,1637005505,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"3f53e1a8-7520-4e3b-a5bb-e071e9437407",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637005680_9040_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,6192bbcdfa57811c983f333d,"OPEN - GENERAL - V3",1637006704,1637006106,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4914"", ""interface"": ""GE3""}","N/A",,202062013,medium,"58773ad0-35ff-4415-8b30-4534e573bf2a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637006280_9073_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062013 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","ICATU SEGUROS S.A.","134539.0000000",SC,"N/A","SDWAN - VELOCLOUD",20199724,"DUPLA ABORDAGEM",SDWAN,6192bbcefa57811c983f3340,"OPEN - GENERAL - V3",1637006704,1637006106,"alert_manager","","",,"{""edgeId"": ""333"", ""linkId"": ""645"", ""interface"": ""GE3""}","N/A",,20199724,medium,"f61d81a2-437b-43d4-97df-24686c2da3b9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637006280_9073_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20199724 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Novo Hamburgo","GERDAU AÇOS LONGOS S A","155331.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041368,BAIXO,SDWAN,6192bbcffa57811c983f3345,"OPEN - GENERAL - V3",1637006704,1637006106,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2218"", ""interface"": ""GE3""}","N/A",,202041368,medium,"bc68ea90-97b6-4ed1-8106-49fd41cbbcda",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637006280_9073_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041368 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Ponta Grossa","GERDAU AÇOS LONGOS S A","155337.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041374,BAIXO,SDWAN,6192bbd0fa57811c983f3348,"OPEN - GENERAL - V3",1637006704,1637006106,"alert_manager","","",,"{""edgeId"": ""991"", ""linkId"": ""1914"", ""interface"": ""GE4""}","N/A",,202041374,medium,"6f5feda9-a275-41da-b10a-a6c484b5c319",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637006280_9073_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041374 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Rio do Sul","GERDAU AÇOS LONGOS S A","155353.0000000",SC,"N/A","SDWAN - VELOCLOUD",202041390,BAIXO,SDWAN,6192bbd1fa57811c983f334b,"OPEN - GENERAL - V3",1637006704,1637006106,"alert_manager","","",,"{""edgeId"": ""997"", ""linkId"": ""1942"", ""interface"": ""GE3""}","N/A",,202041390,medium,"dbc7fcfa-e350-4401-b263-041c64ea3f21",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637006280_9073_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041390 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São Luís","BANCO LOSANGO S.A. - BANCO MULTIPLO","133335.0000000",MA,"N/A",BRAD,20197442,LOSANGO,SDWAN,6192bbd5fa57811c983f3352,"OPEN - GENERAL - V3",1637006704,1637006106,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}","N/A",,20197442,high,"ce9fbf1b-e00d-4463-b475-3fe730c6048b",431,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637006280_9073_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197442 - Edge 431 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6192c2d5b4a8174f7a512b1c,"OPEN - GENERAL - V3",1637008225,1637007977,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"f396a6fb-78ee-47c0-aa88-a57e7c3ea71a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637008080_9082_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192c2d9b4a8174f7a512b26,"OPEN - GENERAL - V3",1637008225,1637007977,"alert_manager","","",,"{""edgeId"": ""1570"", ""linkId"": ""4294"", ""interface"": ""GE4""}","N/A",,202061996,high,"d66fa9f2-295f-46d3-afb2-ecd8a67fd109",1570,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637008080_9082_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061996 - Edge 1570 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192c404b4a8174f7a512b6c,"OPEN - GENERAL - V3",1637008502,1637008225,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"8ad73b96-f11d-4edd-a04a-c68d3ef89606",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637008380_9092_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","Ladário","PB LOPES & CIA LTDA","170046.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059978,SDWAN,SDWAN,6192cb06512a4e102e440d9e,"OPEN - GENERAL - V3",1637010623,1637010032,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}","N/A",,202059978,medium,"2b6c9b62-3ecd-403a-a957-f0d4e43aa34e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637010180_9196_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059978 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Dourados,"GERDAU AÇOS LONGOS S A","154962.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040660,BAIXO,SDWAN,6192cb09512a4e102e440da7,"OPEN - GENERAL - V3",1637010623,1637010032,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2195"", ""interface"": ""GE3""}","N/A",,202040660,medium,"029959eb-1cb2-44b0-8c6d-bcb4fc462d87",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637010180_9196_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040660 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Dourados,"GERDAU AÇOS LONGOS S A","154962.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040660,BAIXO,SDWAN,6192cb0a512a4e102e440daa,"OPEN - GENERAL - V3",1637010623,1637010032,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2196"", ""interface"": ""GE4""}","N/A",,202040660,medium,"64aadb60-4a8c-40e7-b340-cb9681f9cde2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637010180_9196_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040660 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Recife,"ICATU SEGUROS S.A","159551.0000000",PE,"N/A","SDWAN - VELOCLOUD",202046760,"ABORDAGEM SIMPLES",SDWAN,6192cb0d512a4e102e440db2,"OPEN - GENERAL - V3",1637010623,1637010032,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}","N/A",,202046760,high,"5225ed49-a8f6-4c76-b4dc-d97fad115dac",1119,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637010180_9196_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202046760 - Edge 1119 entrou em status DEGRADED",86400,high
"Não","Rio das Ostras","VALLOUREC TUBULAR SOLUTIONS LTDA","168652.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202058025,SDWAN,SDWAN,6192cb0f512a4e102e440db7,"OPEN - GENERAL - V3",1637010623,1637010032,"alert_manager","","",,"{""edgeId"": ""461"", ""linkId"": ""2395"", ""interface"": ""GE1""}","N/A",,202058025,high,"ec7ad6c3-6589-452b-827b-f2b97ccc132e",461,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637010180_9196_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058025 - Edge 461 entrou em status DEGRADED",86400,high
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,6192cd63512a4e102e440dfb,"OPEN - GENERAL - V3",1637010961,1637010623,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}","N/A",,202040669,high,"d6267b5b-d3e5-4e98-980c-12a0978a2a1c",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637010780_9220_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040669 - Edge 999 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192ce8f512a4e102e440e3e,"OPEN - GENERAL - V3",1637012166,1637010961,"alert_manager","","",,"{""edgeId"": ""1583"", ""linkId"": ""4385"", ""interface"": ""GE3""}","N/A",,202062015,high,"e4eade56-7cb9-41ae-9cdb-0033a144a01f",1583,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637011080_9230_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062015 - Edge 1583 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192ce90512a4e102e440e41,"OPEN - GENERAL - V3",1637012166,1637010961,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1582"", ""interface"": ""GE3""}","N/A",,202058019,high,"8647b11e-fff9-468c-9f14-2da3bb8ac8ea",465,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637011080_9230_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058019 - Edge 465 entrou em status DEGRADED",86400,high
"Não","São Paulo","SHOPPING MORUMBI","155276.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041336,LOJA,SDWAN,6192d33f512a4e102e440e5e,"OPEN - GENERAL - V3",1637012706,1637012166,"alert_manager","","",,"{""edgeId"": ""1361"", ""linkId"": ""3504"", ""interface"": ""SFP2""}","N/A",,202041336,high,"a14f5347-f850-47a1-b740-8ca8e2a2a17f",1361,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012280_9266_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041336 - Edge 1361 entrou em status DEGRADED",86400,high
"Não","Porto Alegre","ICATU SEGUROS S.A.","184103.0000000",RS,"N/A","SDWAN - VELOCLOUD",202191967,"ABORDAGEM SIMPLES",SDWAN,6192d341512a4e102e440e61,"OPEN - GENERAL - V3",1637013027,1637012166,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5565"", ""interface"": ""GE3""}","N/A",,202191967,high,"8c7fd1f5-bb0d-430f-8dcf-8cb3c5e14ea8",2152,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012280_9266_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202191967 - Edge 2152 entrou em status DEGRADED",86400,high
"Não","São Paulo","BANCO LOSANGO S.A. - BANCO MULTIPLO","133327.0000000",SP,"N/A",BRAD,20197439,LOSANGO,SDWAN,6192d343512a4e102e440e65,"OPEN - GENERAL - V3",1637012706,1637012166,"alert_manager","","",,"{""edgeId"": ""409"", ""linkId"": ""1064"", ""interface"": ""GE3""}","N/A",,20197439,high,"4ac8f7dc-162f-472d-8568-4377d769a838",409,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012280_9266_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197439 - Edge 409 entrou em status DEGRADED",86400,high
"Não",Bauru,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133321.0000000",SP,"N/A",BRAD,20197436,LOSANGO,SDWAN,6192d345512a4e102e440e68,"OPEN - GENERAL - V3",1637012706,1637012166,"alert_manager","","",,"{""edgeId"": ""425"", ""linkId"": ""1029"", ""interface"": ""GE4""}","N/A",,20197436,high,"9d173fd6-1b04-4a36-b1a8-711c158dcd83",425,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012280_9266_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197436 - Edge 425 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192d346512a4e102e440e6b,"OPEN - GENERAL - V3",1637012706,1637012166,"alert_manager","","",,"{""edgeId"": ""463"", ""linkId"": ""1575"", ""interface"": ""GE3""}","N/A",,202058026,high,"3d68fb64-e7fa-46ff-8bf9-d7c10d16376d",463,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012280_9266_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058026 - Edge 463 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192d348512a4e102e440e6e,"OPEN - GENERAL - V3",1637012706,1637012166,"alert_manager","","",,"{""edgeId"": ""512"", ""linkId"": ""1148"", ""interface"": ""GE1""}","N/A",,202058023,high,"20920a80-d026-4b5f-a2aa-bb7c8182821d",512,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012280_9266_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058023 - Edge 512 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192d596b4a8174f7a512ca8,"OPEN - GENERAL - V3",1637013027,1637012706,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,medium,"01c94a2c-f2a0-4d1e-96ee-92c739fd18f3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012880_9233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192d597b4a8174f7a512caa,"OPEN - GENERAL - V3",1637013027,1637012706,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3602"", ""interface"": ""GE4""}","N/A",,202041328,medium,"1ae25263-1d9f-47d9-aebd-b4ce0153ff0f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012880_9233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Natal,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133313.0000000",RN,"N/A",BRAD,20197433,LOSANGO,SDWAN,6192d599b4a8174f7a512cad,"OPEN - GENERAL - V3",0,1637012166,"alert_manager","","",,"{""edgeId"": ""411"", ""linkId"": ""1040"", ""interface"": ""GE4""}","N/A",,20197433,performance,"3b0e89d6-89f5-475f-bdc6-4c31731a9476",1040,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012880_9233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",4,"20197433 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6192d59bb4a8174f7a512cb0,"OPEN - GENERAL - V3",1637013027,1637012706,"alert_manager","","",,"{""edgeId"": ""1568"", ""linkId"": ""4268"", ""interface"": ""GE4""}","N/A",,202061992,high,"a95c7d7f-5bed-40c2-99be-5fd3ed0184ff",1568,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012880_9233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061992 - Edge 1568 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192d59db4a8174f7a512cb3,"OPEN - GENERAL - V3",1637013027,1637012706,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,high,"fb23417e-b985-40f4-8db5-2599ad539b4c",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012880_9233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192d5a1b4a8174f7a512cb8,"OPEN - GENERAL - V3",1637013027,1637012706,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"3b92654b-c414-4f22-b238-21f25299074e",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012880_9233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","Cuiabá","BANCO LOSANGO S.A. - BANCO MULTIPLO","133302.0000000",MT,"N/A",BRAD,20197427,LOSANGO,SDWAN,6192d7f1fa57811c983f35b5,"OPEN - GENERAL - V3",1637013638,1637013334,"alert_manager","","",,"{""edgeId"": ""413"", ""linkId"": ""1057"", ""interface"": ""GE3""}","N/A",,20197427,high,"76ab9351-1c2f-41bc-a222-b12b036c58c5",413,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637013480_9324_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197427 - Edge 413 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192d7f3fa57811c983f35b8,"OPEN - GENERAL - V3",1637013638,1637013334,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"75c2e763-34a6-4d46-8ecb-24746539ed5d",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637013480_9324_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status OFFLINE",86400,high
"Não","Hortolândia","GERDAU AÇOS LONGOS S A","152463.0000000",SP,"N/A","SDWAN - VELOCLOUD",202038477,ALTO,SDWAN,6192db74512a4e102e440f1d,"OPEN - GENERAL - V3",1637014527,1637014221,"alert_manager","","",,"{""edgeId"": ""922"", ""linkId"": ""4018"", ""interface"": ""SFP2""}","N/A",,202038477,high,"0d144e79-6da2-4917-96ff-0869cef4e356",922,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637014380_9336_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202038477 - Edge 922 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192ddcdb4a8174f7a512d4a,"OPEN - GENERAL - V3",1637015147,1637014803,"alert_manager","","",,"{""edgeId"": ""1583"", ""linkId"": ""4385"", ""interface"": ""GE3""}","N/A",,202062015,high,"8db15104-2389-49ee-8e71-4fb5989e3667",1583,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637014980_9304_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062015 - Edge 1583 entrou em status DEGRADED",86400,high
"Não",Curitiba,"GERDAU AÇOS LONGOS S A","154953.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040646,BAIXO,SDWAN,6192e3a9fa57811c983f36d1,"OPEN - GENERAL - V3",1637016655,1637016318,"alert_manager","","",,"{""edgeId"": ""943"", ""linkId"": ""1879"", ""interface"": ""GE4""}","N/A",,202040646,high,"0dc10a65-3542-4224-8a1e-fa0271f33ce1",943,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637016480_9423_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040646 - Edge 943 entrou em status DEGRADED",86400,high
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,6192e3abfa57811c983f36d5,"OPEN - GENERAL - V3",1637016655,1637016318,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}","N/A",,202041386,high,"f7e50ac1-6c3a-4439-a523-5e300143b958",951,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637016480_9423_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041386 - Edge 951 entrou em status DEGRADED",86400,high
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",6192e986fa57811c983f37ab,"OPEN - GENERAL - V3",1637018405,1637017804,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}","N/A",,201922181,high,"195f771d-c138-4f94-8a87-2df3cfabfe8f",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637017980_9478_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"201922181 - Edge 1105 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192ed08512a4e102e440ffc,"OPEN - GENERAL - V3",1637019025,1637018707,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}","N/A",,202061985,high,"c7b209a4-023a-486f-8596-6a9b843fef0e",1563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637018880_9492_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061985 - Edge 1563 entrou em status OFFLINE",86400,high
"Não","Hortolândia","GERDAU AÇOS LONGOS S A","155355.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041392,ALTO,SDWAN,6192ed09512a4e102e440fff,"OPEN - GENERAL - V3",1637019025,1637018707,"alert_manager","","",,"{""edgeId"": ""924"", ""linkId"": ""4017"", ""interface"": ""SFP2""}","N/A",,202041392,high,"f26deb25-ae5a-4611-bf6c-6138ac22382f",924,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637018880_9492_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041392 - Edge 924 entrou em status DEGRADED",86400,high
"Não",Ananindeua,"GERDAU AÇOS LONGOS S A","154764.0000000",PA,"N/A","SDWAN - VELOCLOUD",202040625,BAIXO,SDWAN,6192ed0a512a4e102e441001,"OPEN - GENERAL - V3",1637019025,1637018707,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2326"", ""interface"": ""GE3""}","N/A",,202040625,high,"15524b39-32b9-4905-95d4-2432e627a440",941,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637018880_9492_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040625 - Edge 941 entrou em status DEGRADED",86400,high
"Não",Curitiba,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133285.0000000",PR,"N/A",BRAD,20197418,LOSANGO,SDWAN,6192ee2ffa57811c983f3827,"OPEN - GENERAL - V3",1637019629,1637019025,"alert_manager","","",,"{""edgeId"": ""1065"", ""linkId"": ""2389"", ""interface"": ""GE2""}","N/A",,20197418,medium,"d457a9b2-d27c-49d6-8194-1fbe2d215fa0",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197418 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133285.0000000",PR,"N/A",BRAD,20197418,LOSANGO,SDWAN,6192ee30fa57811c983f3829,"OPEN - GENERAL - V3",1637019629,1637019025,"alert_manager","","",,"{""edgeId"": ""1065"", ""linkId"": ""2390"", ""interface"": ""GE3""}","N/A",,20197418,medium,"4c439c93-f4b8-4061-9a1e-0cd608385552",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197418 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Ladário","PB LOPES & CIA LTDA","170046.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059978,SDWAN,SDWAN,6192ee31fa57811c983f382b,"OPEN - GENERAL - V3",1637019629,1637019025,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}","N/A",,202059978,medium,"36ffcb2e-68aa-4155-9395-0ff46ce4ed2f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059978 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Cubatão","USINAS SIDERURGICAS DE MINAS GERAIS S A - USIMINAS","168438.0000000",SP,"N/A","SDWAN - VELOCLOUD",202057370,SDWAN,SDWAN,6192ee32fa57811c983f382d,"OPEN - GENERAL - V3",1637019629,1637019025,"alert_manager","","",,"{""edgeId"": ""1291"", ""linkId"": ""3707"", ""interface"": ""GE5""}","N/A",,202057370,medium,"a2b6eed6-201a-4c56-bb60-28d114090349",GE5,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202057370 - Link GE5 entrou em status UNSTABLE",86400,medium
"Não","Cubatão","USINAS SIDERURGICAS DE MINAS GERAIS S A - USIMINAS","168438.0000000",SP,"N/A","SDWAN - VELOCLOUD",202057370,SDWAN,SDWAN,6192ee33fa57811c983f382f,"OPEN - GENERAL - V3",1637019629,1637019025,"alert_manager","","",,"{""edgeId"": ""1291"", ""linkId"": ""3708"", ""interface"": ""GE4""}","N/A",,202057370,medium,"671bdb5f-5a8e-4ca3-8542-87970a05ff2d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202057370 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Brasília","CONDOMINIO DO PARKSHOPPING","155263.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041338,LOJA,SDWAN,6192ee37fa57811c983f3834,"OPEN - GENERAL - V3",1637019629,1637019025,"alert_manager","","",,"{""edgeId"": ""927"", ""linkId"": ""3318"", ""interface"": ""GE3""}","N/A",,202041338,medium,"ae3802f8-123b-47ff-a08c-ea5aa44718a9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041338 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Brasília","CONDOMINIO DO PARKSHOPPING","155263.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041338,LOJA,SDWAN,6192ee38fa57811c983f3836,"OPEN - GENERAL - V3",1637019629,1637019025,"alert_manager","","",,"{""edgeId"": ""927"", ""linkId"": ""3320"", ""interface"": ""GE4""}","N/A",,202041338,medium,"2b9a1324-4aaa-43be-9e8d-796de961cc0d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041338 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192ee39fa57811c983f3838,"OPEN - GENERAL - V3",1637019312,1637019025,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,medium,"95814cbc-b797-4a05-ac43-8ab42162809b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192ee3afa57811c983f383a,"OPEN - GENERAL - V3",1637019312,1637019025,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3602"", ""interface"": ""GE4""}","N/A",,202041328,medium,"2088316e-6592-4c5c-b843-bce4be9c33b7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019180_9523_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192ef67b4a8174f7a512ecb,"OPEN - GENERAL - V3",1637019629,1637019312,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}","N/A",,202061987,high,"09b5f377-3332-4817-9f32-f0834f13db6f",1564,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019480_9450_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061987 - Edge 1564 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192ef69b4a8174f7a512ed0,"OPEN - GENERAL - V3",1637019629,1637019312,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}","N/A",,202058024,high,"d82c39bf-94db-46e4-a939-4dd9c3817811",460,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637019480_9450_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058024 - Edge 460 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192f1bafa57811c983f3846,"OPEN - GENERAL - V3",1637020258,1637019928,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""4076"", ""interface"": ""GE4""}","N/A",,202062003,high,"4fd26cb6-edeb-4dd4-848d-a132da67b517",1574,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637020080_9548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062003 - Edge 1574 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6192f1bcfa57811c983f3849,"OPEN - GENERAL - V3",1637020258,1637019928,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","N/A",,202062009,high,"dfcb8cbf-9c93-4d05-b40e-a2886dc4ea5a",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637020080_9548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062009 - Edge 1580 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6192f2e1fa57811c983f384f,"OPEN - GENERAL - V3",1637020843,1637020258,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"26dcabb0-cc98-434a-aeab-ed370889e037",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637020380_9557_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","ICATU SEGUROS S.A.","134539.0000000",SC,"N/A","SDWAN - VELOCLOUD",20199724,"DUPLA ABORDAGEM",SDWAN,6192f2e2fa57811c983f3851,"OPEN - GENERAL - V3",1637020843,1637020257,"alert_manager","","",,"{""edgeId"": ""333"", ""linkId"": ""645"", ""interface"": ""GE3""}","N/A",,20199724,medium,"c2a25c22-0368-4820-bfd8-0e18b301640b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637020380_9557_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20199724 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","ICATU SEGUROS S.A.","134539.0000000",SC,"N/A","SDWAN - VELOCLOUD",20199724,"DUPLA ABORDAGEM",SDWAN,6192f2e3fa57811c983f3853,"OPEN - GENERAL - V3",1637020843,1637020257,"alert_manager","","",,"{""edgeId"": ""333"", ""linkId"": ""686"", ""interface"": ""GE4""}","N/A",,20199724,medium,"040b5107-2efc-4f7f-a83e-0ff8355eeb85",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637020380_9557_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20199724 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6192f53efa57811c983f3868,"OPEN - GENERAL - V3",1637021440,1637020843,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"ceb749c4-05e3-4c60-b695-3b9986f4bef4",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637020980_9576_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192f66afa57811c983f38b2,"OPEN - GENERAL - V3",1637021440,1637021111,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","N/A",,202062007,high,"3306ad9e-275b-4c8f-8b48-0ce15a9c29cc",1578,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637021280_9584_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062007 - Edge 1578 entrou em status DEGRADED",86400,high
"Não","Jundiaí","GERDAU AÇOS LONGOS S A","154952.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040645,BAIXO,SDWAN,6192f794512a4e102e441115,"OPEN - GENERAL - V3",1637022004,1637021440,"alert_manager","","",,"{""edgeId"": ""919"", ""linkId"": ""1958"", ""interface"": ""GE3""}","N/A",,202040645,high,"4350542c-1c70-4fb1-aa2b-d1b6c851811a",919,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637021580_9595_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040645 - Edge 919 entrou em status DEGRADED",86400,high
"Não",Araraquara,"GERDAU AÇOS LONGOS S A","154957.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040650,BAIXO,SDWAN,6192f795512a4e102e441118,"OPEN - GENERAL - V3",1637022004,1637021440,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""1987"", ""interface"": ""GE3""}","N/A",,202040650,high,"77b981f3-e652-4d86-857e-0b731ad1a450",947,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637021580_9595_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040650 - Edge 947 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6192f9edb4a8174f7a512f51,"OPEN - GENERAL - V3",1637022361,1637022004,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","N/A",,202062009,high,"680573b1-65b0-4a5d-b978-46d75e49a135",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022180_9536_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062009 - Edge 1580 entrou em status DEGRADED",86400,high
"Não",Manaus,"GERDAU AÇOS LONGOS SA","180265.0000000",AM,"N/A","SDWAN - VELOCLOUD",202183874,FLEX,SDWAN,6192f9efb4a8174f7a512f54,"OPEN - GENERAL - V3",1637022361,1637022004,"alert_manager","","",,"{""edgeId"": ""1930"", ""linkId"": ""5144"", ""interface"": ""GE3""}","N/A",,202183874,high,"fae06b36-f6e5-4687-83e9-1c6ec819a16d",1930,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022180_9536_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202183874 - Edge 1930 entrou em status DEGRADED",86400,high
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,6192fc3fb4a8174f7a512f59,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}","N/A",,202041385,medium,"57b425bf-bfb5-4082-80ec-d75d68d74c5e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,6192fc40b4a8174f7a512f5c,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2257"", ""interface"": ""GE3""}","N/A",,202041385,medium,"db2a190f-1469-4932-8238-82fb3524b5b3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192fc42b4a8174f7a512f61,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""1569"", ""linkId"": ""4222"", ""interface"": ""GE3""}","N/A",,202062019,medium,"aedd25da-f4e9-4d91-8087-dabaa84a8056",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062019 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192fc43b4a8174f7a512f63,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""1569"", ""linkId"": ""4223"", ""interface"": ""GE4""}","N/A",,202062019,medium,"de093499-6eec-476f-9efd-9a79be32e9e5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062019 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,6192fc45b4a8174f7a512f69,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}","N/A",,202183678,medium,"2c19a572-8976-4fc2-b1cb-5696f95f4e44",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183678 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,6192fc46b4a8174f7a512f6c,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5558"", ""interface"": ""GE4""}","N/A",,202183678,medium,"3d72afdc-38a3-4913-8caf-62b946b0a767",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183678 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","ICATU SEGUROS S.A.","134539.0000000",SC,"N/A","SDWAN - VELOCLOUD",20199724,"DUPLA ABORDAGEM",SDWAN,6192fc47b4a8174f7a512f6e,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""333"", ""linkId"": ""645"", ""interface"": ""GE3""}","N/A",,20199724,medium,"45a8b180-4936-458c-ba16-dd2e358cb13a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20199724 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","ICATU SEGUROS S.A.","134539.0000000",SC,"N/A","SDWAN - VELOCLOUD",20199724,"DUPLA ABORDAGEM",SDWAN,6192fc48b4a8174f7a512f71,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""333"", ""linkId"": ""686"", ""interface"": ""GE4""}","N/A",,20199724,medium,"0dedf52c-e9d9-41df-aa8d-a806e88067cb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20199724 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192fc49b4a8174f7a512f76,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1582"", ""interface"": ""GE3""}","N/A",,202058019,medium,"80436888-3278-4350-9216-e0c6fe031bde",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058019 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6192fc4ab4a8174f7a512f79,"OPEN - GENERAL - V3",1637022904,1637022624,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1583"", ""interface"": ""GE4""}","N/A",,202058019,medium,"5b198dbe-b5f4-4908-9043-6f61c7b682c1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637022780_9555_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058019 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","BANCO LOSANGO S.A. - BANCO MULTIPLO","133317.0000000",SC,"N/A",BRAD,20197435,LOSANGO,SDWAN,6192ffc6512a4e102e441238,"OPEN - GENERAL - V3",1637023823,1637023506,"alert_manager","","",,"{""edgeId"": ""414"", ""linkId"": ""1050"", ""interface"": ""GE4""}","N/A",,20197435,medium,"77cb339f-bafc-4292-a74d-d7dea183edb2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637023680_9664_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197435 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","BANCO LOSANGO S.A. - BANCO MULTIPLO","133317.0000000",SC,"N/A",BRAD,20197435,LOSANGO,SDWAN,6192ffc6512a4e102e44123a,"OPEN - GENERAL - V3",1637023823,1637023506,"alert_manager","","",,"{""edgeId"": ""414"", ""linkId"": ""4958"", ""interface"": ""GE3""}","N/A",,20197435,medium,"7ac486c1-e1c2-409b-a3a8-f5cc329a24eb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637023680_9664_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197435 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619300f2fa57811c983f393e,"OPEN - GENERAL - V3",1637024183,1637023823,"alert_manager","","",,"{""edgeId"": ""467"", ""linkId"": ""1628"", ""interface"": ""GE3""}","N/A",,202058101,medium,"629de39c-2713-498c-8213-9653ea0a4b0e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637023980_9684_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058101 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619300f3fa57811c983f3941,"OPEN - GENERAL - V3",1637024183,1637023823,"alert_manager","","",,"{""edgeId"": ""467"", ""linkId"": ""1637"", ""interface"": ""GE4""}","N/A",,202058101,medium,"58fab059-3d30-4a9c-8bc4-53682d7a0a76",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637023980_9684_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058101 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,61930349fa57811c983f398e,"OPEN - GENERAL - V3",1637025007,1637024404,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}","N/A",,202183678,medium,"29b9534a-e347-4963-9d46-d5123dc3f5bf",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637024580_9708_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183678 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,6193034afa57811c983f3991,"OPEN - GENERAL - V3",1637025007,1637024404,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5558"", ""interface"": ""GE4""}","N/A",,202183678,medium,"df09609b-b735-4601-a205-bc0340e5f0fc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637024580_9708_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183678 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","ICATU SEGUROS S.A.","134539.0000000",SC,"N/A","SDWAN - VELOCLOUD",20199724,"DUPLA ABORDAGEM",SDWAN,6193034bfa57811c983f3994,"OPEN - GENERAL - V3",1637025007,1637024404,"alert_manager","","",,"{""edgeId"": ""333"", ""linkId"": ""645"", ""interface"": ""GE3""}","N/A",,20199724,medium,"9ac238f7-fd45-4fde-bfe0-bdb2a012b6ef",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637024580_9708_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20199724 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","ICATU SEGUROS S.A.","134539.0000000",SC,"N/A","SDWAN - VELOCLOUD",20199724,"DUPLA ABORDAGEM",SDWAN,6193034cfa57811c983f3997,"OPEN - GENERAL - V3",1637025007,1637024404,"alert_manager","","",,"{""edgeId"": ""333"", ""linkId"": ""686"", ""interface"": ""GE4""}","N/A",,20199724,medium,"f56772d1-d9cb-4855-8144-0d88730be818",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637024580_9708_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20199724 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Recife,"GERDAU AÇOS LONGOS S A","154943.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040641,BAIXO,SDWAN,61930353fa57811c983f39a4,"OPEN - GENERAL - V3",1637025007,1637024404,"alert_manager","","",,"{""edgeId"": ""914"", ""linkId"": ""2054"", ""interface"": ""GE3""}","N/A",,202040641,high,"16b21b87-649d-4aca-9fc2-b23ca576afb0",914,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637024580_9708_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040641 - Edge 914 entrou em status DEGRADED",86400,high
"Não",Fortaleza,"GERDAU AÇOS LONGOS S A","154963.0000000",CE,"N/A","SDWAN - VELOCLOUD",202040661,BAIXO,SDWAN,61930355fa57811c983f39a9,"OPEN - GENERAL - V3",1637025007,1637024404,"alert_manager","","",,"{""edgeId"": ""964"", ""linkId"": ""2274"", ""interface"": ""GE3""}","N/A",,202040661,high,"d6fc9f41-0c97-4923-9efc-f20f271ba99b",964,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637024580_9708_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040661 - Edge 964 entrou em status DEGRADED",86400,high
"Não","Porto Alegre","ICATU SEGUROS S.A.","184103.0000000",RS,"N/A","SDWAN - VELOCLOUD",202191967,"ABORDAGEM SIMPLES",SDWAN,619305a7fa57811c983f3a24,"OPEN - GENERAL - V3",1637025323,1637025007,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5565"", ""interface"": ""GE3""}","N/A",,202191967,high,"219d7c18-d004-4921-ba33-3d36958f92b0",2152,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637025180_9734_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202191967 - Edge 2152 entrou em status DEGRADED",86400,high
"Não","Três Marias","GERDAU AÇOS LONGOS S A","147346.0000000",MG,"N/A","SDWAN - VELOCLOUD",201922181,"","",619307fffa57811c983f3a2f,"OPEN - GENERAL - V3",1637025941,1637025605,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}","N/A",,201922181,high,"4613eb4e-f918-4f6d-8898-3ec38b6fdbb3",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637025780_9754_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"201922181 - Edge 1105 entrou em status DEGRADED",86400,high
"Não","Florianópolis","BANCO LOSANGO S.A. - BANCO MULTIPLO","133317.0000000",SC,"N/A",BRAD,20197435,LOSANGO,SDWAN,61930b7efa57811c983f3a80,"OPEN - GENERAL - V3",1637026843,1637026509,"alert_manager","","",,"{""edgeId"": ""414"", ""linkId"": ""1050"", ""interface"": ""GE4""}","N/A",,20197435,medium,"c3ddb172-3952-44b4-acdf-0c6411974913",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026680_9780_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197435 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Florianópolis","BANCO LOSANGO S.A. - BANCO MULTIPLO","133317.0000000",SC,"N/A",BRAD,20197435,LOSANGO,SDWAN,61930b7ffa57811c983f3a83,"OPEN - GENERAL - V3",1637026843,1637026509,"alert_manager","","",,"{""edgeId"": ""414"", ""linkId"": ""4958"", ""interface"": ""GE3""}","N/A",,20197435,medium,"1b83d4cf-1f51-4a60-8ee3-da514cec5883",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026680_9780_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197435 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José","GERDAU AÇOS LONGOS S A","155350.0000000",SC,"N/A","SDWAN - VELOCLOUD",202041387,BAIXO,SDWAN,61930b80fa57811c983f3a86,"OPEN - GENERAL - V3",1637026843,1637026509,"alert_manager","","",,"{""edgeId"": ""963"", ""linkId"": ""1961"", ""interface"": ""GE3""}","N/A",,202041387,medium,"ac746913-217c-402a-8227-0572fa80ff7c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026680_9780_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041387 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José","GERDAU AÇOS LONGOS S A","155350.0000000",SC,"N/A","SDWAN - VELOCLOUD",202041387,BAIXO,SDWAN,61930b81fa57811c983f3a89,"OPEN - GENERAL - V3",1637026843,1637026509,"alert_manager","","",,"{""edgeId"": ""963"", ""linkId"": ""2259"", ""interface"": ""GE4""}","N/A",,202041387,medium,"e73475f3-4f32-4d4b-a5f7-5b4c3cef5798",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026680_9780_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041387 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Itatiaiuçu","MINERACAO USIMINAS S.A.","180073.0000000",MG,"N/A","SDWAN - VELOCLOUD",202183678,FLEX,SDWAN,61930b86fa57811c983f3a94,"OPEN - GENERAL - V3",1637026843,1637026509,"alert_manager","","",,"{""edgeId"": ""2144"", ""linkId"": ""5557"", ""interface"": ""GE3""}","N/A",,202183678,high,"570c72cc-fc21-4645-985f-2e03f99a8551",2144,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026680_9780_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202183678 - Edge 2144 entrou em status DEGRADED",86400,high
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61930b88fa57811c983f3a99,"OPEN - GENERAL - V3",1637026843,1637026509,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}","N/A",,202040644,high,"c724ed51-5d18-431e-830c-bfaa3e578b53",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026680_9780_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não",Araraquara,"GERDAU AÇOS LONGOS S A","154957.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040650,BAIXO,SDWAN,61930b8afa57811c983f3a9d,"OPEN - GENERAL - V3",1637026843,1637026509,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""1987"", ""interface"": ""GE3""}","N/A",,202040650,high,"752bfd4e-99c8-4acd-ae5d-8ca4ac9baa25",947,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026680_9780_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040650 - Edge 947 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61930caeb4a8174f7a513088,"OPEN - GENERAL - V3",1637027104,1637026843,"alert_manager","","",,"{""edgeId"": ""1569"", ""linkId"": ""4222"", ""interface"": ""GE3""}","N/A",,202062019,high,"15a03205-5d33-412e-9555-65ff108b9229",1569,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026980_9693_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062019 - Edge 1569 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61930cb0b4a8174f7a51308d,"OPEN - GENERAL - V3",1637027104,1637026843,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""4076"", ""interface"": ""GE4""}","N/A",,202062003,high,"04f03aa8-85ed-4c23-a50c-b3f26c0ab0dc",1574,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026980_9693_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062003 - Edge 1574 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61930cb2b4a8174f7a513092,"OPEN - GENERAL - V3",1637027104,1637026843,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""4282"", ""interface"": ""GE3""}","N/A",,202062023,high,"8ca56b7e-5b6f-4015-888f-463d48260ed4",1585,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637026980_9693_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062023 - Edge 1585 entrou em status DEGRADED",86400,high
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,61931159512a4e102e44131c,"OPEN - GENERAL - V3",1637028303,1637028015,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}","N/A",,202040669,medium,"a19b86b1-b370-4ac4-8f96-85e235cc0e1b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637028180_9804_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040669 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6193115e512a4e102e441327,"OPEN - GENERAL - V3",1637028303,1637028015,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""4083"", ""interface"": ""GE4""}","N/A",,202062005,high,"120fdb9e-868b-45f3-b764-98c39f8db6a3",1576,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637028180_9804_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062005 - Edge 1576 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193115f512a4e102e44132c,"OPEN - GENERAL - V3",1637028303,1637028015,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",high,"0b783a87-7e17-47f7-81f8-978c2bf6d75e",2088,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637028180_9804_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Edge 2088 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61931160512a4e102e44132f,"OPEN - GENERAL - V3",1637028303,1637028015,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5336"", ""interface"": ""GE2""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",high,"04ce51b0-807f-41e8-9f27-434b42e57983",2088,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637028180_9804_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Edge 2088 entrou em status DEGRADED",86400,high
"Não",Natal,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133313.0000000",RN,"N/A",BRAD,20197433,LOSANGO,SDWAN,61931161512a4e102e441332,"OPEN - GENERAL - V3",1637028303,1637028015,"alert_manager","","",,"{""edgeId"": ""411"", ""linkId"": ""1040"", ""interface"": ""GE4""}","N/A",,20197433,high,"1c9a4e99-ef33-494b-9fef-3273e622c027",411,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637028180_9804_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197433 - Edge 411 entrou em status DEGRADED",86400,high
"Não",Londrina,"GERDAU AÇOS LONGOS S A","155326.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041363,BAIXO,SDWAN,619314dd512a4e102e44136c,"OPEN - GENERAL - V3",1637029507,1637028948,"alert_manager","","",,"{""edgeId"": ""977"", ""linkId"": ""2156"", ""interface"": ""GE4""}","N/A",,202041363,medium,"6b297233-1fdf-444a-847b-484828462989",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029080_9832_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041363 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Londrina,"GERDAU AÇOS LONGOS S A","155326.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041363,BAIXO,SDWAN,619314de512a4e102e44136e,"OPEN - GENERAL - V3",1637029507,1637028948,"alert_manager","","",,"{""edgeId"": ""977"", ""linkId"": ""2158"", ""interface"": ""GE3""}","N/A",,202041363,medium,"f13ccdfe-fc82-4454-ba44-80ca294987b7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029080_9832_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041363 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,61931733512a4e102e44137d,"OPEN - GENERAL - V3",1637029833,1637029507,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}","N/A",,202041385,medium,"fe6f7e60-d8ea-48c2-8676-5b8f5457e5dd",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029680_9852_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,61931734512a4e102e44137f,"OPEN - GENERAL - V3",1637029833,1637029507,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2257"", ""interface"": ""GE3""}","N/A",,202041385,medium,"4fb4ac67-47fd-4a54-95b0-7e0850bea8e6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029680_9852_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61931737512a4e102e441384,"OPEN - GENERAL - V3",1637029833,1637029507,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,medium,"a475f771-0b43-4884-bacb-ae60c5c156ee",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029680_9852_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61931738512a4e102e441386,"OPEN - GENERAL - V3",1637029833,1637029507,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3602"", ""interface"": ""GE4""}","N/A",,202041328,medium,"d887b20e-65cf-4da4-b4d2-c66d0304f32f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029680_9852_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Varginha,"GERDAU AÇOS LONGOS S A","154974.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040672,BAIXO,SDWAN,6193173c512a4e102e44138b,"OPEN - GENERAL - V3",1637029833,1637029507,"alert_manager","","",,"{""edgeId"": ""1009"", ""linkId"": ""2260"", ""interface"": ""GE3""}","N/A",,202040672,high,"7ab8f79e-d20f-41f5-aa43-27a7c65aa195",1009,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029680_9852_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040672 - Edge 1009 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193173e512a4e102e44138e,"OPEN - GENERAL - V3",1637029833,1637029507,"alert_manager","","",,"{""edgeId"": ""1561"", ""linkId"": ""4120"", ""interface"": ""GE4""}","N/A",,202062021,high,"51f8a36a-3189-4df7-b6f3-27115922dd02",1561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029680_9852_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062021 - Edge 1561 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193173f512a4e102e441390,"OPEN - GENERAL - V3",1637029833,1637029507,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}","N/A",,202061985,high,"d2a30e0b-fe91-46b0-8283-87d9f1633034",1563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029680_9852_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061985 - Edge 1563 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61931741512a4e102e441393,"OPEN - GENERAL - V3",1637029833,1637029507,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"d2f69778-abcd-4571-89e0-bd041142d83a",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029680_9852_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","Uberlândia","GERDAU AÇOS LONGOS S A","154973.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040671,BAIXO,SDWAN,6193185fb4a8174f7a513199,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""1007"", ""linkId"": ""2277"", ""interface"": ""GE4""}","N/A",,202040671,medium,"77593b4d-825c-4708-b69d-ee6a1d408826",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040671 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Uberlândia","GERDAU AÇOS LONGOS S A","154973.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040671,BAIXO,SDWAN,61931860b4a8174f7a51319b,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""1007"", ""linkId"": ""2284"", ""interface"": ""GE3""}","N/A",,202040671,medium,"a7b313cc-e46a-4aa5-a82b-cb4915343f80",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040671 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Varginha,"GERDAU AÇOS LONGOS S A","154974.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040672,BAIXO,SDWAN,61931861b4a8174f7a51319d,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""1009"", ""linkId"": ""2260"", ""interface"": ""GE3""}","N/A",,202040672,medium,"f72b448e-af8d-4bdf-91c2-5047e7d6d03d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040672 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Varginha,"GERDAU AÇOS LONGOS S A","154974.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040672,BAIXO,SDWAN,61931862b4a8174f7a51319f,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""1009"", ""linkId"": ""2262"", ""interface"": ""GE4""}","N/A",,202040672,medium,"88cf3a12-884d-4df0-959c-cd5890763da1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040672 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133285.0000000",PR,"N/A",BRAD,20197418,LOSANGO,SDWAN,61931863b4a8174f7a5131a1,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1065"", ""linkId"": ""2389"", ""interface"": ""GE2""}","N/A",,20197418,medium,"5d7c4429-9a61-45bd-a02a-ddf9b29a509c",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197418 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133285.0000000",PR,"N/A",BRAD,20197418,LOSANGO,SDWAN,61931864b4a8174f7a5131a3,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1065"", ""linkId"": ""2390"", ""interface"": ""GE3""}","N/A",,20197418,medium,"d1e8c7ab-edc6-4177-8bb1-6711de5d4bb9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197418 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Maringá","PB LOPES & CIA LTDA","170042.0000000",PR,"N/A","SDWAN - VELOCLOUD",202059974,SDWAN,SDWAN,61931864b4a8174f7a5131a5,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}","N/A",,202059974,medium,"a5453f8a-4e2f-41d8-a650-64a86f9d4541",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059974 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Ladário","PB LOPES & CIA LTDA","170046.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059978,SDWAN,SDWAN,61931865b4a8174f7a5131a7,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}","N/A",,202059978,medium,"5977c9cb-0699-4089-99a5-bb04c1f0c2b1",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059978 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Caruaru,"GERDAU AÇOS LONGOS S A","154938.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040637,BAIXO,SDWAN,61931866b4a8174f7a5131a9,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3200"", ""interface"": ""GE3""}","N/A",,202040637,medium,"d8eb1751-2ede-41c0-8b14-78f3c37b8fac",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040637 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Cubatão","USINAS SIDERURGICAS DE MINAS GERAIS S A - USIMINAS","168438.0000000",SP,"N/A","SDWAN - VELOCLOUD",202057370,SDWAN,SDWAN,61931868b4a8174f7a5131ab,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1291"", ""linkId"": ""3707"", ""interface"": ""GE5""}","N/A",,202057370,medium,"2b55336e-dfa9-41ba-9107-a447e39353e7",GE5,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202057370 - Link GE5 entrou em status UNSTABLE",86400,medium
"Não","Cubatão","USINAS SIDERURGICAS DE MINAS GERAIS S A - USIMINAS","168438.0000000",SP,"N/A","SDWAN - VELOCLOUD",202057370,SDWAN,SDWAN,61931869b4a8174f7a5131ad,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1291"", ""linkId"": ""3708"", ""interface"": ""GE4""}","N/A",,202057370,medium,"849443ed-3c57-480a-a84f-aa6ca4da7ca4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202057370 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Belo Horizonte","BANCO LOSANGO S.A. - BANCO MULTIPLO","162999.0000000",MG,"N/A",BRAD,202050954,LOSANGO,SDWAN,6193186ab4a8174f7a5131af,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1319"", ""linkId"": ""3559"", ""interface"": ""GE3""}","N/A",,202050954,medium,"e0501e8e-02d2-4b03-a64c-6255aeaedce4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202050954 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Belo Horizonte","BANCO LOSANGO S.A. - BANCO MULTIPLO","162999.0000000",MG,"N/A",BRAD,202050954,LOSANGO,SDWAN,6193186ab4a8174f7a5131b1,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1319"", ""linkId"": ""3617"", ""interface"": ""GE4""}","N/A",,202050954,medium,"08c060f7-5dcb-4c17-afaf-b8a6f0a845c7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202050954 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Araçatuba","GERDAU AÇOS LONGOS SA","170122.0000000",SP,"N/A",GRC,202060096,DADOS,DADOS,6193186db4a8174f7a5131b5,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1733"", ""linkId"": ""4285"", ""interface"": ""GE3""}","N/A",,202060096,medium,"19bba960-7507-475c-97ec-715aa3c01710",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202060096 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Araçatuba","GERDAU AÇOS LONGOS SA","170122.0000000",SP,"N/A",GRC,202060096,DADOS,DADOS,6193186eb4a8174f7a5131b7,"OPEN - GENERAL - V3",1637031020,1637029833,"alert_manager","","",,"{""edgeId"": ""1733"", ""linkId"": ""4286"", ""interface"": ""GE4""}","N/A",,202060096,medium,"a2a4655b-aaaf-4530-907e-0c2ef0f27f65",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202060096 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Natal,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133313.0000000",RN,"N/A",BRAD,20197433,LOSANGO,SDWAN,6193186fb4a8174f7a5131b9,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""411"", ""linkId"": ""1040"", ""interface"": ""GE4""}","N/A",,20197433,medium,"a75590fc-4489-4724-9a4d-ddbda709140e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,19,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197433 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Natal,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133313.0000000",RN,"N/A",BRAD,20197433,LOSANGO,SDWAN,61931870b4a8174f7a5131bb,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""411"", ""linkId"": ""939"", ""interface"": ""GE3""}","N/A",,20197433,medium,"1728f8fb-cbd1-4435-b693-d89505f547aa",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,20,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197433 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Rio de Janeiro","BANCO LOSANGO S.A. - BANCO MULTIPLO","133309.0000000",RJ,"N/A",BRAD,20197431,LOSANGO,SDWAN,61931872b4a8174f7a5131be,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""423"", ""linkId"": ""1021"", ""interface"": ""GE3""}","N/A",,20197431,medium,"49457d13-b647-4b1b-a0bb-cc744b2aaed0",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,22,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197431 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Rio de Janeiro","BANCO LOSANGO S.A. - BANCO MULTIPLO","133309.0000000",RJ,"N/A",BRAD,20197431,LOSANGO,SDWAN,61931873b4a8174f7a5131c0,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""423"", ""linkId"": ""1054"", ""interface"": ""GE4""}","N/A",,20197431,medium,"79a37547-7133-48c0-bb91-2f83835c9eb1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,23,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197431 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Maceió","BANCO LOSANGO S.A. - BANCO MULTIPLO","133289.0000000",AL,"N/A",BRAD,20197420,LOSANGO,SDWAN,61931874b4a8174f7a5131c2,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""433"", ""linkId"": ""1019"", ""interface"": ""GE3""}","N/A",,20197420,medium,"e9aa5d98-3dbb-42d6-8de6-56b8d444f514",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,24,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197420 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Maceió","BANCO LOSANGO S.A. - BANCO MULTIPLO","133289.0000000",AL,"N/A",BRAD,20197420,LOSANGO,SDWAN,61931875b4a8174f7a5131c4,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""433"", ""linkId"": ""1051"", ""interface"": ""GE4""}","N/A",,20197420,medium,"0a4be139-ede7-4c9c-aeb0-58f80f217f88",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,25,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197420 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Bauru,"GERDAU AÇOS LONGOS S A","154949.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040642,BAIXO,SDWAN,61931875b4a8174f7a5131c6,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""2255"", ""interface"": ""GE3""}","N/A",,202040642,medium,"497d38af-cde5-4fcd-9a6a-3f32f0e647ff",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,26,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040642 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Bauru,"GERDAU AÇOS LONGOS S A","154949.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040642,BAIXO,SDWAN,61931876b4a8174f7a5131c8,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""3773"", ""interface"": ""GE4""}","N/A",,202040642,medium,"52a51924-48c0-44e9-babf-e366c824e514",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,27,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040642 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São Paulo","CONDOMINIO JARDIM ANALIA FRANCO","155273.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041327,LOJA,SDWAN,61931877b4a8174f7a5131ca,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""931"", ""linkId"": ""3380"", ""interface"": ""GE3""}","N/A",,202041327,medium,"9c1d7756-6e9d-4c9a-b699-e8fe21edf557",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,28,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041327 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São Paulo","CONDOMINIO JARDIM ANALIA FRANCO","155273.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041327,LOJA,SDWAN,61931878b4a8174f7a5131cc,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""931"", ""linkId"": ""3381"", ""interface"": ""GE4""}","N/A",,202041327,medium,"88967d3f-1905-4fa9-9198-9816167315b5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,29,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041327 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Jundiaí","SUBCONDOMINIO SHOPPING CENTER JUNDIAI SHOPPING","155272.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041335,LOJA,SDWAN,61931879b4a8174f7a5131ce,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3331"", ""interface"": ""GE4""}","N/A",,202041335,medium,"b1b0f71d-e28d-4bea-988d-fc479dab6103",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,30,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041335 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Jundiaí","SUBCONDOMINIO SHOPPING CENTER JUNDIAI SHOPPING","155272.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041335,LOJA,SDWAN,6193187ab4a8174f7a5131d0,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","N/A",,202041335,medium,"dab0bc31-06ad-4863-b209-a3d3d19cbdb2",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,31,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041335 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Bauru,"GERDAU AÇOS LONGOS S A","154944.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040652,BAIXO,SDWAN,6193187bb4a8174f7a5131d2,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""949"", ""linkId"": ""2704"", ""interface"": ""GE3""}","N/A",,202040652,medium,"c2c85b04-0a3e-4677-85d9-43ca7b260197",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,32,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040652 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Bauru,"GERDAU AÇOS LONGOS S A","154944.0000000",SP,"N/A","SDWAN - VELOCLOUD",202040652,BAIXO,SDWAN,6193187cb4a8174f7a5131d4,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""949"", ""linkId"": ""3015"", ""interface"": ""GE4""}","N/A",,202040652,medium,"bd01e174-1c82-4af0-aca8-f26ba9a6b0f5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,33,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040652 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Campo Grande","GERDAU AÇOS LONGOS S A","154946.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040654,BAIXO,SDWAN,6193187db4a8174f7a5131d6,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""1867"", ""interface"": ""GE3""}","N/A",,202040654,medium,"840c53aa-3c93-475f-94ac-4d5e1d3aa2df",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,34,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040654 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Campo Grande","GERDAU AÇOS LONGOS S A","154946.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040654,BAIXO,SDWAN,6193187eb4a8174f7a5131d8,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""2779"", ""interface"": ""GE4""}","N/A",,202040654,medium,"f510fe1e-c3fd-4bd6-a9f4-d10fec702cb0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,35,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040654 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Cascavel,"GERDAU AÇOS LONGOS S A","154947.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040655,BAIXO,SDWAN,6193187fb4a8174f7a5131da,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}","N/A",,202040655,medium,"9aadcc36-a6c4-4357-9c18-3b8d98e10f9c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,36,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040655 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Cascavel,"GERDAU AÇOS LONGOS S A","154947.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040655,BAIXO,SDWAN,61931880b4a8174f7a5131dc,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""2753"", ""interface"": ""GE4""}","N/A",,202040655,medium,"f61b1a74-707c-486d-976a-6dd97241aae2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,37,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040655 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Chapecó","GERDAU AÇOS LONGOS S A","154959.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040657,BAIXO,SDWAN,61931881b4a8174f7a5131de,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""957"", ""linkId"": ""2065"", ""interface"": ""GE3""}","N/A",,202040657,medium,"4459c808-0858-4cdc-a409-624826a9cc9f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,38,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040657 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Chapecó","GERDAU AÇOS LONGOS S A","154959.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040657,BAIXO,SDWAN,61931882b4a8174f7a5131e0,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""957"", ""linkId"": ""2066"", ""interface"": ""GE4""}","N/A",,202040657,medium,"221031f0-9dc5-4c9e-b396-930cc57c0ef5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,39,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040657 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Araquari,"GERDAU AÇOS LONGOS S A","154937.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040635,BAIXO,SDWAN,61931882b4a8174f7a5131e2,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2062"", ""interface"": ""GE3""}","N/A",,202040635,medium,"67dff595-b2e7-4cad-b0d9-173e46025541",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,40,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040635 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Araquari,"GERDAU AÇOS LONGOS S A","154937.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040635,BAIXO,SDWAN,61931883b4a8174f7a5131e4,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2275"", ""interface"": ""GE4""}","N/A",,202040635,medium,"e66e08b8-4bb7-4958-8820-bab7aa75f5a6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,41,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040635 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,61931884b4a8174f7a5131e6,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}","N/A",,202041366,medium,"05e4c1dc-de13-4c30-81b7-1d5cb5c05c23",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,42,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041366 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,61931885b4a8174f7a5131e8,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2305"", ""interface"": ""GE4""}","N/A",,202041366,medium,"5f5cd224-700e-4d3c-8195-be4e10ef9f9a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,43,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041366 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Panambi,"GERDAU AÇOS LONGOS S A","155333.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041370,BAIXO,SDWAN,61931886b4a8174f7a5131ea,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""987"", ""linkId"": ""2237"", ""interface"": ""GE2""}","N/A",,202041370,medium,"0e98eae3-044e-4497-9e70-0e2eed79b7f1",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,44,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041370 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não",Panambi,"GERDAU AÇOS LONGOS S A","155333.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041370,BAIXO,SDWAN,61931887b4a8174f7a5131ec,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}","N/A",,202041370,medium,"03989f25-2d75-418f-bee5-80aa63c7328f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,45,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041370 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Ponta Grossa","GERDAU AÇOS LONGOS S A","155337.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041374,BAIXO,SDWAN,61931888b4a8174f7a5131ee,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""991"", ""linkId"": ""1914"", ""interface"": ""GE4""}","N/A",,202041374,medium,"642edb1e-128f-4920-894d-fe5e8e488d91",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,46,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041374 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Ponta Grossa","GERDAU AÇOS LONGOS S A","155337.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041374,BAIXO,SDWAN,61931889b4a8174f7a5131f0,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""991"", ""linkId"": ""3416"", ""interface"": ""GE3""}","N/A",,202041374,medium,"a76215bf-b0b6-4b07-8226-127ac556e7c7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,47,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041374 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,6193188ab4a8174f7a5131f2,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}","N/A",,202040669,medium,"169a78fc-67f6-44f1-9fb4-a10874b17a30",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,48,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040669 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,6193188bb4a8174f7a5131f4,"OPEN - GENERAL - V3",1637031019,1637029833,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}","N/A",,202040669,medium,"6a01813e-09c1-4ef0-8641-8c195c6dc100",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637029980_9799_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,,critical,49,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040669 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61931d15b4a8174f7a5132e8,"OPEN - GENERAL - V3",0,1637031019,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}","N/A",,202058022,high,"8b47c4c2-0ca0-4b07-b349-28bc2ecc7a65",458,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031180_9839_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202058022 - Edge 458 entrou em status DEGRADED",86400,high
"Não","Brasília","CONDOMINIO DO PARKSHOPPING","155263.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041338,LOJA,SDWAN,61931d17b4a8174f7a5132eb,"OPEN - GENERAL - V3",1637031316,1637031019,"alert_manager","","",,"{""edgeId"": ""927"", ""linkId"": ""3318"", ""interface"": ""GE3""}","N/A",,202041338,high,"65252ef1-e30a-477f-bd00-54ffb84c6fb9",927,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031180_9839_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041338 - Edge 927 entrou em status OFFLINE",86400,high
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,61931e3a512a4e102e4413d7,"OPEN - GENERAL - V3",0,1637031316,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}","N/A",,202041385,medium,"d6f10a0b-1111-42fd-8f57-9ad01b284c30",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041385 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,61931e3b512a4e102e4413da,"OPEN - GENERAL - V3",0,1637031316,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2257"", ""interface"": ""GE3""}","N/A",,202041385,medium,"e4b5139a-3935-4e7d-a6e3-b791121c26eb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202041385 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61931e3d512a4e102e4413e0,"OPEN - GENERAL - V3",0,1637031316,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}","N/A",,202061999,medium,"5c882cbe-5493-4c8d-a257-a97a28af5f04",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202061999 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61931e3e512a4e102e4413e3,"OPEN - GENERAL - V3",0,1637031316,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4562"", ""interface"": ""GE3""}","N/A",,202061999,medium,"3164d89b-aa18-4ba4-aaba-6a9e379aba0a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202061999 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Guarulhos,"INCOTEP IND E COM DE TUBOS ESPECIAIS DE PRECISÃO LTDA","173563.0000000",SP,"N/A","SDWAN - VELOCLOUD",202168682,FLEX,SDWAN,61931e45512a4e102e4413f5,"OPEN - GENERAL - V3",0,1637031316,"alert_manager","","",,"{""edgeId"": ""464"", ""linkId"": ""1584"", ""interface"": ""GE3""}","N/A",,202168682,high,"39148b34-d77e-404d-89a5-d9c9957b0123",464,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202168682 - Edge 464 entrou em status OFFLINE",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61931e47512a4e102e4413fa,"OPEN - GENERAL - V3",0,1637031316,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"f4b59b62-a64d-4be7-a276-d43cfa97ee10",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
